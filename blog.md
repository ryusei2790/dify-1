# Difyå®Œå…¨å†ç¾ãƒãƒ³ã‚ºã‚ªãƒ³ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ï¼šã‚¼ãƒ­ã‹ã‚‰LLMã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã‚’å®Ÿè£…ã™ã‚‹

## ç›®æ¬¡

### ç¬¬Iéƒ¨: åŸºç¤ç·¨
- [ç¬¬1ç« : ã¯ã˜ã‚ã«](#ç¬¬1ç« -ã¯ã˜ã‚ã«)
- [ç¬¬2ç« : ç’°å¢ƒæ§‹ç¯‰](#ç¬¬2ç« -ç’°å¢ƒæ§‹ç¯‰)

### ç¬¬IIéƒ¨: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å®Ÿè£…ç·¨
- ç¬¬3ç« : ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆã¨ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
- ç¬¬4ç« : ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰åŸºç›¤æ§‹ç¯‰
- ç¬¬5ç« : èªè¨¼ãƒ»èªå¯ã‚·ã‚¹ãƒ†ãƒ 
- ç¬¬6ç« : LLMãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼æŠ½è±¡åŒ–
- ç¬¬7ç« : CeleryéåŒæœŸã‚¿ã‚¹ã‚¯ã‚·ã‚¹ãƒ†ãƒ 

### ç¬¬IIIéƒ¨: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…ç·¨
- ç¬¬8ç« : ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰åŸºç›¤æ§‹ç¯‰
- ç¬¬9ç« : çŠ¶æ…‹ç®¡ç†ã¨APIçµ±åˆ
- ç¬¬10ç« : UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒª

### ç¬¬IVéƒ¨: ã‚³ã‚¢æ©Ÿèƒ½å®Ÿè£…ç·¨
- ç¬¬11ç« : ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚¨ãƒ‡ã‚£ã‚¿ã®å®Ÿè£…
- ç¬¬12ç« : ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œã‚¨ãƒ³ã‚¸ãƒ³
- ç¬¬13ç« : RAGãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å®Ÿè£…
- ç¬¬14ç« : çŸ¥è­˜ãƒ™ãƒ¼ã‚¹ç®¡ç†UI
- ç¬¬15ç« : ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆæ©Ÿèƒ½
- ç¬¬16ç« : ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚·ã‚¹ãƒ†ãƒ 

### ç¬¬Véƒ¨: å®Œæˆç·¨
- ç¬¬17ç« : ãƒ†ã‚¹ãƒˆå®Ÿè£…
- ç¬¬18ç« : DockeråŒ–ã¨ãƒ‡ãƒ—ãƒ­ã‚¤
- ç¬¬19ç« : å‹•ä½œç¢ºèªã¨æœ€çµ‚èª¿æ•´

### ä»˜éŒ²
- ã‚ˆãã‚ã‚‹è³ªå•
- ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚¬ã‚¤ãƒ‰
- å‚è€ƒãƒªã‚½ãƒ¼ã‚¹
- ç”¨èªé›†

---

# ç¬¬1ç« : ã¯ã˜ã‚ã«

## 1.1 ã“ã®ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã«ã¤ã„ã¦

æœ¬ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã¯ã€ã‚ªãƒ¼ãƒ—ãƒ³ã‚½ãƒ¼ã‚¹ã®LLMã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³é–‹ç™ºãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã€ŒDifyã€ã‚’ã€ã‚¼ãƒ­ã‹ã‚‰å®Œå…¨ã«å®Ÿè£…ã™ã‚‹ãŸã‚ã®åŒ…æ‹¬çš„ãªã‚¬ã‚¤ãƒ‰ã§ã™ã€‚å˜ã«Difyã‚’ä½¿ã†æ–¹æ³•ã§ã¯ãªãã€**Difyãã®ã‚‚ã®ã‚’ä½œã‚‹æ–¹æ³•**ã‚’å­¦ã³ã¾ã™ã€‚

### ãªãœDifyã‚’å†å®Ÿè£…ã™ã‚‹ã®ã‹?

LLMæŠ€è¡“ãŒæ€¥é€Ÿã«ç™ºå±•ã™ã‚‹ä¸­ã§ã€å®Ÿéš›ã®ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³å“è³ªã®LLMã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ§‹ç¯‰ã™ã‚‹ã«ã¯ã€è†¨å¤§ãªçŸ¥è­˜ã¨çµŒé¨“ãŒå¿…è¦ã§ã™ã€‚Difyã¯ãã®è¤‡é›‘ã•ã‚’è¦‹äº‹ã«æŠ½è±¡åŒ–ã—ã¦ã„ã¾ã™ãŒã€ã€Œã©ã®ã‚ˆã†ã«ã€å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ã‹ã‚’ç†è§£ã™ã‚‹ã“ã¨ã§ã€ä»¥ä¸‹ã®ãƒ¡ãƒªãƒƒãƒˆãŒã‚ã‚Šã¾ã™:

1. **ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®ç†è§£**: ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã€DDDã€Clean Architectureãªã©ã®å®Ÿè·µçš„ãªãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å­¦ã¹ã‚‹
2. **LLMçµ±åˆã®å®Ÿè£…**: 50ä»¥ä¸Šã®LLMãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã‚’çµ±åˆã™ã‚‹æ–¹æ³•ã‚’ç†è§£ã§ãã‚‹
3. **RAGã®å®Ÿè£…**: ãƒ™ã‚¯ãƒˆãƒ«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½¿ã£ãŸæ¤œç´¢æ‹¡å¼µç”Ÿæˆã®ä»•çµ„ã¿ã‚’å­¦ã¹ã‚‹
4. **ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚¨ãƒ³ã‚¸ãƒ³**: ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ãªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚¨ãƒ‡ã‚£ã‚¿ã¨ãã®å®Ÿè¡Œã‚¨ãƒ³ã‚¸ãƒ³ã®å®Ÿè£…ã‚’å­¦ã¹ã‚‹
5. **ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³å“è³ª**: ãƒ†ã‚¹ãƒˆã€ãƒ‡ãƒ—ãƒ­ã‚¤ã€ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ã¾ã§ã€å®Ÿéš›ã®é‹ç”¨ã«å¿…è¦ãªå…¨ã¦ã‚’ç¶²ç¾…

### å­¦ç¿’ã®é€²ã‚æ–¹

ã“ã®ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã¯ã€**æ®µéšçš„ãªå®Ÿè£…**ã‚’é‡è¦–ã—ã¦ã„ã¾ã™ã€‚å„ç« ã§ä»¥ä¸‹ã®æµã‚Œã§å­¦ç¿’ã—ã¾ã™:

```
1. æ¦‚å¿µã®èª¬æ˜
   â†“
2. Difyã§ã®å®Ÿè£…ã‚’ç¢ºèª
   â†“
3. å®Ÿéš›ã«ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã
   â†“
4. å‹•ä½œã‚’ç¢ºèªã™ã‚‹
```

å…¨19ç« ã‚’é€šã˜ã¦ã€å®Œå…¨ã«å‹•ä½œã™ã‚‹Difyã‚¯ãƒ­ãƒ¼ãƒ³ã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚

## 1.2 Difyã¨ã¯ä½•ã‹

### Difyã®æ¦‚è¦

Difyï¼ˆãƒ‡ã‚£ãƒ•ã‚¡ã‚¤ï¼‰ã¯ã€LLMï¼ˆLarge Language Modelï¼‰ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é–‹ç™ºã™ã‚‹ãŸã‚ã®ã‚ªãƒ¼ãƒ—ãƒ³ã‚½ãƒ¼ã‚¹ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã§ã™ã€‚2023å¹´ã«å…¬é–‹ã•ã‚Œã€ç¾åœ¨ã§ã¯ä»¥ä¸‹ã®ç‰¹å¾´ã‚’æŒã¤æˆç†Ÿã—ãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ãªã£ã¦ã„ã¾ã™:

**ä¸»è¦æ©Ÿèƒ½**:
- **ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ“ãƒ«ãƒ€ãƒ¼**: ãƒãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ã®UIã§AIãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’æ§‹ç¯‰
- **RAGãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³**: ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹åŒ–ã¨æ„å‘³æ¤œç´¢
- **ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ**: ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã§ãã‚‹AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å®Ÿè£…
- **ãƒãƒ«ãƒãƒ¢ãƒ‡ãƒ«å¯¾å¿œ**: 50ä»¥ä¸Šã®LLMãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã«å¯¾å¿œ
- **ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆ**: çµ„ç¹”ãƒ»ãƒãƒ¼ãƒ ã§ã®åˆ©ç”¨ã‚’æƒ³å®šã—ãŸè¨­è¨ˆ
- **APIæä¾›**: å…¨æ©Ÿèƒ½ã‚’APIã¨ã—ã¦æä¾›

**æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯**:
- ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰: Python (Flask), PostgreSQL, Redis, Celery
- ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰: Next.js 15, React 19, TypeScript
- ãƒ™ã‚¯ãƒˆãƒ«DB: Weaviateï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰ã€ä»–20ç¨®é¡ä»¥ä¸Šã«å¯¾å¿œ
- ã‚¤ãƒ³ãƒ•ãƒ©: Docker, Nginx

### ãªãœDifyã¯æ³¨ç›®ã•ã‚Œã¦ã„ã‚‹ã®ã‹

1. **ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³å“è³ª**: å˜ãªã‚‹ãƒ‡ãƒ¢ã§ã¯ãªãã€å®Ÿéš›ã®æ¥­å‹™ã§ä½¿ãˆã‚‹å“è³ª
2. **ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®å„ªã‚ŒãŸãƒ‡ã‚¶ã‚¤ãƒ³**: DDDã€Clean Architectureã€ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã®å®Ÿè·µä¾‹
3. **æ‹¡å¼µæ€§**: ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚·ã‚¹ãƒ†ãƒ ã«ã‚ˆã‚Šã€æ©Ÿèƒ½ã‚’è‡ªç”±ã«è¿½åŠ å¯èƒ½
4. **ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£**: æ´»ç™ºãªé–‹ç™ºã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã¨å……å®Ÿã—ãŸãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

GitHub Stars: 59,000ä»¥ä¸Šï¼ˆ2025å¹´1æœˆæ™‚ç‚¹ï¼‰

## 1.3 ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å…¨ä½“åƒ

Difyã¯ã€è¤‡æ•°ã®ã‚µãƒ¼ãƒ“ã‚¹ãŒé€£æºã™ã‚‹**ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£**ã‚’æ¡ç”¨ã—ã¦ã„ã¾ã™ã€‚å…¨ä½“åƒã‚’ç†è§£ã™ã‚‹ã“ã¨ã§ã€å„ç« ã§ã®å­¦ç¿’ãŒã‚¹ãƒ ãƒ¼ã‚ºã«ãªã‚Šã¾ã™ã€‚

### ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆå›³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ãƒ¦ãƒ¼ã‚¶ãƒ¼                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ HTTP/HTTPS
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Nginx (Port 80/443)                      â”‚
â”‚                 ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚· + SSLçµ‚ç«¯                    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                                               â”‚
       â”‚ /console/api/*, /api/*                       â”‚ /*
       â†“                                               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   API (Flask)       â”‚                    â”‚   Web (Next.js)  â”‚
â”‚   Port 5001         â”‚                    â”‚   Port 3000      â”‚
â”‚                     â”‚                    â”‚                  â”‚
â”‚ â”œâ”€ Controllers      â”‚                    â”‚ â”œâ”€ App Router    â”‚
â”‚ â”œâ”€ Services         â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”œâ”€ Components    â”‚
â”‚ â”œâ”€ Core Logic       â”‚     API Calls      â”‚ â””â”€ State Mgmt    â”‚
â”‚ â””â”€ Models           â”‚                    â”‚                  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚          â”‚          â”‚          â”‚
       â†“          â†“          â†“          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚PostgreSQLâ”‚ â”‚ Redis  â”‚ â”‚Weaviateâ”‚ â”‚ Worker   â”‚
â”‚  Port    â”‚ â”‚ Port   â”‚ â”‚ Port   â”‚ â”‚ (Celery) â”‚
â”‚  5432    â”‚ â”‚ 6379   â”‚ â”‚ 8080   â”‚ â”‚          â”‚
â”‚          â”‚ â”‚        â”‚ â”‚        â”‚ â”‚ â”œâ”€Queue  â”‚
â”‚  ãƒ¡ã‚¤ãƒ³  â”‚ â”‚ã‚­ãƒ£ãƒƒã‚·ãƒ¥â”‚ â”‚ãƒ™ã‚¯ãƒˆãƒ«â”‚ â”‚ â””â”€Tasks â”‚
â”‚  DB      â”‚ â”‚+ Brokerâ”‚ â”‚  DB    â”‚ â”‚          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ã‚µãƒ¼ãƒ“ã‚¹ã®å½¹å‰²

| ã‚µãƒ¼ãƒ“ã‚¹ | æŠ€è¡“ | å½¹å‰² | ãƒãƒ¼ãƒˆ |
|---------|------|------|--------|
| **nginx** | Nginx | ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·ã€SSLçµ‚ç«¯ã€é™çš„ãƒ•ã‚¡ã‚¤ãƒ«é…ä¿¡ | 80/443 |
| **api** | Flask + Gunicorn | RESTful APIã€ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ | 5001 |
| **web** | Next.js 15 | ç®¡ç†ç”»é¢UIã€React 19 | 3000 |
| **worker** | Celery | éåŒæœŸã‚¿ã‚¹ã‚¯å‡¦ç†ï¼ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ç­‰ï¼‰ | - |
| **worker_beat** | Celery Beat | å®šæœŸå®Ÿè¡Œã‚¿ã‚¹ã‚¯ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼ | - |
| **db_postgres** | PostgreSQL 15 | ãƒ¡ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ | 5432 |
| **redis** | Redis 6 | ã‚­ãƒ£ãƒƒã‚·ãƒ¥ + Celeryãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ–ãƒ­ãƒ¼ã‚«ãƒ¼ | 6379 |
| **weaviate** | Weaviate | ãƒ™ã‚¯ãƒˆãƒ«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼ˆRAGç”¨ï¼‰ | 8080 |
| **sandbox** | Docker in Docker | ã‚³ãƒ¼ãƒ‰å®Ÿè¡Œã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹ | 8194 |
| **ssrf_proxy** | Squid | SSRFæ”»æ’ƒé˜²æ­¢ãƒ—ãƒ­ã‚­ã‚· | 3128 |

### ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼

#### 1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¢ãƒ—ãƒªã‚’ä½œæˆã™ã‚‹å ´åˆ

```
User â†’ Nginx â†’ Web(Next.js) â†’ API(/console/api/apps)
                                  â†“
                            AppService.create_app()
                                  â†“
                            PostgreSQL (apps table)
```

#### 2. ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹åŒ–ã™ã‚‹å ´åˆ

```
User â†’ Nginx â†’ API(/datasets/{id}/documents)
                â†“
          DocumentService.create_document()
                â†“
          Redis Queue â†’ Celery Worker
                              â†“
                        1. ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆè§£æ
                        2. ãƒ†ã‚­ã‚¹ãƒˆæŠ½å‡º
                        3. ãƒãƒ£ãƒ³ã‚­ãƒ³ã‚°
                        4. åŸ‹ã‚è¾¼ã¿ç”Ÿæˆ (OpenAI API)
                        5. Weaviateã¸ä¿å­˜
```

#### 3. ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å®Ÿè¡Œã™ã‚‹å ´åˆ

```
User â†’ Nginx â†’ API(/workflows/{id}/run)
                â†“
          WorkflowRunner.run()
                â†“
          GraphEngine.execute()
                â†“
          å„ãƒãƒ¼ãƒ‰ã‚’é †æ¬¡å®Ÿè¡Œ:
            - LLMãƒãƒ¼ãƒ‰ â†’ OpenAI/Anthropic API
            - Toolãƒãƒ¼ãƒ‰ â†’ å¤–éƒ¨APIå‘¼ã³å‡ºã—
            - Knowledge Retrievalãƒãƒ¼ãƒ‰ â†’ Weaviateæ¤œç´¢
                â†“
          çµæœã‚’ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã§è¿”å´
```

### ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

Difyã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¯ã€**Domain-Driven Design (DDD)** ã¨ **Clean Architecture** ã®åŸå‰‡ã«å¾“ã£ã¦ã„ã¾ã™:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Presentation Layer                     â”‚
â”‚                  (controllers/)                          â”‚
â”‚  â”œâ”€ console/ (ç®¡ç†ç”»é¢API)                               â”‚
â”‚  â”œâ”€ service_api/ (ã‚µãƒ¼ãƒ“ã‚¹API)                           â”‚
â”‚  â””â”€ web/ (WebApp API)                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Application Layer                       â”‚
â”‚                   (services/)                            â”‚
â”‚  ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã®ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³                    â”‚
â”‚  â”œâ”€ AppService                                          â”‚
â”‚  â”œâ”€ DatasetService                                      â”‚
â”‚  â”œâ”€ WorkflowService                                     â”‚
â”‚  â””â”€ AccountService                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Domain Layer                          â”‚
â”‚                    (core/)                               â”‚
â”‚  ã‚³ã‚¢ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯                                      â”‚
â”‚  â”œâ”€ workflow/ (ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚¨ãƒ³ã‚¸ãƒ³)                      â”‚
â”‚  â”œâ”€ rag/ (RAGå®Ÿè£…)                                      â”‚
â”‚  â”œâ”€ agent/ (ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ)                                â”‚
â”‚  â”œâ”€ model_runtime/ (LLMæŠ½è±¡åŒ–)                          â”‚
â”‚  â””â”€ entities/ (ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                Infrastructure Layer                      â”‚
â”‚            (models/, extensions/, tasks/)                â”‚
â”‚  â”œâ”€ models/ (SQLAlchemyãƒ¢ãƒ‡ãƒ«)                          â”‚
â”‚  â”œâ”€ repositories/ (ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹)                        â”‚
â”‚  â”œâ”€ extensions/ (ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã€Redisã€Celeryç­‰)           â”‚
â”‚  â””â”€ tasks/ (Celeryã‚¿ã‚¹ã‚¯)                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¾å­˜é–¢ä¿‚ã®æ–¹å‘**: å¤–å´ã‹ã‚‰å†…å´ã¸ï¼ˆDependency Inversion Principleï¼‰

### ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

Next.js 15ã®**App Router**ã‚’ä½¿ç”¨ã—ãŸæœ€æ–°ã®Reactã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã™:

```
web/
â”œâ”€â”€ app/                      # Next.js App Router
â”‚   â”œâ”€â”€ (commonLayout)/       # ç®¡ç†ç”»é¢ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
â”‚   â”‚   â”œâ”€â”€ apps/            # ã‚¢ãƒ—ãƒªä¸€è¦§
â”‚   â”‚   â”œâ”€â”€ datasets/        # ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆç®¡ç†
â”‚   â”‚   â”œâ”€â”€ tools/           # ãƒ„ãƒ¼ãƒ«ç®¡ç†
â”‚   â”‚   â””â”€â”€ plugins/         # ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ç®¡ç†
â”‚   â”œâ”€â”€ (shareLayout)/        # å…¬é–‹ã‚¢ãƒ—ãƒªãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
â”‚   â”‚   â”œâ”€â”€ chat/            # ãƒãƒ£ãƒƒãƒˆã‚¢ãƒ—ãƒª
â”‚   â”‚   â””â”€â”€ workflow/        # ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œ
â”‚   â””â”€â”€ components/          # å…±é€šã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
â”‚       â”œâ”€â”€ workflow/        # ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚¨ãƒ‡ã‚£ã‚¿ (ReactFlow)
â”‚       â”œâ”€â”€ base/            # UIãƒ™ãƒ¼ã‚¹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
â”‚       â””â”€â”€ rag-pipeline/    # RAGãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³UI
â”œâ”€â”€ service/                  # API ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
â”‚   â”œâ”€â”€ base.ts              # HTTP ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ (ky)
â”‚   â”œâ”€â”€ apps.ts              # ã‚¢ãƒ—ãƒªAPI
â”‚   â””â”€â”€ datasets.ts          # ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆAPI
â”œâ”€â”€ context/                  # React Context (ã‚°ãƒ­ãƒ¼ãƒãƒ«çŠ¶æ…‹)
â”‚   â”œâ”€â”€ modal-context.tsx    # ãƒ¢ãƒ¼ãƒ€ãƒ«ç®¡ç†
â”‚   â””â”€â”€ app-context.tsx      # ã‚¢ãƒ—ãƒªçŠ¶æ…‹
â””â”€â”€ hooks/                    # ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯
    â””â”€â”€ use-workflow.ts      # ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ç”¨ãƒ•ãƒƒã‚¯
```

**çŠ¶æ…‹ç®¡ç†**:
- **Zustand**: ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚¨ãƒ‡ã‚£ã‚¿ã®è¤‡é›‘ãªçŠ¶æ…‹ç®¡ç†
- **TanStack Query**: ã‚µãƒ¼ãƒãƒ¼çŠ¶æ…‹ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¨åŒæœŸ
- **React Context**: ã‚°ãƒ­ãƒ¼ãƒãƒ«è¨­å®šã¨ãƒ¢ãƒ¼ãƒ€ãƒ«ç®¡ç†

## 1.4 å­¦ç¿’ã™ã‚‹å†…å®¹ã®æ¦‚è¦

ã“ã®ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã§å®Ÿè£…ã™ã‚‹ä¸»è¦æ©Ÿèƒ½:

### ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ (ç¬¬3-7ç« )

1. **ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ** (ç¬¬3ç« )
   - Account, Tenant, App, Workflow, Dataset ãƒ¢ãƒ‡ãƒ«
   - SQLAlchemy 2.0 + Alembicãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
   - ãƒ­ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ï¼ˆRBACï¼‰

2. **Flask ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åŸºç›¤** (ç¬¬4ç« )
   - DDDå±¤ã®å®Ÿè£…
   - Pydanticè¨­å®šç®¡ç†
   - ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã¨ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³

3. **JWTèªè¨¼ã‚·ã‚¹ãƒ†ãƒ ** (ç¬¬5ç« )
   - ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç™»éŒ²ãƒ»ãƒ­ã‚°ã‚¤ãƒ³
   - JWTãƒˆãƒ¼ã‚¯ãƒ³ç™ºè¡Œã¨æ¤œè¨¼
   - ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆåˆ†é›¢

4. **LLMãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼æŠ½è±¡åŒ–** (ç¬¬6ç« )
   - ModelManagerå®Ÿè£…
   - OpenAI, Anthropicçµ±åˆ
   - ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å¯¾å¿œ
   - ãƒˆãƒ¼ã‚¯ãƒ³ã‚«ã‚¦ãƒ³ãƒˆã¨ã‚³ã‚¹ãƒˆè¨ˆç®—

5. **CeleryéåŒæœŸã‚·ã‚¹ãƒ†ãƒ ** (ç¬¬7ç« )
   - Redisãƒ–ãƒ­ãƒ¼ã‚«ãƒ¼è¨­å®š
   - ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚¿ã‚¹ã‚¯
   - å®šæœŸå®Ÿè¡Œã‚¿ã‚¹ã‚¯ï¼ˆBeatï¼‰

### ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ (ç¬¬8-10ç« )

1. **Next.js 15ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ** (ç¬¬8ç« )
   - App Routerè¨­å®š
   - TypeScript + Tailwind CSS
   - ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 

2. **çŠ¶æ…‹ç®¡ç†ã¨APIçµ±åˆ** (ç¬¬9ç« )
   - Zustand ã‚¹ãƒˆã‚¢å®Ÿè£…
   - TanStack Query (React Query) ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
   - kyã‚’ä½¿ã£ãŸHTTPã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
   - SSE (Server-Sent Events) ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°

3. **UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒª** (ç¬¬10ç« )
   - ãƒ™ãƒ¼ã‚¹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆï¼ˆButton, Input, Modalç­‰ï¼‰
   - Tailwind CSSã‚«ã‚¹ã‚¿ãƒã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³
   - ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰å¯¾å¿œ
   - i18nï¼ˆreact-i18nextï¼‰

### ã‚³ã‚¢æ©Ÿèƒ½ (ç¬¬11-16ç« )

1. **ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚¨ãƒ‡ã‚£ã‚¿** (ç¬¬11ç« )
   - ReactFlowã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
   - ã‚«ã‚¹ã‚¿ãƒ ãƒãƒ¼ãƒ‰å®Ÿè£…ï¼ˆLLM, Knowledge Retrieval, Toolç­‰ï¼‰
   - ãƒãƒ¼ãƒ‰é–“ã®æ¥ç¶šã¨ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
   - ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«

2. **ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œã‚¨ãƒ³ã‚¸ãƒ³** (ç¬¬12ç« )
   - GraphEngineå®Ÿè£…
   - ãƒãƒ¼ãƒ‰å®Ÿè¡Œãƒ­ã‚¸ãƒƒã‚¯
   - å¤‰æ•°ç®¡ç†ã¨ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼
   - ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã¨ãƒªãƒˆãƒ©ã‚¤
   - ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å®Ÿè¡Œ

3. **RAGãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³** (ç¬¬13ç« )
   - Weaviateçµ±åˆ
   - ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå‡¦ç†ï¼ˆãƒ‘ãƒ¼ã‚¹ã€ãƒãƒ£ãƒ³ã‚­ãƒ³ã‚°ã€åŸ‹ã‚è¾¼ã¿ï¼‰
   - ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢
   - ãƒªãƒ©ãƒ³ã‚­ãƒ³ã‚°

4. **çŸ¥è­˜ãƒ™ãƒ¼ã‚¹ç®¡ç†UI** (ç¬¬14ç« )
   - ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆç®¡ç†ç”»é¢
   - ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ€ãƒ¼
   - ãƒãƒ£ãƒ³ã‚­ãƒ³ã‚°è¨­å®šUI
   - æ¤œç´¢ãƒ†ã‚¹ãƒˆæ©Ÿèƒ½

5. **ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆæ©Ÿèƒ½** (ç¬¬15ç« )
   - ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒãƒ¼ãƒ‰å®Ÿè£…
   - ãƒ„ãƒ¼ãƒ«çµ±åˆ
   - Function Calling vs ReAct
   - ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³åˆ¶å¾¡

6. **ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚·ã‚¹ãƒ†ãƒ ** (ç¬¬16ç« )
   - ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£
   - ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆè¨­è¨ˆ
   - ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
   - UIçµ±åˆ

### å®Œæˆ (ç¬¬17-19ç« )

1. **ãƒ†ã‚¹ãƒˆ** (ç¬¬17ç« )
   - pytestã«ã‚ˆã‚‹ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆ
   - Jest + React Testing Libraryã«ã‚ˆã‚‹ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆ

2. **DockeråŒ–ã¨ãƒ‡ãƒ—ãƒ­ã‚¤** (ç¬¬18ç« )
   - Dockerfileä½œæˆ
   - docker-compose.ymlè¨­å®š
   - Nginxè¨­å®š
   - ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³æœ€é©åŒ–

3. **å‹•ä½œç¢ºèª** (ç¬¬19ç« )
   - ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ‰‹é †
   - å„æ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆ
   - ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

## 1.5 å‰æçŸ¥è­˜ã¨å¿…è¦ãªãƒ„ãƒ¼ãƒ«

### å‰æçŸ¥è­˜

ã“ã®ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã‚’æœ€å¤§é™æ´»ç”¨ã™ã‚‹ãŸã‚ã«ã€ä»¥ä¸‹ã®çŸ¥è­˜ãŒã‚ã‚‹ã“ã¨ãŒæœ›ã¾ã—ã„ã§ã™:

**å¿…é ˆ**:
- Python ã®åŸºç¤ï¼ˆé–¢æ•°ã€ã‚¯ãƒ©ã‚¹ã€ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ï¼‰
- JavaScriptã®åŸºç¤ï¼ˆéåŒæœŸå‡¦ç†ã€ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼‰
- HTMLã¨CSSã®åŸºç¤
- Gitã®åŸºæœ¬æ“ä½œ
- ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã®åŸºæœ¬æ“ä½œ

**æ¨å¥¨**:
- Flaskã®åŸºæœ¬ï¼ˆãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆå‡¦ç†ï¼‰
- Reactã®åŸºæœ¬ï¼ˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã€ãƒ•ãƒƒã‚¯ï¼‰
- SQLã®åŸºç¤ï¼ˆSELECT, INSERT, UPDATE, DELETEï¼‰
- Dockerã®åŸºæœ¬æ¦‚å¿µ

**å­¦ç¿’ã—ãªãŒã‚‰ç†è§£ã§ãã‚‹å†…å®¹** (æœ¬ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã§èª¬æ˜):
- Domain-Driven Design (DDD)
- Clean Architecture
- SQLAlchemy ORM
- Next.js App Router
- ZustandçŠ¶æ…‹ç®¡ç†
- ReactFlow
- Celeryã‚¿ã‚¹ã‚¯ã‚­ãƒ¥ãƒ¼
- ãƒ™ã‚¯ãƒˆãƒ«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹

### å¿…è¦ãªãƒ„ãƒ¼ãƒ«

é–‹ç™ºç’°å¢ƒã¨ã—ã¦ã€ä»¥ä¸‹ã®ãƒ„ãƒ¼ãƒ«ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™:

#### 1. åŸºæœ¬ãƒ„ãƒ¼ãƒ«

| ãƒ„ãƒ¼ãƒ« | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | èª¬æ˜ |
|--------|----------|------|
| Git | æœ€æ–°ç‰ˆ | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç† |
| Docker Desktop | 24.xä»¥ä¸Š | ã‚³ãƒ³ãƒ†ãƒŠå®Ÿè¡Œç’°å¢ƒ |
| VS Code | æœ€æ–°ç‰ˆ | ã‚¨ãƒ‡ã‚£ã‚¿ï¼ˆæ¨å¥¨ï¼‰ |

#### 2. Pythonç’°å¢ƒ

| ãƒ„ãƒ¼ãƒ« | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | èª¬æ˜ |
|--------|----------|------|
| Python | 3.11 - 3.12 | Dify ã¯Python 3.13éå¯¾å¿œ |
| uv | æœ€æ–°ç‰ˆ | é«˜é€Ÿãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ |

**uv ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«**:
```bash
# macOS / Linux
curl -LsSf https://astral.sh/uv/install.sh | sh

# Windows (PowerShell)
powershell -c "irm https://astral.sh/uv/install.ps1 | iex"

# pipã‚’ä½¿ã†å ´åˆ
pip install uv
```

#### 3. Node.jsç’°å¢ƒ

| ãƒ„ãƒ¼ãƒ« | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | èª¬æ˜ |
|--------|----------|------|
| Node.js | >= 22.11.0 | JavaScriptå®Ÿè¡Œç’°å¢ƒ |
| pnpm | 10.23.0 | é«˜é€Ÿãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ |

**ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«**:
```bash
# Node.jsã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« (nvmæ¨å¥¨)
nvm install 22
nvm use 22

# pnpmã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
npm install -g pnpm@10.23.0
```

#### 4. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼ˆé–‹ç™ºç”¨ï¼‰

Docker Composeã§è‡ªå‹•èµ·å‹•ã™ã‚‹ãŸã‚ã€å€‹åˆ¥ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¯ä¸è¦ã§ã™ãŒã€ãƒ­ãƒ¼ã‚«ãƒ«ã§ç›´æ¥å®Ÿè¡Œã—ãŸã„å ´åˆ:

| ãƒ„ãƒ¼ãƒ« | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | ç”¨é€” |
|--------|----------|------|
| PostgreSQL | 15.x | ãƒ¡ã‚¤ãƒ³DB |
| Redis | 6.x | ã‚­ãƒ£ãƒƒã‚·ãƒ¥+Broker |
| Weaviate | 1.x | ãƒ™ã‚¯ãƒˆãƒ«DB |

#### 5. ã‚¨ãƒ‡ã‚£ã‚¿ã®æ¨å¥¨è¨­å®š (VS Code)

ä»¥ä¸‹ã®æ‹¡å¼µæ©Ÿèƒ½ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã“ã¨ã‚’æ¨å¥¨ã—ã¾ã™:

```json
{
  "recommendations": [
    "ms-python.python",
    "ms-python.vscode-pylance",
    "charliermarsh.ruff",
    "dbaeumer.vscode-eslint",
    "esbenp.prettier-vscode",
    "bradlc.vscode-tailwindcss",
    "ms-azuretools.vscode-docker"
  ]
}
```

### é–‹ç™ºãƒã‚·ãƒ³ã®ã‚¹ãƒšãƒƒã‚¯

æ¨å¥¨ã‚¹ãƒšãƒƒã‚¯:
- **CPU**: 4ã‚³ã‚¢ä»¥ä¸Šï¼ˆIntel i5 / AMD Ryzen 5ä»¥ä¸Šï¼‰
- **ãƒ¡ãƒ¢ãƒª**: 16GBä»¥ä¸Šï¼ˆæœ€ä½8GBï¼‰
- **ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸**: 30GBä»¥ä¸Šã®ç©ºãå®¹é‡ï¼ˆSSDæ¨å¥¨ï¼‰
- **OS**: macOS, Linux, Windows 10/11 (WSL2æ¨å¥¨)

### å­¦ç¿’æ™‚é–“ã®ç›®å®‰

- **ç¬¬1-2ç« ** (åŸºç¤ç·¨): 2-3æ™‚é–“
- **ç¬¬3-7ç« ** (ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰): 15-20æ™‚é–“
- **ç¬¬8-10ç« ** (ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰): 10-15æ™‚é–“
- **ç¬¬11-16ç« ** (ã‚³ã‚¢æ©Ÿèƒ½): 25-30æ™‚é–“
- **ç¬¬17-19ç« ** (å®Œæˆ): 5-10æ™‚é–“

**åˆè¨ˆ**: 60-80æ™‚é–“ç¨‹åº¦

é€±æœ«ã‚’ä½¿ã£ã¦ã€2-3ãƒ¶æœˆã§å®Œèµ°ã™ã‚‹ã“ã¨ã‚’æƒ³å®šã—ã¦ã„ã¾ã™ã€‚

## 1.6 æœ¬ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã®ä½¿ã„æ–¹

### æ¨å¥¨å­¦ç¿’ãƒ•ãƒ­ãƒ¼

```
1. å„ç« ã‚’é †ç•ªã«èª­ã‚€
   â†“
2. æ¦‚å¿µã‚’ç†è§£ã™ã‚‹ï¼ˆå¿…è¦ã«å¿œã˜ã¦è¿½åŠ è³‡æ–™ã‚’å‚ç…§ï¼‰
   â†“
3. ã‚³ãƒ¼ãƒ‰ã‚’å†™çµŒã™ã‚‹ï¼ˆã‚³ãƒ”ãƒšã§ã¯ãªãã€æ‰‹ã§æ‰“ã¤ï¼‰
   â†“
4. å‹•ä½œç¢ºèªã™ã‚‹
   â†“
5. Difyã®å®Ÿè£…ã¨æ¯”è¼ƒã™ã‚‹ï¼ˆå‚ç…§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèªï¼‰
   â†“
6. ç–‘å•ç‚¹ã‚’ãƒ¡ãƒ¢ã—ã¦èª¿ã¹ã‚‹
```

### ã‚³ãƒ¼ãƒ‰ã‚¹ãƒ‹ãƒšãƒƒãƒˆã®èª­ã¿æ–¹

æœ¬ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã§ã¯ã€å®Ÿè£…ã‚³ãƒ¼ãƒ‰ã‚’ä»¥ä¸‹ã®å½¢å¼ã§æä¾›ã—ã¾ã™:

```python
# ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹: api/models/account.py
# Difyã®å®Ÿè£…: https://github.com/langgenius/dify/blob/main/api/models/account.py

from sqlalchemy.orm import Mapped, mapped_column
from sqlalchemy import String
import enum

class TenantAccountRole(enum.StrEnum):
    """ãƒ†ãƒŠãƒ³ãƒˆå†…ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«"""
    OWNER = "owner"          # ã‚ªãƒ¼ãƒŠãƒ¼ï¼ˆå…¨æ¨©é™ï¼‰
    ADMIN = "admin"          # ç®¡ç†è€…
    EDITOR = "editor"        # ç·¨é›†è€…
    NORMAL = "normal"        # ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼
    DATASET_OPERATOR = "dataset_operator"  # ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆç®¡ç†è€…

class Account(TypeBase):
    """ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ¢ãƒ‡ãƒ«"""
    __tablename__ = "accounts"

    id: Mapped[str] = mapped_column(StringUUID, default=lambda: str(uuid4()))
    name: Mapped[str] = mapped_column(String(255))
    email: Mapped[str] = mapped_column(String(255))
    password: Mapped[str | None] = mapped_column(String(255), default=None)
```

- **ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹**: å®Ÿéš›ã«ä½œæˆã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã®å ´æ‰€
- **Difyã®å®Ÿè£…**: å…ƒã®Difyã‚³ãƒ¼ãƒ‰ã¸ã®ãƒªãƒ³ã‚¯ï¼ˆå‚ç…§ç”¨ï¼‰
- **ã‚³ãƒ¡ãƒ³ãƒˆ**: é‡è¦ãªéƒ¨åˆ†ã®èª¬æ˜

### èº“ã„ãŸã¨ãã®å¯¾å‡¦æ³•

1. **ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’èª­ã‚€**: å¤šãã®å ´åˆã€ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«è§£æ±ºã®ãƒ’ãƒ³ãƒˆãŒã‚ã‚Šã¾ã™
2. **ãƒ­ã‚°ã‚’ç¢ºèªã™ã‚‹**: `docker compose logs ã‚µãƒ¼ãƒ“ã‚¹å` ã§è©³ç´°ãƒ­ã‚°ã‚’ç¢ºèª
3. **Difyã®å®Ÿè£…ã‚’ç¢ºèª**: å‚ç…§ãƒªãƒ³ã‚¯ã‹ã‚‰å…ƒã®ã‚³ãƒ¼ãƒ‰ã‚’è¦‹ã‚‹
4. **ä»˜éŒ²ã®ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°**: ã‚ˆãã‚ã‚‹å•é¡Œã¨è§£æ±ºæ³•ã‚’ã¾ã¨ã‚ã¦ã„ã¾ã™
5. **ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã«è³ªå•**: GitHub Discussionsã‚„Discordã§è³ªå•

### ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã®ãƒªãƒã‚¸ãƒˆãƒª

æœ¬ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã®å®Œå…¨ãªã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã¯ã€ä»¥ä¸‹ã®ãƒªãƒã‚¸ãƒˆãƒªã§å…¬é–‹äºˆå®šã§ã™:

```
https://github.com/your-org/dify-tutorial
```

å„ç« ã”ã¨ã«ãƒ–ãƒ©ãƒ³ãƒãŒã‚ã‚Šã€æ®µéšçš„ã«ç¢ºèªã§ãã¾ã™:
- `chapter-03` - ç¬¬3ç« ã®ã‚³ãƒ¼ãƒ‰
- `chapter-04` - ç¬¬4ç« ã®ã‚³ãƒ¼ãƒ‰
- ...

---

# ç¬¬2ç« : ç’°å¢ƒæ§‹ç¯‰

ã“ã®ç« ã§ã¯ã€Difyã‚’é–‹ç™ºã™ã‚‹ãŸã‚ã®ç’°å¢ƒã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚Dockerç’°å¢ƒã€Pythonç’°å¢ƒã€Node.jsç’°å¢ƒã€ãã—ã¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ ã‚’æ•´ãˆã¦ã„ãã¾ã™ã€‚

## 2.1 é–‹ç™ºç’°å¢ƒã®å…¨ä½“åƒ

æ§‹ç¯‰ã™ã‚‹ç’°å¢ƒã®å…¨ä½“åƒ:

```
é–‹ç™ºãƒã‚·ãƒ³
â”œâ”€â”€ Docker Desktop (ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢å®Ÿè¡Œ)
â”‚   â”œâ”€â”€ PostgreSQL (DB)
â”‚   â”œâ”€â”€ Redis (ã‚­ãƒ£ãƒƒã‚·ãƒ¥ + Broker)
â”‚   â””â”€â”€ Weaviate (ãƒ™ã‚¯ãƒˆãƒ«DB)
â”œâ”€â”€ Python 3.11+ (ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰é–‹ç™º)
â”‚   â””â”€â”€ uv (ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ç®¡ç†)
â””â”€â”€ Node.js 22+ (ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰é–‹ç™º)
    â””â”€â”€ pnpm 10 (ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ç®¡ç†)
```

**é–‹ç™ºãƒ•ãƒ­ãƒ¼**:
- Docker: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç­‰ã®ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã‚’èµ·å‹•
- ã‚¿ãƒ¼ãƒŸãƒŠãƒ«1: Flaské–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ï¼ˆãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰ï¼‰
- ã‚¿ãƒ¼ãƒŸãƒŠãƒ«2: Next.jsé–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ï¼ˆãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰ï¼‰
- ã‚¿ãƒ¼ãƒŸãƒŠãƒ«3: Celery Workerã‚’èµ·å‹•ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰

## 2.2 Docker Desktopã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

### ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

å…¬å¼ã‚µã‚¤ãƒˆã‹ã‚‰Docker Desktopã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™:

**macOS**:
```bash
# Homebrewã‚’ä½¿ã†å ´åˆ
brew install --cask docker

# ã¾ãŸã¯å…¬å¼ã‚µã‚¤ãƒˆã‹ã‚‰: https://www.docker.com/products/docker-desktop
```

**Windows**:
1. https://www.docker.com/products/docker-desktop ã‹ã‚‰ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ©ãƒ¼ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
2. WSL2ãŒå¿…è¦ãªå ´åˆã¯ã€äº‹å‰ã«ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
3. ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ©ãƒ¼ã‚’å®Ÿè¡Œ

**Linux**:
```bash
# Ubuntu/Debian
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh
sudo usermod -aG docker $USER
```

### å‹•ä½œç¢ºèª

```bash
# Dockerã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèª
docker --version
# æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›: Docker version 24.x.x

# Docker Composeã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèª
docker compose version
# æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›: Docker Compose version v2.x.x

# DockerãŒå‹•ä½œã—ã¦ã„ã‚‹ã‹ç¢ºèª
docker ps
# ã‚¨ãƒ©ãƒ¼ãŒå‡ºãªã‘ã‚Œã°OK
```

### Docker Desktopã®æ¨å¥¨è¨­å®š

Docker Desktop ã‚’é–‹ãã€Settingsï¼ˆæ­¯è»Šã‚¢ã‚¤ã‚³ãƒ³ï¼‰ã‹ã‚‰ä»¥ä¸‹ã‚’è¨­å®š:

**Resources > Advanced**:
- **CPUs**: 4ä»¥ä¸Š
- **Memory**: 8 GBä»¥ä¸Šï¼ˆæ¨å¥¨: 12GBï¼‰
- **Swap**: 2 GB
- **Disk image size**: 60 GBä»¥ä¸Š

ã“ã‚Œã‚‰ã®ãƒªã‚½ãƒ¼ã‚¹ã¯ã€PostgreSQL, Redis, Weaviate, Celery Workerã‚’åŒæ™‚ã«å®Ÿè¡Œã™ã‚‹ãŸã‚ã«å¿…è¦ã§ã™ã€‚

## 2.3 Pythonç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

### Python 3.11/3.12ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

Difyã¯**Python 3.11ã¾ãŸã¯3.12**ãŒå¿…è¦ã§ã™ï¼ˆ3.13ã¯æœªå¯¾å¿œï¼‰ã€‚

**pyenvã‚’ä½¿ã†æ–¹æ³•ï¼ˆæ¨å¥¨ï¼‰**:

```bash
# pyenvã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« (macOS/Linux)
curl https://pyenv.run | bash

# pyenvã®PATHè¨­å®š (~/.bashrc ã¾ãŸã¯ ~/.zshrc ã«è¿½åŠ )
export PATH="$HOME/.pyenv/bin:$PATH"
eval "$(pyenv init -)"
eval "$(pyenv virtualenv-init -)"

# ã‚·ã‚§ãƒ«ã‚’å†èµ·å‹•
exec $SHELL

# Python 3.12ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
pyenv install 3.12.0
pyenv global 3.12.0

# ç¢ºèª
python --version
# Python 3.12.0
```

**ã‚·ã‚¹ãƒ†ãƒ Pythonã‚’ä½¿ã†å ´åˆ**:
```bash
# macOS (Homebrew)
brew install python@3.12

# Ubuntu/Debian
sudo apt update
sudo apt install python3.12 python3.12-venv

# ç¢ºèª
python3.12 --version
```

### uvã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

uvã¯ã€AstralãŒé–‹ç™ºã—ãŸé«˜é€ŸãªPythonãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã§ã™ã€‚Difyã¯v1.3.0ã‹ã‚‰Poetryã‹ã‚‰uvã«ç§»è¡Œã—ã¾ã—ãŸã€‚

```bash
# macOS/Linux
curl -LsSf https://astral.sh/uv/install.sh | sh

# Windows (PowerShell)
powershell -c "irm https://astral.sh/uv/install.ps1 | iex"

# ã¾ãŸã¯ã€pipã‚’ä½¿ã†å ´åˆ
pip install uv

# ç¢ºèª
uv --version
# uv x.x.x
```

### uvã®åŸºæœ¬çš„ãªä½¿ã„æ–¹

```bash
# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
uv sync

# é–‹ç™ºç”¨ã®ä¾å­˜é–¢ä¿‚ã‚‚å«ã‚ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
uv sync --dev

# ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’è¿½åŠ 
uv add requests

# ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’å‰Šé™¤
uv remove requests

# ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œ
uv run python script.py

# Flaskã‚¢ãƒ—ãƒªã‚’å®Ÿè¡Œ
uv run flask run
```

## 2.4 Node.jsç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

### Node.js 22ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

Difyã®ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¯**Node.js >= 22.11.0**ãŒå¿…è¦ã§ã™ã€‚

**nvmã‚’ä½¿ã†æ–¹æ³•ï¼ˆæ¨å¥¨ï¼‰**:

```bash
# nvmã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« (macOS/Linux)
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash

# ã‚·ã‚§ãƒ«ã‚’å†èµ·å‹•
exec $SHELL

# Node.js 22ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
nvm install 22
nvm use 22
nvm alias default 22

# ç¢ºèª
node --version
# v22.11.0 ã¾ãŸã¯ãã‚Œä»¥ä¸Š
```

**ç›´æ¥ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹å ´åˆ**:

```bash
# macOS (Homebrew)
brew install node@22

# Ubuntu/Debian
curl -fsSL https://deb.nodesource.com/setup_22.x | sudo -E bash -
sudo apt-get install -y nodejs

# ç¢ºèª
node --version
```

### pnpmã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

Difyã¯**pnpm 10.23.0**ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

```bash
# npmã‚’ä½¿ã£ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
npm install -g pnpm@10.23.0

# ç¢ºèª
pnpm --version
# 10.23.0
```

**pnpmã®åŸºæœ¬çš„ãªä½¿ã„æ–¹**:

```bash
# ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
pnpm install

# ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’è¿½åŠ 
pnpm add react

# é–‹ç™ºç”¨ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’è¿½åŠ 
pnpm add -D typescript

# ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œ
pnpm run dev
```

## 2.5 ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ ã®ä½œæˆ

ãã‚Œã§ã¯ã€Difyãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ã‚’ä½œæˆã—ã¦ã„ãã¾ã™ã€‚

### ãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä½œæˆ

```bash
# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
mkdir dify-clone
cd dify-clone

# Gitãƒªãƒã‚¸ãƒˆãƒªã‚’åˆæœŸåŒ–
git init

# .gitignoreã‚’ä½œæˆ
cat > .gitignore << 'EOF'
# Python
__pycache__/
*.py[cod]
*$py.class
*.so
.Python
env/
venv/
.venv/
*.egg-info/
dist/
build/

# Node.js
node_modules/
.next/
out/
.pnpm-debug.log*

# Environment files
.env
.env.local
.env.*.local

# IDEs
.vscode/
.idea/
*.swp
*.swo

# OS
.DS_Store
Thumbs.db

# Docker
docker/volumes/

# Logs
*.log
EOF
```

### ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 

å®Œæˆå½¢ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ï¼ˆã“ã‚Œã‹ã‚‰æ®µéšçš„ã«ä½œæˆã—ã¦ã„ãã¾ã™ï¼‰:

```
dify-clone/
â”œâ”€â”€ api/                      # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ (Python Flask)
â”‚   â”œâ”€â”€ models/               # SQLAlchemyãƒ¢ãƒ‡ãƒ«
â”‚   â”œâ”€â”€ core/                 # ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯
â”‚   â”‚   â”œâ”€â”€ workflow/         # ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚¨ãƒ³ã‚¸ãƒ³
â”‚   â”‚   â”œâ”€â”€ rag/              # RAGå®Ÿè£…
â”‚   â”‚   â”œâ”€â”€ agent/            # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ
â”‚   â”‚   â””â”€â”€ model_runtime/    # LLMæŠ½è±¡åŒ–
â”‚   â”œâ”€â”€ services/             # ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚µãƒ¼ãƒ“ã‚¹
â”‚   â”œâ”€â”€ controllers/          # APIã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼
â”‚   â”‚   â”œâ”€â”€ console/          # ç®¡ç†ç”»é¢API
â”‚   â”‚   â”œâ”€â”€ service_api/      # ã‚µãƒ¼ãƒ“ã‚¹API
â”‚   â”‚   â””â”€â”€ web/              # WebApp API
â”‚   â”œâ”€â”€ repositories/         # ãƒªãƒã‚¸ãƒˆãƒªãƒ‘ã‚¿ãƒ¼ãƒ³
â”‚   â”œâ”€â”€ extensions/           # Flaskæ‹¡å¼µ
â”‚   â”œâ”€â”€ tasks/                # Celeryã‚¿ã‚¹ã‚¯
â”‚   â”œâ”€â”€ configs/              # è¨­å®š
â”‚   â”œâ”€â”€ migrations/           # Alembicãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
â”‚   â”œâ”€â”€ tests/                # ãƒ†ã‚¹ãƒˆ
â”‚   â”œâ”€â”€ app_factory.py        # Flaskã‚¢ãƒ—ãƒªãƒ•ã‚¡ã‚¯ãƒˆãƒªãƒ¼
â”‚   â”œâ”€â”€ app.py                # ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ
â”‚   â”œâ”€â”€ pyproject.toml        # uvè¨­å®š
â”‚   â””â”€â”€ .env.example          # ç’°å¢ƒå¤‰æ•°ã‚µãƒ³ãƒ—ãƒ«
â”œâ”€â”€ web/                      # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ (Next.js)
â”‚   â”œâ”€â”€ app/                  # Next.js App Router
â”‚   â”‚   â”œâ”€â”€ (commonLayout)/   # ç®¡ç†ç”»é¢
â”‚   â”‚   â”‚   â”œâ”€â”€ apps/
â”‚   â”‚   â”‚   â”œâ”€â”€ datasets/
â”‚   â”‚   â”‚   â””â”€â”€ ...
â”‚   â”‚   â”œâ”€â”€ (shareLayout)/    # å…¬é–‹ã‚¢ãƒ—ãƒª
â”‚   â”‚   â””â”€â”€ components/       # Reactã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
â”‚   â”‚       â”œâ”€â”€ workflow/     # ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚¨ãƒ‡ã‚£ã‚¿
â”‚   â”‚       â”œâ”€â”€ base/         # ãƒ™ãƒ¼ã‚¹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
â”‚   â”‚       â””â”€â”€ rag-pipeline/ # RAGãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³UI
â”‚   â”œâ”€â”€ service/              # APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
â”‚   â”œâ”€â”€ context/              # React Context
â”‚   â”œâ”€â”€ hooks/                # ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯
â”‚   â”œâ”€â”€ i18n/                 # å›½éš›åŒ–
â”‚   â”œâ”€â”€ types/                # TypeScriptå‹å®šç¾©
â”‚   â”œâ”€â”€ utils/                # ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
â”‚   â”œâ”€â”€ styles/               # ã‚¹ã‚¿ã‚¤ãƒ«
â”‚   â”œâ”€â”€ public/               # é™çš„ãƒ•ã‚¡ã‚¤ãƒ«
â”‚   â”œâ”€â”€ package.json          # pnpmè¨­å®š
â”‚   â”œâ”€â”€ tsconfig.json         # TypeScriptè¨­å®š
â”‚   â”œâ”€â”€ tailwind.config.js    # Tailwind CSSè¨­å®š
â”‚   â”œâ”€â”€ next.config.js        # Next.jsè¨­å®š
â”‚   â””â”€â”€ .env.example          # ç’°å¢ƒå¤‰æ•°ã‚µãƒ³ãƒ—ãƒ«
â”œâ”€â”€ docker/                   # Dockerè¨­å®š
â”‚   â”œâ”€â”€ docker-compose.yaml   # é–‹ç™ºç”¨Compose
â”‚   â”œâ”€â”€ docker-compose.middleware.yaml  # ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã®ã¿
â”‚   â”œâ”€â”€ .env.example          # Dockerç’°å¢ƒå¤‰æ•°
â”‚   â”œâ”€â”€ nginx/                # Nginxè¨­å®š
â”‚   â”‚   â””â”€â”€ nginx.conf
â”‚   â”œâ”€â”€ postgres/             # PostgreSQLåˆæœŸåŒ–
â”‚   â””â”€â”€ volumes/              # ãƒ‡ãƒ¼ã‚¿æ°¸ç¶šåŒ– (gitignore)
â”œâ”€â”€ scripts/                  # ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
â”œâ”€â”€ docs/                     # ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
â”œâ”€â”€ Makefile                  # ã‚¿ã‚¹ã‚¯è‡ªå‹•åŒ–
â”œâ”€â”€ README.md                 # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆèª¬æ˜
â””â”€â”€ .gitignore
```

### åŸºæœ¬ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä½œæˆ

```bash
# ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰
mkdir -p api/{models,core,services,controllers,repositories,extensions,tasks,configs,migrations,tests}
mkdir -p api/core/{workflow,rag,agent,model_runtime}
mkdir -p api/controllers/{console,service_api,web}

# ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰
mkdir -p web/{app,service,context,hooks,i18n,types,utils,styles,public}
mkdir -p web/app/{components,\(commonLayout\),\(shareLayout\)}
mkdir -p web/app/components/{workflow,base,rag-pipeline}

# Docker
mkdir -p docker/{nginx,postgres}

# ãã®ä»–
mkdir -p scripts docs
```

## 2.6 DockerãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

é–‹ç™ºç”¨ã®ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ï¼ˆPostgreSQL, Redis, Weaviateï¼‰ã‚’Dockerã§èµ·å‹•ã—ã¾ã™ã€‚

### docker-compose.middleware.yamlã®ä½œæˆ

```bash
cat > docker/docker-compose.middleware.yaml << 'EOF'
version: '3.8'

services:
  # PostgreSQL 15
  postgres:
    image: postgres:15-alpine
    container_name: dify-postgres
    restart: always
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: difyai123456
      POSTGRES_DB: dify
      PGDATA: /var/lib/postgresql/data/pgdata
    ports:
      - "5432:5432"
    volumes:
      - ./volumes/postgres/data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "postgres"]
      interval: 5s
      timeout: 5s
      retries: 5

  # Redis 6
  redis:
    image: redis:6-alpine
    container_name: dify-redis
    restart: always
    command: redis-server --requirepass difyai123456
    ports:
      - "6379:6379"
    volumes:
      - ./volumes/redis/data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5

  # Weaviate (ãƒ™ã‚¯ãƒˆãƒ«DB)
  weaviate:
    image: semitechnologies/weaviate:1.19.6
    container_name: dify-weaviate
    restart: always
    ports:
      - "8080:8080"
    environment:
      QUERY_DEFAULTS_LIMIT: 25
      AUTHENTICATION_ANONYMOUS_ACCESS_ENABLED: 'true'
      PERSISTENCE_DATA_PATH: '/var/lib/weaviate'
      DEFAULT_VECTORIZER_MODULE: 'none'
      CLUSTER_HOSTNAME: 'node1'
    volumes:
      - ./volumes/weaviate:/var/lib/weaviate
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/v1/.well-known/ready"]
      interval: 10s
      timeout: 5s
      retries: 5

networks:
  default:
    name: dify-network

volumes:
  postgres_data:
  redis_data:
  weaviate_data:
EOF
```

### ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã®èµ·å‹•

```bash
cd docker

# ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã‚’èµ·å‹•
docker compose -f docker-compose.middleware.yaml up -d

# èµ·å‹•ç¢ºèª
docker compose -f docker-compose.middleware.yaml ps

# æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›:
# NAME              IMAGE                           STATUS
# dify-postgres     postgres:15-alpine              Up (healthy)
# dify-redis        redis:6-alpine                  Up (healthy)
# dify-weaviate     semitechnologies/weaviate:1.19.6   Up (healthy)

# ãƒ­ã‚°ç¢ºèª
docker compose -f docker-compose.middleware.yaml logs -f
```

### æ¥ç¶šç¢ºèª

**PostgreSQL**:
```bash
# psqlã§æ¥ç¶š
docker exec -it dify-postgres psql -U postgres -d dify

# æ¥ç¶šã§ããŸã‚‰ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ãƒ†ã‚¹ãƒˆ
dify=# \l
dify=# \q
```

**Redis**:
```bash
# redis-cliã§æ¥ç¶š
docker exec -it dify-redis redis-cli -a difyai123456

# æ¥ç¶šã§ããŸã‚‰ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ãƒ†ã‚¹ãƒˆ
127.0.0.1:6379> PING
# PONG ãŒè¿”ã£ã¦ãã‚Œã°OK
127.0.0.1:6379> quit
```

**Weaviate**:
```bash
# curlã§æ¥ç¶šç¢ºèª
curl http://localhost:8080/v1/.well-known/ready

# {"data"} ãŒè¿”ã£ã¦ãã‚Œã°OK
```

## 2.7 ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®åˆæœŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

### pyproject.tomlã®ä½œæˆ

```bash
cd api

cat > pyproject.toml << 'EOF'
[project]
name = "dify-api"
version = "0.1.0"
requires-python = ">=3.11,<3.13"

dependencies = [
    "flask~=3.1.2",
    "flask-cors~=6.0.0",
    "flask-login~=0.6.3",
    "flask-migrate~=4.0.7",
    "flask-sqlalchemy~=3.1.1",
    "flask-restx~=1.3.0",
    "gunicorn~=23.0.0",
    "gevent~=25.9.1",
    "sqlalchemy~=2.0.29",
    "psycopg2-binary~=2.9.6",
    "redis[hiredis]~=6.1.0",
    "celery~=5.5.2",
    "pydantic~=2.11.4",
    "pydantic-settings~=2.11.0",
    "python-dotenv==1.0.1",
    "pyjwt~=2.10.1",
    "httpx~=0.27.0",
    "tiktoken~=0.9.0",
    "weaviate-client==4.17.0",
]

[tool.uv]
dev-dependencies = [
    "pytest~=8.0.0",
    "pytest-flask~=1.3.0",
    "pytest-mock~=3.12.0",
    "ruff~=0.8.0",
    "basedpyright~=1.25.0",
]

[tool.ruff]
line-length = 120
target-version = "py311"

[tool.ruff.lint]
select = ["E", "F", "W", "I", "N", "B", "A", "C4", "T20"]
ignore = ["E501"]

[tool.basedpyright]
typeCheckingMode = "basic"
pythonVersion = "3.11"
EOF
```

### ç’°å¢ƒå¤‰æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ

```bash
cat > .env.example << 'EOF'
# Flask
FLASK_APP=app.py
FLASK_DEBUG=true
SECRET_KEY=your-secret-key-here-change-in-production

# Server
CONSOLE_API_URL=http://localhost:5001
CONSOLE_WEB_URL=http://localhost:3000

# Database
DB_TYPE=postgresql
DB_HOST=localhost
DB_PORT=5432
DB_USERNAME=postgres
DB_PASSWORD=difyai123456
DB_DATABASE=dify

# Redis
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=difyai123456
REDIS_DB=0
REDIS_USE_SSL=false

# Celery
CELERY_BROKER_URL=redis://:difyai123456@localhost:6379/1
CELERY_BACKEND=redis://:difyai123456@localhost:6379/2

# Vector Store (Weaviate)
VECTOR_STORE=weaviate
WEAVIATE_ENDPOINT=http://localhost:8080
WEAVIATE_API_KEY=

# LLM (å¾Œã§è¨­å®š)
OPENAI_API_KEY=
ANTHROPIC_API_KEY=

# Storage
STORAGE_TYPE=local
STORAGE_LOCAL_PATH=storage

# CORS
CONSOLE_CORS_ALLOW_ORIGINS=http://localhost:3000
WEB_API_CORS_ALLOW_ORIGINS=*
EOF

# .envãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼
cp .env.example .env
```

### ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```bash
# ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
uv sync --dev

# ç¢ºèª
uv run python --version
# Python 3.11.x ã¾ãŸã¯ 3.12.x
```

## 2.8 ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®åˆæœŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

### package.jsonã®ä½œæˆ

```bash
cd ../web

cat > package.json << 'EOF'
{
  "name": "dify-web",
  "version": "0.1.0",
  "private": true,
  "packageManager": "pnpm@10.23.0",
  "engines": {
    "node": ">=22.11.0"
  },
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "eslint --cache",
    "lint:fix": "eslint --cache --fix",
    "type-check": "tsc --noEmit"
  },
  "dependencies": {
    "next": "~15.5.6",
    "react": "19.1.1",
    "react-dom": "19.1.1",
    "@tanstack/react-query": "^5.90.5",
    "zustand": "^4.5.7",
    "ky": "^1.12.0",
    "react-i18next": "^15.7.4",
    "i18next": "^23.16.8",
    "reactflow": "^11.11.4",
    "tailwindcss": "^3.4.18",
    "classnames": "^2.5.1",
    "dayjs": "^1.11.19"
  },
  "devDependencies": {
    "@types/node": "22.11.0",
    "@types/react": "~19.1.17",
    "@types/react-dom": "~19.1.11",
    "typescript": "^5.9.3",
    "eslint": "^9.38.0",
    "@next/eslint-plugin-next": "15.5.4",
    "autoprefixer": "^10.4.21",
    "postcss": "^8.5.6"
  }
}
EOF
```

### TypeScriptè¨­å®š

```bash
cat > tsconfig.json << 'EOF'
{
  "compilerOptions": {
    "target": "ES2017",
    "lib": ["dom", "dom.iterable", "esnext"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "preserve",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": ["./*"]
    }
  },
  "include": ["next-env.d.ts", "**/*.ts", "**/*.tsx", ".next/types/**/*.ts"],
  "exclude": ["node_modules"]
}
EOF
```

### Next.jsè¨­å®š

```bash
cat > next.config.js << 'EOF'
/** @type {import('next').NextConfig} */
const nextConfig = {
  reactStrictMode: true,
  experimental: {
    serverActions: {
      bodySizeLimit: '10mb',
    },
  },
  images: {
    remotePatterns: [
      {
        protocol: 'https',
        hostname: '**',
      },
    ],
  },
}

module.exports = nextConfig
EOF
```

### Tailwind CSSè¨­å®š

```bash
cat > tailwind.config.js << 'EOF'
/** @type {import('tailwindcss').Config} */
module.exports = {
  content: [
    './app/**/*.{js,ts,jsx,tsx,mdx}',
  ],
  theme: {
    extend: {},
  },
  plugins: [],
}
EOF

cat > postcss.config.js << 'EOF'
module.exports = {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
}
EOF
```

### ç’°å¢ƒå¤‰æ•°ãƒ•ã‚¡ã‚¤ãƒ«

```bash
cat > .env.example << 'EOF'
NEXT_PUBLIC_API_PREFIX=http://localhost:5001/console/api
NEXT_PUBLIC_PUBLIC_API_PREFIX=http://localhost:5001/api
NEXT_PUBLIC_EDITION=SELF_HOSTED
NEXT_PUBLIC_DEPLOY_ENV=DEVELOPMENT
EOF

cp .env.example .env.local
```

### ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```bash
# ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
pnpm install

# ç¢ºèª
pnpm --version
# 10.23.0
```

## 2.9 Makefileã«ã‚ˆã‚‹ã‚¿ã‚¹ã‚¯è‡ªå‹•åŒ–

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã«ã€ã‚ˆãä½¿ã†ã‚³ãƒãƒ³ãƒ‰ã‚’ã¾ã¨ã‚ãŸMakefileã‚’ä½œæˆã—ã¾ã™ã€‚

```bash
cd ..

cat > Makefile << 'EOF'
.PHONY: help

help: ## ã“ã®ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-20s\033[0m %s\n", $$1, $$2}'

# ============================================
# ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
# ============================================

setup: ## åˆå›ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
	@echo "ğŸš€ åˆå›ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’é–‹å§‹ã—ã¾ã™..."
	$(MAKE) docker-up
	$(MAKE) api-install
	$(MAKE) web-install
	$(MAKE) api-migrate
	@echo "âœ… ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†ï¼"

# ============================================
# Docker
# ============================================

docker-up: ## DockerãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã‚’èµ·å‹•
	cd docker && docker compose -f docker-compose.middleware.yaml up -d

docker-down: ## DockerãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã‚’åœæ­¢
	cd docker && docker compose -f docker-compose.middleware.yaml down

docker-logs: ## Dockerã®ãƒ­ã‚°ã‚’è¡¨ç¤º
	cd docker && docker compose -f docker-compose.middleware.yaml logs -f

docker-ps: ## Dockerã‚³ãƒ³ãƒ†ãƒŠã®çŠ¶æ…‹ã‚’è¡¨ç¤º
	cd docker && docker compose -f docker-compose.middleware.yaml ps

docker-clean: ## Dockerãƒœãƒªãƒ¥ãƒ¼ãƒ ã‚’å«ã‚ã¦å‰Šé™¤ï¼ˆãƒ‡ãƒ¼ã‚¿å‰Šé™¤æ³¨æ„ï¼‰
	cd docker && docker compose -f docker-compose.middleware.yaml down -v
	rm -rf docker/volumes

# ============================================
# API (ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰)
# ============================================

api-install: ## APIä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
	cd api && uv sync --dev

api-migrate: ## ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œ
	cd api && uv run flask db upgrade

api-dev: ## APIé–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•
	cd api && uv run flask run --host 0.0.0.0 --port=5001 --debug

api-worker: ## Celery Workerã‚’èµ·å‹•
	cd api && uv run celery -A app.celery worker -P threads -c 2 --loglevel INFO

api-lint: ## APIã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
	cd api && uv run ruff format . && uv run ruff check --fix .

api-type-check: ## APIã®å‹ãƒã‚§ãƒƒã‚¯
	cd api && uv run basedpyright .

api-test: ## APIã®ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
	cd api && uv run pytest tests/

# ============================================
# Web (ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰)
# ============================================

web-install: ## Webä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
	cd web && pnpm install

web-dev: ## Webé–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•
	cd web && pnpm run dev

web-build: ## Webã‚’ãƒ“ãƒ«ãƒ‰
	cd web && pnpm run build

web-lint: ## Webã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
	cd web && pnpm run lint:fix

web-type-check: ## Webã®å‹ãƒã‚§ãƒƒã‚¯
	cd web && pnpm run type-check

# ============================================
# é–‹ç™º
# ============================================

dev: ## ã™ã¹ã¦ã®é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ï¼ˆtmuxä½¿ç”¨ï¼‰
	@echo "ğŸ”¥ é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã—ã¾ã™..."
	@echo "ã‚¿ãƒ¼ãƒŸãƒŠãƒ«1: Flask API (Port 5001)"
	@echo "ã‚¿ãƒ¼ãƒŸãƒŠãƒ«2: Next.js Web (Port 3000)"
	@echo "ã‚¿ãƒ¼ãƒŸãƒŠãƒ«3: Celery Worker"
	@echo ""
	@echo "ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å„ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§å®Ÿè¡Œã—ã¦ãã ã•ã„:"
	@echo "  Terminal 1: make api-dev"
	@echo "  Terminal 2: make web-dev"
	@echo "  Terminal 3: make api-worker"

lint: ## ã™ã¹ã¦ã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
	$(MAKE) api-lint
	$(MAKE) web-lint

type-check: ## ã™ã¹ã¦ã®å‹ãƒã‚§ãƒƒã‚¯
	$(MAKE) api-type-check
	$(MAKE) web-type-check

test: ## ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
	$(MAKE) api-test

# ============================================
# ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
# ============================================

clean: ## ç”Ÿæˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
	find . -type d -name __pycache__ -exec rm -rf {} +
	find . -type f -name "*.pyc" -delete
	rm -rf api/.pytest_cache
	rm -rf web/.next
	rm -rf web/node_modules/.cache

clean-all: clean docker-clean ## ã™ã¹ã¦ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼ˆãƒ‡ãƒ¼ã‚¿å«ã‚€ï¼‰
EOF
```

### Makefileã®ä½¿ã„æ–¹

```bash
# ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º
make help

# åˆå›ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
make setup

# é–‹ç™ºã‚µãƒ¼ãƒãƒ¼èµ·å‹•ï¼ˆ3ã¤ã®ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§ï¼‰
# Terminal 1
make api-dev

# Terminal 2
make web-dev

# Terminal 3
make api-worker
```

## 2.10 å‹•ä½œç¢ºèª

ã™ã¹ã¦ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ãŸã‚‰ã€å‹•ä½œç¢ºèªã‚’ã—ã¾ã™ã€‚

### 1. DockerãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã®ç¢ºèª

```bash
make docker-ps

# æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›:
# NAME              STATUS
# dify-postgres     Up (healthy)
# dify-redis        Up (healthy)
# dify-weaviate     Up (healthy)
```

### 2. ç°¡å˜ãªFlaskã‚¢ãƒ—ãƒªã§ç¢ºèª

```bash
cd api

# app.pyã‚’ä½œæˆï¼ˆä»®ï¼‰
cat > app.py << 'EOF'
from flask import Flask

app = Flask(__name__)

@app.route('/health')
def health():
    return {'status': 'ok'}

if __name__ == '__main__':
    app.run(debug=True, host='0.0.0.0', port=5001)
EOF

# èµ·å‹•
uv run python app.py
```

ãƒ–ãƒ©ã‚¦ã‚¶ã§ `http://localhost:5001/health` ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã€`{"status": "ok"}` ãŒè¡¨ç¤ºã•ã‚Œã‚Œã°OKã€‚

### 3. ç°¡å˜ãªNext.jsã‚¢ãƒ—ãƒªã§ç¢ºèª

```bash
cd ../web

# app/page.tsxã‚’ä½œæˆ
mkdir -p app
cat > app/page.tsx << 'EOF'
export default function Home() {
  return (
    <div className="p-8">
      <h1 className="text-2xl font-bold">Dify Clone</h1>
      <p className="mt-4">ç’°å¢ƒæ§‹ç¯‰å®Œäº†ï¼</p>
    </div>
  )
}
EOF

# app/layout.tsxã‚’ä½œæˆ
cat > app/layout.tsx << 'EOF'
import './globals.css'

export default function RootLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <html lang="ja">
      <body>{children}</body>
    </html>
  )
}
EOF

# app/globals.cssã‚’ä½œæˆ
cat > app/globals.css << 'EOF'
@tailwind base;
@tailwind components;
@tailwind utilities;
EOF

# èµ·å‹•
pnpm run dev
```

ãƒ–ãƒ©ã‚¦ã‚¶ã§ `http://localhost:3000` ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã€ã€ŒDify Cloneã€ã¨ã€Œç’°å¢ƒæ§‹ç¯‰å®Œäº†!ã€ãŒè¡¨ç¤ºã•ã‚Œã‚Œã°OKã€‚

## 2.11 ã¾ã¨ã‚

ã“ã®ç« ã§ã¯ã€ä»¥ä¸‹ã®ç’°å¢ƒã‚’æ§‹ç¯‰ã—ã¾ã—ãŸ:

âœ… **Docker Desktop**: PostgreSQL, Redis, Weaviateã‚’èµ·å‹•
âœ… **Python 3.11/3.12 + uv**: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰é–‹ç™ºç’°å¢ƒ
âœ… **Node.js 22 + pnpm**: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰é–‹ç™ºç’°å¢ƒ
âœ… **ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ **: Difyã®åŸºæœ¬çš„ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ
âœ… **Makefile**: ã‚ˆãä½¿ã†ã‚³ãƒãƒ³ãƒ‰ã®è‡ªå‹•åŒ–

### æ¬¡ã®ç« ã¸

æ¬¡ã®ç¬¬3ç« ã§ã¯ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆã¨ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè£…ã—ã¾ã™ã€‚ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®è¨­è¨ˆã¨ã€SQLAlchemyãƒ¢ãƒ‡ãƒ«ã®å®Ÿè£…ã‚’å­¦ã³ã¾ã™ã€‚

# ç¬¬3ç« : ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆã¨ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

ã“ã®ç« ã§ã¯ã€Difyã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆã‚’å­¦ã³ã€å®Ÿè£…ã—ã¾ã™ã€‚Domain-Driven Design (DDD) ã®æ¦‚å¿µã‹ã‚‰å§‹ã¾ã‚Šã€ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®è¨­è¨ˆã€SQLAlchemyãƒ¢ãƒ‡ãƒ«ã®å®Ÿè£…ã€ãã—ã¦Alembicã«ã‚ˆã‚‹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç®¡ç†ã¾ã§ã‚’ç¶²ç¾…ã—ã¾ã™ã€‚

## 3.1 Domain-Driven Design (DDD) ã®åŸºç¤

### 3.1.1 DDDã¨ã¯

Domain-Driven Design (DDD) ã¯ã€è¤‡é›‘ãªãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã‚’æŒã¤ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¨­è¨ˆã™ã‚‹ãŸã‚ã®æ‰‹æ³•ã§ã™ã€‚ä¸»ãªæ¦‚å¿µ:

**ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ (Entity)**
- ä¸€æ„ã®è­˜åˆ¥å­(ID)ã‚’æŒã¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
- ä¾‹: Account, Workflow, Dataset
- ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ã‚’é€šã˜ã¦åŒä¸€æ€§ãŒä¿ãŸã‚Œã‚‹

**å€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ (Value Object)**
- IDã‚’æŒãŸãšã€å±æ€§ã®å€¤ã§è­˜åˆ¥ã•ã‚Œã‚‹
- ä¸å¤‰ (immutable)
- ä¾‹: Email, Money, DateRange

**é›†ç´„ (Aggregate)**
- ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã¨å€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ã¾ã¨ã¾ã‚Š
- é›†ç´„ãƒ«ãƒ¼ãƒˆãŒå¤–éƒ¨ã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹ãƒã‚¤ãƒ³ãƒˆ
- ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å¢ƒç•Œã‚’å®šç¾©

**ãƒªãƒã‚¸ãƒˆãƒª (Repository)**
- ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹ã®æŠ½è±¡åŒ–
- é›†ç´„ã®æ°¸ç¶šåŒ–ã¨å–å¾—ã‚’æ‹…å½“

**ã‚µãƒ¼ãƒ“ã‚¹ (Service)**
- ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚„å€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å±ã•ãªã„ãƒ­ã‚¸ãƒƒã‚¯
- ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã®ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

### 3.1.2 Difyã§ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«

Difyã®ä¸»ãªãƒ‰ãƒ¡ã‚¤ãƒ³:

```
èªè¨¼ãƒ»èªå¯ãƒ‰ãƒ¡ã‚¤ãƒ³
â”œâ”€â”€ Account (ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ)
â”œâ”€â”€ Tenant (ãƒ†ãƒŠãƒ³ãƒˆ/ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹)
â””â”€â”€ TenantAccountJoin (ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ-ãƒ†ãƒŠãƒ³ãƒˆé–¢é€£)

ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‰ãƒ¡ã‚¤ãƒ³
â”œâ”€â”€ App (ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³)
â”œâ”€â”€ Workflow (ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼)
â””â”€â”€ WorkflowRun (ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œå±¥æ­´)

çŸ¥è­˜ãƒ™ãƒ¼ã‚¹ãƒ‰ãƒ¡ã‚¤ãƒ³
â”œâ”€â”€ Dataset (ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆ)
â”œâ”€â”€ Document (ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ)
â””â”€â”€ DocumentSegment (ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒãƒ£ãƒ³ã‚¯)

ãƒ¢ãƒ‡ãƒ«ç®¡ç†ãƒ‰ãƒ¡ã‚¤ãƒ³
â”œâ”€â”€ Provider (LLMãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼)
â””â”€â”€ ProviderModel (ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ãƒ¢ãƒ‡ãƒ«è¨­å®š)
```

## 3.2 ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®è¨­è¨ˆ

### 3.2.1 ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆã¨ã¯

ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã¯ã€1ã¤ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã§è¤‡æ•°ã®çµ„ç¹”(ãƒ†ãƒŠãƒ³ãƒˆ)ã‚’åˆ†é›¢ã—ã¦ç®¡ç†ã™ã‚‹è¨­è¨ˆã§ã™ã€‚

**Difyã®ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆæˆ¦ç•¥**: Row-Level Isolation (è¡Œãƒ¬ãƒ™ãƒ«åˆ†é›¢)

- ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ«ã« `tenant_id` ã‚«ãƒ©ãƒ ã‚’æŒãŸã›ã‚‹
- ã‚¯ã‚¨ãƒªæ™‚ã«å¿…ãš `tenant_id` ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¯å…±æœ‰ã™ã‚‹ãŒã€è«–ç†çš„ã«å®Œå…¨åˆ†é›¢

### 3.2.2 Tenant (ãƒ†ãƒŠãƒ³ãƒˆ) ãƒ¢ãƒ‡ãƒ«

Difyã§ã¯ã€ŒTenantã€ãŒçµ„ç¹”/ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã«ç›¸å½“ã—ã¾ã™:

```python
# api/models/account.py ã‹ã‚‰æŠœç²‹
class Tenant(TypeBase):
    __tablename__ = "tenants"

    id: Mapped[str] = mapped_column(StringUUID, default=lambda: str(uuid4()))
    name: Mapped[str] = mapped_column(String(255))  # ãƒ†ãƒŠãƒ³ãƒˆå
    plan: Mapped[str] = mapped_column(String(255), default="basic")  # æ–™é‡‘ãƒ—ãƒ©ãƒ³
    status: Mapped[str] = mapped_column(String(255), default="normal")
    created_at: Mapped[datetime] = mapped_column(DateTime)
    updated_at: Mapped[datetime] = mapped_column(DateTime, onupdate=func.current_timestamp())
```

**ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹**: [api/models/account.py](api/models/account.py#L234-L267)

### 3.2.3 Account (ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ) ãƒ¢ãƒ‡ãƒ«

ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’è¡¨ç¾:

```python
class Account(UserMixin, TypeBase):
    __tablename__ = "accounts"

    id: Mapped[str] = mapped_column(StringUUID, default=lambda: str(uuid4()))
    name: Mapped[str] = mapped_column(String(255))
    email: Mapped[str] = mapped_column(String(255))
    password: Mapped[str | None] = mapped_column(String(255), default=None)
    password_salt: Mapped[str | None] = mapped_column(String(255), default=None)
    avatar: Mapped[str | None] = mapped_column(String(255), default=None)
    interface_language: Mapped[str | None] = mapped_column(String(255), default=None)
    timezone: Mapped[str | None] = mapped_column(String(255), default=None)
    status: Mapped[str] = mapped_column(String(16), default="active")
    created_at: Mapped[datetime] = mapped_column(DateTime)
    updated_at: Mapped[datetime] = mapped_column(DateTime, onupdate=func.current_timestamp())
```

**ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹**: [api/models/account.py](api/models/account.py#L62-L120)

### 3.2.4 TenantAccountJoin (å¤šå¯¾å¤šã®é–¢é€£)

1äººã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¯è¤‡æ•°ã®ãƒ†ãƒŠãƒ³ãƒˆã«æ‰€å±ã§ãã¾ã™:

```python
class TenantAccountRole(enum.StrEnum):
    """ãƒ†ãƒŠãƒ³ãƒˆå†…ã§ã®å½¹å‰²"""
    OWNER = "owner"             # ã‚ªãƒ¼ãƒŠãƒ¼ (ã™ã¹ã¦ã®æ¨©é™)
    ADMIN = "admin"             # ç®¡ç†è€…
    EDITOR = "editor"           # ç·¨é›†è€…
    NORMAL = "normal"           # ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼
    DATASET_OPERATOR = "dataset_operator"  # ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆæ“ä½œè€…

class TenantAccountJoin(TypeBase):
    __tablename__ = "tenant_account_joins"

    id: Mapped[str] = mapped_column(StringUUID, default=lambda: str(uuid4()))
    tenant_id: Mapped[str] = mapped_column(StringUUID)
    account_id: Mapped[str] = mapped_column(StringUUID)
    role: Mapped[str] = mapped_column(String(16), default="normal")
    current: Mapped[bool] = mapped_column(sa.Boolean, default=False)  # ç¾åœ¨é¸æŠä¸­ã‹
    invited_by: Mapped[str | None] = mapped_column(StringUUID, nullable=True)
    created_at: Mapped[datetime] = mapped_column(DateTime)
    updated_at: Mapped[datetime] = mapped_column(DateTime, onupdate=func.current_timestamp())
```

**ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹**: [api/models/account.py](api/models/account.py#L269-L290)

## 3.3 SQLAlchemy 2.0 ãƒ¢ãƒ‡ãƒ«ã®å®Ÿè£…

### 3.3.1 Base ã‚¯ãƒ©ã‚¹ã®å®šç¾©

ã™ã¹ã¦ã®ãƒ¢ãƒ‡ãƒ«ã®åŸºåº•ã‚¯ãƒ©ã‚¹:

```python
# api/models/base.py
from datetime import datetime
from sqlalchemy import DateTime, func
from sqlalchemy.orm import DeclarativeBase, Mapped, MappedAsDataclass, mapped_column
from libs.uuid_utils import uuidv7
from .types import StringUUID

class Base(DeclarativeBase):
    """åŸºæœ¬çš„ãªDeclarativeBase"""
    metadata = metadata

class TypeBase(MappedAsDataclass, DeclarativeBase):
    """å‹ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½¿ã†ãŸã‚ã®Base (æ¨å¥¨)"""
    metadata = metadata

class DefaultFieldsMixin:
    """ã‚ˆãä½¿ã†ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®Mixin"""
    id: Mapped[str] = mapped_column(
        StringUUID,
        primary_key=True,
        default=lambda: str(uuidv7()),  # UUIDv7ã‚’ä½¿ç”¨
    )

    created_at: Mapped[datetime] = mapped_column(
        DateTime,
        nullable=False,
        default=naive_utc_now,
        server_default=func.current_timestamp(),
    )

    updated_at: Mapped[datetime] = mapped_column(
        DateTime,
        nullable=False,
        default=naive_utc_now,
        server_default=func.current_timestamp(),
        onupdate=func.current_timestamp(),  # æ›´æ–°æ™‚ã«è‡ªå‹•æ›´æ–°
    )
```

**ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹**: [api/models/base.py](api/models/base.py#L1-L53)

### 3.3.2 Workflow (ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼) ãƒ¢ãƒ‡ãƒ«

ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®å®šç¾©ã‚’ä¿å­˜:

```python
# api/models/workflow.py
from sqlalchemy import String, LongText, Index
from sqlalchemy.orm import Mapped, mapped_column
from enum import StrEnum
import json

class WorkflowType(StrEnum):
    """ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®ç¨®é¡"""
    WORKFLOW = "workflow"           # é€šå¸¸ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
    CHAT = "chat"                   # ãƒãƒ£ãƒƒãƒˆã‚¢ãƒ—ãƒª
    RAG_PIPELINE = "rag-pipeline"   # RAGãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³

class Workflow(Base):
    __tablename__ = "workflows"
    __table_args__ = (
        Index("workflow_tenant_id_idx", "tenant_id"),
        Index("workflow_app_id_idx", "app_id"),
    )

    id: Mapped[str] = mapped_column(StringUUID, primary_key=True, default=lambda: str(uuid4()))
    tenant_id: Mapped[str] = mapped_column(StringUUID, nullable=False)  # ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆå¯¾å¿œ
    app_id: Mapped[str] = mapped_column(StringUUID, nullable=False)
    type: Mapped[str] = mapped_column(String(255), nullable=False)
    version: Mapped[str] = mapped_column(String(255), nullable=False)
    graph: Mapped[str] = mapped_column(LongText)  # ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚°ãƒ©ãƒ•(JSON)
    features: Mapped[str] = mapped_column(LongText)  # æ©Ÿèƒ½è¨­å®š(JSON)
    created_by: Mapped[str] = mapped_column(StringUUID, nullable=False)
    created_at: Mapped[datetime] = mapped_column(DateTime, server_default=func.current_timestamp())
    updated_by: Mapped[str | None] = mapped_column(StringUUID, nullable=True)
    updated_at: Mapped[datetime] = mapped_column(DateTime, server_default=func.current_timestamp())

    @property
    def graph_dict(self) -> dict:
        """ã‚°ãƒ©ãƒ•ã‚’JSONã¨ã—ã¦ãƒ‘ãƒ¼ã‚¹"""
        return json.loads(self.graph) if self.graph else {}

    def get_node_config_by_id(self, node_id: str) -> dict:
        """ãƒãƒ¼ãƒ‰IDã‹ã‚‰ãƒãƒ¼ãƒ‰è¨­å®šã‚’å–å¾—"""
        workflow_graph = self.graph_dict
        nodes = workflow_graph.get("nodes", [])
        node = next((n for n in nodes if n["id"] == node_id), None)
        if not node:
            raise NodeNotFoundError(node_id)
        return node
```

**ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹**: [api/models/workflow.py](api/models/workflow.py#L1-L252)

### 3.3.3 Dataset (ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆ) ãƒ¢ãƒ‡ãƒ«

çŸ¥è­˜ãƒ™ãƒ¼ã‚¹ã‚’ç®¡ç†:

```python
# api/models/dataset.py
class Dataset(Base):
    __tablename__ = "datasets"
    __table_args__ = (
        Index("dataset_tenant_id_idx", "tenant_id"),
    )

    id: Mapped[str] = mapped_column(StringUUID, primary_key=True, default=lambda: str(uuid4()))
    tenant_id: Mapped[str] = mapped_column(StringUUID, nullable=False)
    name: Mapped[str] = mapped_column(String(255), nullable=False)
    description: Mapped[str | None] = mapped_column(LongText, nullable=True)
    provider: Mapped[str] = mapped_column(String(255), default="vendor")
    permission: Mapped[str] = mapped_column(String(255), default="only_me")
    data_source_type: Mapped[str | None] = mapped_column(String(255), nullable=True)
    indexing_technique: Mapped[str | None] = mapped_column(String(255), nullable=True)

    # Embeddingè¨­å®š
    embedding_model: Mapped[str | None] = mapped_column(String(255), nullable=True)
    embedding_model_provider: Mapped[str | None] = mapped_column(String(255), nullable=True)

    # æ¤œç´¢è¨­å®š
    retrieval_model = mapped_column(AdjustedJSON, nullable=True)  # JSONå‹

    created_by: Mapped[str] = mapped_column(StringUUID, nullable=False)
    created_at: Mapped[datetime] = mapped_column(DateTime, server_default=func.current_timestamp())
    updated_by: Mapped[str | None] = mapped_column(StringUUID, nullable=True)
    updated_at: Mapped[datetime] = mapped_column(DateTime, server_default=func.current_timestamp())

    @property
    def retrieval_model_dict(self) -> dict:
        """æ¤œç´¢ãƒ¢ãƒ‡ãƒ«è¨­å®šã‚’ãƒ‘ãƒ¼ã‚¹"""
        default = {
            "search_method": "semantic_search",
            "reranking_enable": False,
            "top_k": 2,
            "score_threshold_enabled": False,
        }
        return self.retrieval_model or default

    @property
    def available_document_count(self) -> int:
        """åˆ©ç”¨å¯èƒ½ãªãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•°"""
        return db.session.query(func.count(Document.id)).where(
            Document.dataset_id == self.id,
            Document.indexing_status == "completed",
            Document.enabled == True,
            Document.archived == False,
        ).scalar()
```

**ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹**: [api/models/dataset.py](api/models/dataset.py#L1-L309)

### 3.3.4 Document (ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ) ãƒ¢ãƒ‡ãƒ«

ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆå†…ã®å€‹åˆ¥ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ:

```python
class DocumentStatus(StrEnum):
    """ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹"""
    INDEXING = "indexing"
    COMPLETED = "completed"
    ERROR = "error"
    PAUSED = "paused"

class Document(Base):
    __tablename__ = "documents"
    __table_args__ = (
        Index("document_dataset_id_idx", "dataset_id"),
        Index("document_is_paused_idx", "is_paused"),
    )

    id: Mapped[str] = mapped_column(StringUUID, primary_key=True, default=lambda: str(uuid4()))
    tenant_id: Mapped[str] = mapped_column(StringUUID, nullable=False)
    dataset_id: Mapped[str] = mapped_column(StringUUID, nullable=False)
    position: Mapped[int] = mapped_column(sa.Integer, nullable=False)
    data_source_type: Mapped[str] = mapped_column(String(255), nullable=False)
    data_source_info: Mapped[str | None] = mapped_column(LongText, nullable=True)
    dataset_process_rule_id: Mapped[str | None] = mapped_column(StringUUID, nullable=True)
    batch: Mapped[str] = mapped_column(String(255), nullable=False)
    name: Mapped[str] = mapped_column(String(255), nullable=False)

    # ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹çŠ¶æ…‹
    indexing_status: Mapped[str] = mapped_column(String(255), default="indexing")
    error: Mapped[str | None] = mapped_column(LongText, nullable=True)
    enabled: Mapped[bool] = mapped_column(sa.Boolean, default=True)
    disabled_at: Mapped[datetime | None] = mapped_column(DateTime, nullable=True)
    disabled_by: Mapped[str | None] = mapped_column(StringUUID, nullable=True)
    archived: Mapped[bool] = mapped_column(sa.Boolean, default=False)

    # çµ±è¨ˆæƒ…å ±
    word_count: Mapped[int] = mapped_column(sa.Integer, default=0)
    tokens: Mapped[int] = mapped_column(sa.Integer, default=0)

    created_by: Mapped[str] = mapped_column(StringUUID, nullable=False)
    created_at: Mapped[datetime] = mapped_column(DateTime, server_default=func.current_timestamp())
    updated_at: Mapped[datetime] = mapped_column(DateTime, server_default=func.current_timestamp())
```

## 3.4 ã‚«ã‚¹ã‚¿ãƒ å‹ã®å®šç¾©

### 3.4.1 StringUUID å‹

UUIDã‚’æ–‡å­—åˆ—ã¨ã—ã¦æ‰±ã†:

```python
# api/models/types.py
from sqlalchemy import TypeDecorator, String
import uuid

class StringUUID(TypeDecorator):
    """UUIDã‚’æ–‡å­—åˆ—ã¨ã—ã¦ä¿å­˜ã™ã‚‹å‹"""
    impl = String(36)
    cache_ok = True

    def process_bind_param(self, value, dialect):
        """Pythonã‹ã‚‰DBã¸: UUIDã‚’æ–‡å­—åˆ—ã«å¤‰æ›"""
        if value is None:
            return value
        elif isinstance(value, uuid.UUID):
            return str(value)
        return str(value)

    def process_result_value(self, value, dialect):
        """DBã‹ã‚‰Pythonã¸: æ–‡å­—åˆ—ã®ã¾ã¾è¿”ã™"""
        return value if value is not None else None
```

### 3.4.2 AdjustedJSON å‹

PostgreSQLç”¨ã®JSONå‹:

```python
from sqlalchemy.dialects.postgresql import JSONB
from sqlalchemy import JSON, TypeDecorator

class AdjustedJSON(TypeDecorator):
    """PostgreSQLã®å ´åˆã¯JSONBã€ãã‚Œä»¥å¤–ã¯JSON"""
    impl = JSON
    cache_ok = True

    def load_dialect_impl(self, dialect):
        if dialect.name == 'postgresql':
            return dialect.type_descriptor(JSONB())
        else:
            return dialect.type_descriptor(JSON())
```

## 3.5 ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã®è¨­å®š

### 3.5.1 extensions/ext_database.py ã®å®Ÿè£…

```python
# api/extensions/ext_database.py
from flask_sqlalchemy import SQLAlchemy
from sqlalchemy import create_engine, MetaData
from sqlalchemy.orm import sessionmaker, scoped_session

# ã‚°ãƒ­ãƒ¼ãƒãƒ«ãªMetaDataã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
metadata = MetaData(
    naming_convention={
        "ix": "ix_%(column_0_label)s",
        "uq": "uq_%(table_name)s_%(column_0_name)s",
        "ck": "ck_%(table_name)s_%(constraint_name)s",
        "fk": "fk_%(table_name)s_%(column_0_name)s_%(referred_table_name)s",
        "pk": "pk_%(table_name)s"
    }
)

# Flask-SQLAlchemyã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
db = SQLAlchemy(metadata=metadata)

def init_app(app):
    """Flaskã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«åˆæœŸåŒ–"""
    db.init_app(app)
```

**ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ**:

```bash
# api/extensions/ext_database.py ã‚’ä½œæˆ
mkdir -p api/extensions
cat > api/extensions/ext_database.py << 'EOF'
from flask_sqlalchemy import SQLAlchemy
from sqlalchemy import MetaData

metadata = MetaData(
    naming_convention={
        "ix": "ix_%(column_0_label)s",
        "uq": "uq_%(table_name)s_%(column_0_name)s",
        "ck": "ck_%(table_name)s_%(constraint_name)s",
        "fk": "fk_%(table_name)s_%(column_0_name)s_%(referred_table_name)s",
        "pk": "pk_%(table_name)s"
    }
)

db = SQLAlchemy(metadata=metadata)

def init_app(app):
    db.init_app(app)
EOF
```

### 3.5.2 ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­å®š (configs/db_config.py)

```python
# api/configs/db_config.py
from pydantic_settings import BaseSettings

class DatabaseConfig(BaseSettings):
    """ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šè¨­å®š"""

    # PostgreSQLæ¥ç¶šæƒ…å ±
    DB_USERNAME: str = "postgres"
    DB_PASSWORD: str = "difyai123456"
    DB_HOST: str = "localhost"
    DB_PORT: int = 5432
    DB_DATABASE: str = "dify"

    # SQLAlchemyè¨­å®š
    SQLALCHEMY_DATABASE_URI_SCHEME: str = "postgresql+psycopg"
    SQLALCHEMY_POOL_SIZE: int = 30
    SQLALCHEMY_POOL_RECYCLE: int = 3600
    SQLALCHEMY_POOL_PRE_PING: bool = True
    SQLALCHEMY_ECHO: bool = False

    @property
    def SQLALCHEMY_DATABASE_URI(self) -> str:
        """SQLAlchemyã®DBæ¥ç¶šURI"""
        return (
            f"{self.SQLALCHEMY_DATABASE_URI_SCHEME}://"
            f"{self.DB_USERNAME}:{self.DB_PASSWORD}@"
            f"{self.DB_HOST}:{self.DB_PORT}/{self.DB_DATABASE}"
        )

    model_config = {
        "env_prefix": "",
        "extra": "ignore",
    }
```

**ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ**:

```bash
cat > api/configs/db_config.py << 'EOF'
from pydantic_settings import BaseSettings

class DatabaseConfig(BaseSettings):
    DB_USERNAME: str = "postgres"
    DB_PASSWORD: str = "difyai123456"
    DB_HOST: str = "localhost"
    DB_PORT: int = 5432
    DB_DATABASE: str = "dify"

    SQLALCHEMY_DATABASE_URI_SCHEME: str = "postgresql+psycopg"
    SQLALCHEMY_POOL_SIZE: int = 30
    SQLALCHEMY_POOL_RECYCLE: int = 3600
    SQLALCHEMY_POOL_PRE_PING: bool = True
    SQLALCHEMY_ECHO: bool = False

    @property
    def SQLALCHEMY_DATABASE_URI(self) -> str:
        return (
            f"{self.SQLALCHEMY_DATABASE_URI_SCHEME}://"
            f"{self.DB_USERNAME}:{self.DB_PASSWORD}@"
            f"{self.DB_HOST}:{self.DB_PORT}/{self.DB_DATABASE}"
        )

    model_config = {
        "env_prefix": "",
        "extra": "ignore",
    }
EOF
```

## 3.6 Alembicãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

### 3.6.1 Alembicã¨ã¯

Alembicã¯ã€SQLAlchemyã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒã®å¤‰æ›´ã‚’ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ã§ãã¾ã™ã€‚

**ä¸»ãªæ©Ÿèƒ½**:
- ã‚¹ã‚­ãƒ¼ãƒå¤‰æ›´ã®å±¥æ­´ç®¡ç†
- è‡ªå‹•ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆç”Ÿæˆ
- ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰/ãƒ€ã‚¦ãƒ³ã‚°ãƒ¬ãƒ¼ãƒ‰
- è¤‡æ•°ç’°å¢ƒå¯¾å¿œ

### 3.6.2 Alembicã®åˆæœŸåŒ–

```bash
cd api

# Alembicã®åˆæœŸåŒ–
uv run alembic init migrations

# ä»¥ä¸‹ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ãŒä½œæˆã•ã‚Œã¾ã™:
# migrations/
# â”œâ”€â”€ alembic.ini         # Alembicè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«
# â”œâ”€â”€ env.py              # ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç’°å¢ƒè¨­å®š
# â”œâ”€â”€ script.py.mako      # ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
# â””â”€â”€ versions/           # ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆç½®ãå ´
```

### 3.6.3 migrations/env.py ã®è¨­å®š

```python
# api/migrations/env.py
from logging.config import fileConfig
from sqlalchemy import engine_from_config, pool
from alembic import context
import os
import sys

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã‚’ãƒ‘ã‚¹ã«è¿½åŠ 
sys.path.insert(0, os.path.dirname(os.path.dirname(__file__)))

# Alembicã‚³ãƒ³ãƒ•ã‚£ã‚°ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
config = context.config

# ãƒ­ã‚°è¨­å®š
if config.config_file_name is not None:
    fileConfig(config.config_file_name)

# ãƒ¢ãƒ‡ãƒ«ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
from models.base import Base
from models.account import Account, Tenant, TenantAccountJoin
from models.workflow import Workflow
from models.dataset import Dataset, Document
# ä»–ã®ãƒ¢ãƒ‡ãƒ«ã‚‚ã“ã“ã§ã‚¤ãƒ³ãƒãƒ¼ãƒˆ

# ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®š
target_metadata = Base.metadata

# è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰æ¥ç¶šURIã‚’èª­ã¿è¾¼ã‚€
from configs.db_config import DatabaseConfig
db_config = DatabaseConfig()
config.set_main_option("sqlalchemy.url", db_config.SQLALCHEMY_DATABASE_URI)

def run_migrations_offline() -> None:
    """ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ã§ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ"""
    url = config.get_main_option("sqlalchemy.url")
    context.configure(
        url=url,
        target_metadata=target_metadata,
        literal_binds=True,
        dialect_opts={"paramstyle": "named"},
        compare_type=True,
        compare_server_default=True,
    )

    with context.begin_transaction():
        context.run_migrations()

def run_migrations_online() -> None:
    """ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ã§ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ"""
    connectable = engine_from_config(
        config.get_section(config.config_ini_section, {}),
        prefix="sqlalchemy.",
        poolclass=pool.NullPool,
    )

    with connectable.connect() as connection:
        context.configure(
            connection=connection,
            target_metadata=target_metadata,
            compare_type=True,
            compare_server_default=True,
        )

        with context.begin_transaction():
            context.run_migrations()

if context.is_offline_mode():
    run_migrations_offline()
else:
    run_migrations_online()
```

### 3.6.4 alembic.ini ã®è¨­å®š

```ini
# api/migrations/alembic.ini
[alembic]
# ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã®å‘½åè¦å‰‡
file_template = %%(year)d_%%(month).2d_%%(day).2d_%%(hour).2d%%(minute).2d-%%(rev)s_%%(slug)s

# ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆç½®ãå ´
script_location = migrations

[loggers]
keys = root,sqlalchemy,alembic

[handlers]
keys = console

[formatters]
keys = generic

[logger_root]
level = WARN
handlers = console

[logger_sqlalchemy]
level = WARN
handlers =
qualname = sqlalchemy.engine

[logger_alembic]
level = INFO
handlers =
qualname = alembic

[handler_console]
class = StreamHandler
args = (sys.stderr,)
level = NOTSET
formatter = generic

[formatter_generic]
format = %(levelname)-5.5s [%(name)s] %(message)s
```

### 3.6.5 åˆå›ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ä½œæˆ

```bash
cd api

# ç¾åœ¨ã®ãƒ¢ãƒ‡ãƒ«ã‹ã‚‰ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è‡ªå‹•ç”Ÿæˆ
uv run alembic revision --autogenerate -m "initial schema"

# ç”Ÿæˆã•ã‚ŒãŸãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«: migrations/versions/2024_11_27_1234-abc123_initial_schema.py
```

ç”Ÿæˆã•ã‚Œã‚‹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¾‹:

```python
# migrations/versions/2024_11_27_1234-abc123_initial_schema.py
"""initial schema

Revision ID: abc123
Revises:
Create Date: 2024-11-27 12:34:56.789012

"""
from typing import Sequence, Union
from alembic import op
import sqlalchemy as sa

# revision identifiers
revision: str = 'abc123'
down_revision: Union[str, None] = None
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None

def upgrade() -> None:
    # Tenantsãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
    op.create_table('tenants',
        sa.Column('id', sa.String(length=36), nullable=False),
        sa.Column('name', sa.String(length=255), nullable=False),
        sa.Column('plan', sa.String(length=255), server_default='basic', nullable=False),
        sa.Column('status', sa.String(length=255), server_default='normal', nullable=False),
        sa.Column('created_at', sa.DateTime(), server_default=sa.text('CURRENT_TIMESTAMP'), nullable=False),
        sa.Column('updated_at', sa.DateTime(), server_default=sa.text('CURRENT_TIMESTAMP'), nullable=False),
        sa.PrimaryKeyConstraint('id', name='tenant_pkey')
    )

    # Accountsãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
    op.create_table('accounts',
        sa.Column('id', sa.String(length=36), nullable=False),
        sa.Column('name', sa.String(length=255), nullable=False),
        sa.Column('email', sa.String(length=255), nullable=False),
        sa.Column('password', sa.String(length=255), nullable=True),
        sa.Column('password_salt', sa.String(length=255), nullable=True),
        sa.Column('avatar', sa.String(length=255), nullable=True),
        sa.Column('status', sa.String(length=16), server_default='active', nullable=False),
        sa.Column('created_at', sa.DateTime(), server_default=sa.text('CURRENT_TIMESTAMP'), nullable=False),
        sa.Column('updated_at', sa.DateTime(), server_default=sa.text('CURRENT_TIMESTAMP'), nullable=False),
        sa.PrimaryKeyConstraint('id', name='account_pkey'),
        sa.UniqueConstraint('email', name='uq_accounts_email')
    )
    op.create_index('account_email_idx', 'accounts', ['email'])

    # TenantAccountJoinsãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
    op.create_table('tenant_account_joins',
        sa.Column('id', sa.String(length=36), nullable=False),
        sa.Column('tenant_id', sa.String(length=36), nullable=False),
        sa.Column('account_id', sa.String(length=36), nullable=False),
        sa.Column('role', sa.String(length=16), server_default='normal', nullable=False),
        sa.Column('current', sa.Boolean(), server_default='false', nullable=False),
        sa.Column('created_at', sa.DateTime(), server_default=sa.text('CURRENT_TIMESTAMP'), nullable=False),
        sa.Column('updated_at', sa.DateTime(), server_default=sa.text('CURRENT_TIMESTAMP'), nullable=False),
        sa.PrimaryKeyConstraint('id', name='tenant_account_join_pkey'),
        sa.UniqueConstraint('tenant_id', 'account_id', name='unique_tenant_account_join')
    )
    op.create_index('tenant_account_join_tenant_id_idx', 'tenant_account_joins', ['tenant_id'])
    op.create_index('tenant_account_join_account_id_idx', 'tenant_account_joins', ['account_id'])

    # Workflowsãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
    op.create_table('workflows',
        sa.Column('id', sa.String(length=36), nullable=False),
        sa.Column('tenant_id', sa.String(length=36), nullable=False),
        sa.Column('app_id', sa.String(length=36), nullable=False),
        sa.Column('type', sa.String(length=255), nullable=False),
        sa.Column('version', sa.String(length=255), nullable=False),
        sa.Column('graph', sa.Text(), nullable=True),
        sa.Column('features', sa.Text(), nullable=True),
        sa.Column('created_by', sa.String(length=36), nullable=False),
        sa.Column('created_at', sa.DateTime(), server_default=sa.text('CURRENT_TIMESTAMP'), nullable=False),
        sa.Column('updated_by', sa.String(length=36), nullable=True),
        sa.Column('updated_at', sa.DateTime(), server_default=sa.text('CURRENT_TIMESTAMP'), nullable=False),
        sa.PrimaryKeyConstraint('id', name='workflow_pkey')
    )
    op.create_index('workflow_tenant_id_idx', 'workflows', ['tenant_id'])
    op.create_index('workflow_app_id_idx', 'workflows', ['app_id'])

    # Datasetsãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
    op.create_table('datasets',
        sa.Column('id', sa.String(length=36), nullable=False),
        sa.Column('tenant_id', sa.String(length=36), nullable=False),
        sa.Column('name', sa.String(length=255), nullable=False),
        sa.Column('description', sa.Text(), nullable=True),
        sa.Column('provider', sa.String(length=255), server_default='vendor', nullable=False),
        sa.Column('indexing_technique', sa.String(length=255), nullable=True),
        sa.Column('embedding_model', sa.String(length=255), nullable=True),
        sa.Column('retrieval_model', sa.JSON(), nullable=True),
        sa.Column('created_by', sa.String(length=36), nullable=False),
        sa.Column('created_at', sa.DateTime(), server_default=sa.text('CURRENT_TIMESTAMP'), nullable=False),
        sa.Column('updated_at', sa.DateTime(), server_default=sa.text('CURRENT_TIMESTAMP'), nullable=False),
        sa.PrimaryKeyConstraint('id', name='dataset_pkey')
    )
    op.create_index('dataset_tenant_id_idx', 'datasets', ['tenant_id'])

def downgrade() -> None:
    # ãƒ†ãƒ¼ãƒ–ãƒ«å‰Šé™¤ (é€†é †)
    op.drop_index('dataset_tenant_id_idx', table_name='datasets')
    op.drop_table('datasets')

    op.drop_index('workflow_app_id_idx', table_name='workflows')
    op.drop_index('workflow_tenant_id_idx', table_name='workflows')
    op.drop_table('workflows')

    op.drop_index('tenant_account_join_account_id_idx', table_name='tenant_account_joins')
    op.drop_index('tenant_account_join_tenant_id_idx', table_name='tenant_account_joins')
    op.drop_table('tenant_account_joins')

    op.drop_index('account_email_idx', table_name='accounts')
    op.drop_table('accounts')

    op.drop_table('tenants')
```

### 3.6.6 ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®å®Ÿè¡Œ

```bash
# ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é©ç”¨
uv run alembic upgrade head

# æˆåŠŸã™ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ãªå‡ºåŠ›:
# INFO  [alembic.runtime.migration] Context impl PostgresqlImpl.
# INFO  [alembic.runtime.migration] Will assume transactional DDL.
# INFO  [alembic.runtime.migration] Running upgrade  -> abc123, initial schema

# ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å±¥æ­´ã‚’ç¢ºèª
uv run alembic history

# ç¾åœ¨ã®ãƒªãƒ“ã‚¸ãƒ§ãƒ³ã‚’ç¢ºèª
uv run alembic current
```

### 3.6.7 ãƒ€ã‚¦ãƒ³ã‚°ãƒ¬ãƒ¼ãƒ‰(ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯)

```bash
# 1ã¤å‰ã«æˆ»ã™
uv run alembic downgrade -1

# ç‰¹å®šã®ãƒªãƒ“ã‚¸ãƒ§ãƒ³ã«æˆ»ã™
uv run alembic downgrade abc123

# ã™ã¹ã¦ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å…ƒã«æˆ»ã™
uv run alembic downgrade base
```

## 3.7 å®Ÿè·µ: ãƒ¢ãƒ‡ãƒ«ã‚’è¿½åŠ ã™ã‚‹

æ–°ã—ã„ãƒ¢ãƒ‡ãƒ«ã‚’è¿½åŠ ã™ã‚‹æ‰‹é †ã‚’å®Ÿè·µã—ã¾ã—ã‚‡ã†ã€‚

### 3.7.1 App (ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³) ãƒ¢ãƒ‡ãƒ«ã®è¿½åŠ 

```python
# api/models/app.py
from sqlalchemy import String, LongText, Boolean, Index
from sqlalchemy.orm import Mapped, mapped_column
from datetime import datetime
from .base import Base
from .types import StringUUID
from uuid import uuid4

class App(Base):
    """ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¢ãƒ‡ãƒ«"""
    __tablename__ = "apps"
    __table_args__ = (
        Index("app_tenant_id_idx", "tenant_id"),
        Index("app_is_public_idx", "is_public"),
    )

    id: Mapped[str] = mapped_column(StringUUID, primary_key=True, default=lambda: str(uuid4()))
    tenant_id: Mapped[str] = mapped_column(StringUUID, nullable=False)
    name: Mapped[str] = mapped_column(String(255), nullable=False)
    description: Mapped[str | None] = mapped_column(LongText, nullable=True)
    mode: Mapped[str] = mapped_column(String(255), nullable=False)  # chat, workflow, agent-chat, completion
    icon: Mapped[str | None] = mapped_column(String(255), nullable=True)
    icon_background: Mapped[str | None] = mapped_column(String(255), nullable=True)

    # å…¬é–‹è¨­å®š
    is_public: Mapped[bool] = mapped_column(Boolean, default=False)

    # ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–
    enable_site: Mapped[bool] = mapped_column(Boolean, default=True)
    enable_api: Mapped[bool] = mapped_column(Boolean, default=True)

    created_by: Mapped[str] = mapped_column(StringUUID, nullable=False)
    created_at: Mapped[datetime] = mapped_column(DateTime, server_default=func.current_timestamp())
    updated_at: Mapped[datetime] = mapped_column(DateTime, server_default=func.current_timestamp())

    def __repr__(self) -> str:
        return f"<App(id={self.id}, name={self.name}, mode={self.mode})>"
```

### 3.7.2 ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ç”Ÿæˆã¨é©ç”¨

```bash
# æ–°ã—ã„ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆ
uv run alembic revision --autogenerate -m "add app model"

# ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèª
cat migrations/versions/2024_11_27_xxxx-xxx_add_app_model.py

# ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é©ç”¨
uv run alembic upgrade head

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«åæ˜ ã•ã‚ŒãŸã‹ç¢ºèª
psql -h localhost -U postgres -d dify -c "\dt"
```

## 3.8 ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

### 3.8.1 ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ä½œæˆã®åŸå‰‡

1. **å°ã•ãä¿ã¤**: 1ã¤ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§1ã¤ã®å¤‰æ›´
2. **å¿…ãšãƒ¬ãƒ“ãƒ¥ãƒ¼**: è‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å¿…ãšç¢ºèª
3. **ãƒ€ã‚¦ãƒ³ã‚°ãƒ¬ãƒ¼ãƒ‰å¯¾å¿œ**: `downgrade()` ã‚’å¿…ãšå®Ÿè£…
4. **æœ¬ç•ªå‰ãƒ†ã‚¹ãƒˆ**: ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒã§å¿…ãšãƒ†ã‚¹ãƒˆ
5. **ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³åˆ†é›¢**: ã‚¹ã‚­ãƒ¼ãƒå¤‰æ›´ã¨ãƒ‡ãƒ¼ã‚¿å¤‰æ›´ã¯åˆ¥ã€…ã«

### 3.8.2 æ‰‹å‹•ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ä½œæˆ

è‡ªå‹•ç”Ÿæˆã§ããªã„è¤‡é›‘ãªå¤‰æ›´ã¯æ‰‹å‹•ã§ä½œæˆ:

```bash
# ç©ºã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
uv run alembic revision -m "migrate existing data"
```

```python
# migrations/versions/xxxx_migrate_existing_data.py
def upgrade() -> None:
    # ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ä¾‹
    connection = op.get_bind()

    # æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
    connection.execute(
        sa.text("""
            UPDATE workflows
            SET version = 'draft'
            WHERE version IS NULL
        """)
    )

    # NOT NULLåˆ¶ç´„ã‚’è¿½åŠ 
    op.alter_column('workflows', 'version', nullable=False)

def downgrade() -> None:
    # NOT NULLåˆ¶ç´„ã‚’å‰Šé™¤
    op.alter_column('workflows', 'version', nullable=True)
```

### 3.8.3 ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®è¿½åŠ 

ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„ã®ãŸã‚ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¿½åŠ :

```bash
uv run alembic revision -m "add performance indexes"
```

```python
def upgrade() -> None:
    # è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
    op.create_index(
        'idx_workflow_tenant_app',
        'workflows',
        ['tenant_id', 'app_id']
    )

    # éƒ¨åˆ†ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
    op.execute("""
        CREATE INDEX idx_workflow_active
        ON workflows (tenant_id)
        WHERE version = 'draft'
    """)

def downgrade() -> None:
    op.drop_index('idx_workflow_tenant_app', table_name='workflows')
    op.execute("DROP INDEX IF EXISTS idx_workflow_active")
```

## 3.9 å®Ÿéš›ã®Difyãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã®æ§‹é€ 

Difyã®å®Ÿéš›ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã¯ä»¥ä¸‹ã®æ§‹é€ :

```bash
api/migrations/versions/
â”œâ”€â”€ 2024_08_09_0801-1787fbae959a_update_tools_original_url_length.py
â”œâ”€â”€ 2024_08_13_0633-63a83fcf12ba_support_conversation_variables.py
â”œâ”€â”€ 2024_08_14_1354-8782057ff0dc_add_conversations_dialogue_count.py
â””â”€â”€ ... (150+ migration files)
```

**ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹**: [api/migrations/versions/](api/migrations/versions/)

å„ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã¯ä»¥ä¸‹ã®ãƒ‘ã‚¿ãƒ¼ãƒ³:
- **æ—¥æ™‚**: `YYYY_MM_DD_HHMM`
- **ãƒªãƒ“ã‚¸ãƒ§ãƒ³ID**: `1787fbae959a`
- **èª¬æ˜**: `update_tools_original_url_length`

## 3.10 å‹•ä½œç¢ºèª

### 3.10.1 ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¸ã®æ¥ç¶šç¢ºèª

```bash
# PostgreSQLã«æ¥ç¶š
psql -h localhost -U postgres -d dify

# ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§ã‚’ç¢ºèª
\dt

# å‡ºåŠ›ä¾‹:
#              List of relations
#  Schema |        Name         | Type  |  Owner
# --------+---------------------+-------+----------
#  public | accounts            | table | postgres
#  public | alembic_version     | table | postgres
#  public | datasets            | table | postgres
#  public | tenant_account_joins| table | postgres
#  public | tenants             | table | postgres
#  public | workflows           | table | postgres

# ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ ã‚’ç¢ºèª
\d accounts

# ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ç¢ºèª
\di
```

### 3.10.2 Pythonã‹ã‚‰ã®æ¥ç¶šç¢ºèª

```python
# api/test_db.py
from extensions.ext_database import db
from models.account import Account, Tenant, TenantAccountJoin
from models.workflow import Workflow
from models.dataset import Dataset
from flask import Flask
from configs.db_config import DatabaseConfig

# Flaskã‚¢ãƒ—ãƒªåˆæœŸåŒ–
app = Flask(__name__)
db_config = DatabaseConfig()
app.config['SQLALCHEMY_DATABASE_URI'] = db_config.SQLALCHEMY_DATABASE_URI
app.config['SQLALCHEMY_ENGINE_OPTIONS'] = {
    'pool_size': 10,
    'pool_recycle': 3600,
}

db.init_app(app)

with app.app_context():
    # ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ä½œæˆ
    tenant = Tenant(name="Test Company")
    db.session.add(tenant)
    db.session.commit()

    print(f"Created tenant: {tenant.id}")

    # ã‚¯ã‚¨ãƒªãƒ†ã‚¹ãƒˆ
    tenants = db.session.query(Tenant).all()
    for t in tenants:
        print(f"Tenant: {t.name} (ID: {t.id})")
```

å®Ÿè¡Œ:

```bash
cd api
uv run python test_db.py

# å‡ºåŠ›ä¾‹:
# Created tenant: 550e8400-e29b-41d4-a716-446655440000
# Tenant: Test Company (ID: 550e8400-e29b-41d4-a716-446655440000)
```

## 3.11 ã¾ã¨ã‚

ã“ã®ç« ã§ã¯ã€ä»¥ä¸‹ã‚’å®Ÿè£…ã—ã¾ã—ãŸ:

âœ… **Domain-Driven Design (DDD) ã®ç†è§£**
- ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã€å€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã€é›†ç´„ã€ãƒªãƒã‚¸ãƒˆãƒªã€ã‚µãƒ¼ãƒ“ã‚¹ã®æ¦‚å¿µ

âœ… **ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®è¨­è¨ˆ**
- Tenant, Account, TenantAccountJoin ãƒ¢ãƒ‡ãƒ«
- Row-Level Isolation ã«ã‚ˆã‚‹åˆ†é›¢

âœ… **SQLAlchemy 2.0 ãƒ¢ãƒ‡ãƒ«ã®å®Ÿè£…**
- Base ã‚¯ãƒ©ã‚¹ã¨ TypeBase
- Workflow, Dataset, Document ãƒ¢ãƒ‡ãƒ«
- ã‚«ã‚¹ã‚¿ãƒ å‹ (StringUUID, AdjustedJSON)

âœ… **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã®è¨­å®š**
- ext_database.py
- db_config.py

âœ… **Alembicãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—**
- åˆæœŸåŒ–ã¨è¨­å®š
- ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®è‡ªå‹•ç”Ÿæˆ
- ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰/ãƒ€ã‚¦ãƒ³ã‚°ãƒ¬ãƒ¼ãƒ‰

âœ… **å®Ÿè·µçš„ãªãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç®¡ç†**
- æ–°ã—ã„ãƒ¢ãƒ‡ãƒ«ã®è¿½åŠ 
- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®è¿½åŠ 
- ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ§‹é€ 

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Tenant    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚TenantAccountJoin â”‚â—„â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚   Account   â”‚
â”‚  (çµ„ç¹”)     â”‚  1:N    â”‚  (å¤šå¯¾å¤š)       â”‚  N:1    â”‚  (ãƒ¦ãƒ¼ã‚¶ãƒ¼) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚                                                       â”‚
      â”‚ 1:N                                                   â”‚ 1:N
      â–¼                                                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Workflow   â”‚         â”‚   Dataset   â”‚         â”‚     App     â”‚
â”‚(ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼)â”‚         â”‚(çŸ¥è­˜ãƒ™ãƒ¼ã‚¹)â”‚         â”‚(ã‚¢ãƒ—ãƒª)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚ 1:N
                               â–¼
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚  Document   â”‚
                        â”‚(ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ)â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### é‡è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹

- [api/models/base.py](api/models/base.py) - Base ã‚¯ãƒ©ã‚¹
- [api/models/account.py](api/models/account.py) - Account, Tenant ãƒ¢ãƒ‡ãƒ«
- [api/models/workflow.py](api/models/workflow.py) - Workflow ãƒ¢ãƒ‡ãƒ«
- [api/models/dataset.py](api/models/dataset.py) - Dataset, Document ãƒ¢ãƒ‡ãƒ«
- [api/migrations/env.py](api/migrations/env.py) - ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç’°å¢ƒ
- [api/migrations/alembic.ini](api/migrations/alembic.ini) - Alembicè¨­å®š

### æ¬¡ã®ç« ã¸

æ¬¡ã®ç¬¬4ç« ã§ã¯ã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®åŸºç›¤æ§‹ç¯‰ã‚’è¡Œã„ã¾ã™ã€‚Flaskã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®åˆæœŸåŒ–ã€DDDå±¤ã®å®Ÿè£…(Domain, Infrastructure, Application, Presentationå±¤)ã€è¨­å®šç®¡ç†ã€ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

---

# ç¬¬4ç« : ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰åŸºç›¤æ§‹ç¯‰

ã“ã®ç« ã§ã¯ã€Flaskã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®åˆæœŸåŒ–ã¨DDDå±¤ã®å®Ÿè£…ã‚’è¡Œã„ã¾ã™ã€‚Clean Architectureã®åŸå‰‡ã«å¾“ã£ã¦ã€Domainå±¤ã€Infrastructureå±¤ã€Applicationå±¤ã€Presentationå±¤ã‚’å®Ÿè£…ã—ã€ä¿å®ˆæ€§ã¨æ‹¡å¼µæ€§ã®é«˜ã„ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚

## 4.1 Clean Architectureã®æ¦‚è¦

### 4.1.1 Clean Architectureã¨ã¯

Clean Architectureã¯ã€ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã®æ§‹é€ ã‚’éšå±¤åŒ–ã—ã€ä¾å­˜é–¢ä¿‚ã‚’ä¸€æ–¹å‘ã«ã™ã‚‹ã“ã¨ã§ã€ãƒ†ã‚¹ã‚¿ãƒ“ãƒªãƒ†ã‚£ã¨ä¿å®ˆæ€§ã‚’å‘ä¸Šã•ã›ã‚‹è¨­è¨ˆãƒ‘ã‚¿ãƒ¼ãƒ³ã§ã™ã€‚

**4ã¤ã®å±¤**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Presentationå±¤ (Controllers)    â”‚  â† å¤–å´
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚     Applicationå±¤ (Services)        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚     Infrastructureå±¤ (Repositories) â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚     Domainå±¤ (Entities)             â”‚  â† ä¸­å¿ƒ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¾å­˜ã®æ–¹å‘**: å¤–å´ â†’ å†…å´ (ä¸€æ–¹å‘ã®ã¿)

### 4.1.2 å„å±¤ã®è²¬å‹™

**Domainå±¤ (ãƒ‰ãƒ¡ã‚¤ãƒ³å±¤)**
- ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã¨å€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å®šç¾©
- ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«ã®å®Ÿè£…
- ä»–ã®å±¤ã«ä¾å­˜ã—ãªã„
- ä¾‹: Account, Workflow, Dataset ãƒ¢ãƒ‡ãƒ«

**Infrastructureå±¤ (ã‚¤ãƒ³ãƒ•ãƒ©å±¤)**
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¢ã‚¯ã‚»ã‚¹ (Repository)
- å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã¨ã®é€£æº
- å…·ä½“çš„ãªå®Ÿè£…ã®è©³ç´°
- ä¾‹: AccountRepository, WorkflowRepository

**Applicationå±¤ (ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å±¤)**
- ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã®ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
- ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã®å®Ÿè£…
- ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ç®¡ç†
- ä¾‹: AppService, WorkflowService

**Presentationå±¤ (ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³å±¤)**
- HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆ/ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®å‡¦ç†
- å…¥åŠ›ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
- ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³
- ä¾‹: AppController, WorkflowController

## 4.2 Flaskã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®åˆæœŸåŒ–

### 4.2.1 Application Factoryãƒ‘ã‚¿ãƒ¼ãƒ³

Application Factoryãƒ‘ã‚¿ãƒ¼ãƒ³ã¯ã€Flaskã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’é–¢æ•°å†…ã§ç”Ÿæˆã™ã‚‹ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³ã§ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ãƒ†ã‚¹ã‚¿ãƒ“ãƒªãƒ†ã‚£ãŒå‘ä¸Šã—ã€è¤‡æ•°ã®è¨­å®šã§ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’èµ·å‹•ã§ãã¾ã™ã€‚

Difyã§ã¯[api/app_factory.py](api/app_factory.py)ã§ã“ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚

**ä¸»è¦ãªåˆ©ç‚¹**:
- **ãƒ†ã‚¹ã‚¿ãƒ“ãƒªãƒ†ã‚£**: ç•°ãªã‚‹è¨­å®šã§è¤‡æ•°ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç”Ÿæˆå¯èƒ½
- **å¾ªç’°ã‚¤ãƒ³ãƒãƒ¼ãƒˆå›é¿**: é…å»¶åˆæœŸåŒ–ã«ã‚ˆã‚Šå¾ªç’°ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚’é˜²ã
- **è¨­å®šã®æŸ”è»Ÿæ€§**: ç’°å¢ƒã”ã¨ã«ç•°ãªã‚‹è¨­å®šã‚’é©ç”¨å¯èƒ½

### 4.2.2 DifyAppã‚¯ãƒ©ã‚¹ã®å®Ÿè£…

ã¾ãšã€ã‚«ã‚¹ã‚¿ãƒ Flaskã‚¯ãƒ©ã‚¹ã‚’ä½œæˆã—ã¾ã™ã€‚

**api/dify_app.py** ã‚’ä½œæˆ:

```python
"""
Custom Flask application class for Dify.
"""
from flask import Flask


class DifyApp(Flask):
    """
    Custom Flask application with Dify-specific extensions.

    This class extends Flask to add custom behaviors needed by Dify,
    such as custom error handling, request hooks, and configuration management.
    """

    pass  # åŸºæœ¬çš„ã«ã¯Flaskã‚’ç¶™æ‰¿ã™ã‚‹ã ã‘ã§ã€å¿…è¦ã«å¿œã˜ã¦ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º
```

### 4.2.3 Application Factoryã®å®Ÿè£…

**api/app_factory.py** ã‚’ä½œæˆ:

```python
"""
Application factory for creating Flask app instances.
"""
import logging
from typing import Any

from dify_app import DifyApp
from configs import dify_config

logger = logging.getLogger(__name__)


def create_flask_app_with_configs() -> DifyApp:
    """
    Create Flask application with configurations loaded from DifyConfig.

    Returns:
        DifyApp: Configured Flask application instance
    """
    # Create DifyApp instance
    dify_app = DifyApp(__name__)

    # Load configurations from Pydantic settings
    # dify_config.model_dump() converts Pydantic model to dict
    dify_app.config.from_mapping(dify_config.model_dump())

    return dify_app


def create_app() -> DifyApp:
    """
    Main application factory function.

    This function:
    1. Creates Flask app with configs
    2. Initializes all extensions (database, redis, celery, etc.)
    3. Registers blueprints (API routes)
    4. Sets up error handlers and logging

    Returns:
        DifyApp: Fully initialized application
    """
    # Step 1: Create app with configs
    app = create_flask_app_with_configs()

    # Step 2: Initialize extensions
    initialize_extensions(app)

    # Step 3: Register blueprints
    register_blueprints(app)

    # Step 4: Setup error handlers
    register_error_handlers(app)

    logger.info("Dify application created successfully")

    return app


def initialize_extensions(app: DifyApp) -> None:
    """
    Initialize Flask extensions.

    Args:
        app: Flask application instance
    """
    # Import extensions (avoid circular imports)
    from extensions import (
        ext_database,
        ext_redis,
        ext_celery,
        ext_migrate,
        ext_storage,
    )

    # Initialize each extension
    extensions = [
        ext_database,    # SQLAlchemy
        ext_redis,       # Redis client
        ext_celery,      # Celery task queue
        ext_migrate,     # Alembic migrations
        ext_storage,     # File storage (S3, local, etc.)
    ]

    for extension in extensions:
        extension.init_app(app)

    logger.info("Extensions initialized successfully")


def register_blueprints(app: DifyApp) -> None:
    """
    Register Flask blueprints (API routes).

    Args:
        app: Flask application instance
    """
    from controllers.console import console_bp
    from controllers.web import web_bp
    from controllers.service_api import service_api_bp

    # Register blueprints with URL prefixes
    app.register_blueprint(console_bp, url_prefix='/console/api')
    app.register_blueprint(web_bp, url_prefix='/api')
    app.register_blueprint(service_api_bp, url_prefix='/v1')

    logger.info("Blueprints registered successfully")


def register_error_handlers(app: DifyApp) -> None:
    """
    Register global error handlers.

    Args:
        app: Flask application instance
    """
    from werkzeug.exceptions import HTTPException
    from services.errors.base import BaseServiceError

    @app.errorhandler(BaseServiceError)
    def handle_service_error(error: BaseServiceError):
        """Handle custom service errors."""
        return {
            'error': error.__class__.__name__,
            'message': error.description or str(error)
        }, 400

    @app.errorhandler(HTTPException)
    def handle_http_exception(error: HTTPException):
        """Handle HTTP exceptions."""
        return {
            'error': error.name,
            'message': error.description
        }, error.code

    @app.errorhandler(Exception)
    def handle_unexpected_error(error: Exception):
        """Handle unexpected errors."""
        logger.exception("Unexpected error occurred")
        return {
            'error': 'InternalServerError',
            'message': 'An unexpected error occurred'
        }, 500

    logger.info("Error handlers registered successfully")
```

**å®Ÿè¡Œã—ã¦ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’èµ·å‹•**:

```bash
cd api

# ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®š
export FLASK_APP=app_factory:create_app
export FLASK_ENV=development

# Flaskã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’èµ·å‹•
uv run --project . flask run --host 0.0.0.0 --port 5001
```

## 4.3 Domainå±¤ã®å®Ÿè£…

Domainå±¤ã¯ã€ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã®ä¸­æ ¸ã‚’æ‹…ã„ã¾ã™ã€‚ä»–ã®å±¤ã«ä¾å­˜ã›ãšã€ç´”ç²‹ãªãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

### 4.3.1 ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã¨ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯

ç¬¬3ç« ã§ä½œæˆã—ãŸSQLAlchemyãƒ¢ãƒ‡ãƒ«(`Account`, `Workflow`, `Dataset`ãªã©)ãŒDomainå±¤ã®ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã«ç›¸å½“ã—ã¾ã™ã€‚

ã“ã‚Œã‚‰ã®ãƒ¢ãƒ‡ãƒ«ã«**ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯**ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã§ã€Domainå±¤ã‚’å……å®Ÿã•ã›ã¾ã™ã€‚

**api/models/account.py** ã«ãƒ¡ã‚½ãƒƒãƒ‰ã‚’è¿½åŠ :

```python
from sqlalchemy.orm import Mapped, mapped_column
from models.base import TypeBase
from enums import TenantAccountRole

class Account(TypeBase):
    __tablename__ = "accounts"

    id: Mapped[str] = mapped_column(StringUUID, primary_key=True)
    name: Mapped[str] = mapped_column(String(255))
    email: Mapped[str] = mapped_column(String(255), unique=True)
    password_hash: Mapped[str | None] = mapped_column(String(255))

    # ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ãƒ¡ã‚½ãƒƒãƒ‰
    def has_role(self, tenant_id: str, role: TenantAccountRole) -> bool:
        """
        Check if account has a specific role in a tenant.

        Args:
            tenant_id: Tenant ID to check
            role: Role to verify

        Returns:
            True if account has the role, False otherwise
        """
        from models import TenantAccountJoin
        from extensions.ext_database import db

        join = db.session.query(TenantAccountJoin).filter(
            TenantAccountJoin.tenant_id == tenant_id,
            TenantAccountJoin.account_id == self.id,
            TenantAccountJoin.role == role
        ).first()

        return join is not None

    def is_admin_or_owner(self, tenant_id: str) -> bool:
        """
        Check if account is admin or owner of a tenant.

        Args:
            tenant_id: Tenant ID to check

        Returns:
            True if account is admin or owner
        """
        return (
            self.has_role(tenant_id, TenantAccountRole.OWNER) or
            self.has_role(tenant_id, TenantAccountRole.ADMIN)
        )

    def can_edit_app(self, app_id: str) -> bool:
        """
        Check if account has edit permission for an app.

        Args:
            app_id: App ID to check

        Returns:
            True if account can edit the app
        """
        from models import App
        from extensions.ext_database import db

        app = db.session.query(App).filter(App.id == app_id).first()
        if not app:
            return False

        # Owners and admins can edit, editors can edit, normal users cannot
        return (
            self.has_role(app.tenant_id, TenantAccountRole.OWNER) or
            self.has_role(app.tenant_id, TenantAccountRole.ADMIN) or
            self.has_role(app.tenant_id, TenantAccountRole.EDITOR)
        )
```

### 4.3.2 å€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ (Value Objects)

å€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯ã€ä¸å¤‰ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ã™ã€‚ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã¨ã¯ç•°ãªã‚Šã€è­˜åˆ¥å­ã‚’æŒãŸãšã€å€¤ãã®ã‚‚ã®ãŒåŒä¸€æ€§ã‚’è¡¨ã—ã¾ã™ã€‚

**api/core/workflow/entities/workflow_graph.py** ã®ä¾‹:

```python
"""
Workflow graph value object.
"""
from dataclasses import dataclass
from typing import Any


@dataclass(frozen=True)  # frozen=True ã§ä¸å¤‰ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«
class WorkflowGraph:
    """
    Workflow graph representation (immutable value object).

    Attributes:
        nodes: List of workflow nodes
        edges: List of edges connecting nodes
        environment_variables: Environment variables for workflow
    """
    nodes: list[dict[str, Any]]
    edges: list[dict[str, Any]]
    environment_variables: dict[str, Any]

    def get_node_by_id(self, node_id: str) -> dict[str, Any] | None:
        """
        Get node by ID.

        Args:
            node_id: Node ID

        Returns:
            Node dict or None if not found
        """
        for node in self.nodes:
            if node.get('id') == node_id:
                return node
        return None

    def get_edges_from_node(self, node_id: str) -> list[dict[str, Any]]:
        """
        Get all edges originating from a node.

        Args:
            node_id: Source node ID

        Returns:
            List of edges from the node
        """
        return [
            edge for edge in self.edges
            if edge.get('source') == node_id
        ]

    def validate(self) -> bool:
        """
        Validate graph structure.

        Returns:
            True if graph is valid

        Raises:
            ValueError: If graph is invalid
        """
        # Check if all edge sources and targets exist
        node_ids = {node['id'] for node in self.nodes}

        for edge in self.edges:
            source = edge.get('source')
            target = edge.get('target')

            if source not in node_ids:
                raise ValueError(f"Edge source node '{source}' not found")
            if target not in node_ids:
                raise ValueError(f"Edge target node '{target}' not found")

        return True
```

## 4.4 Infrastructureå±¤ã®å®Ÿè£…

Infrastructureå±¤ã¯ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¢ã‚¯ã‚»ã‚¹ã‚„å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã¨ã®é€£æºã‚’æ‹…å½“ã—ã¾ã™ã€‚

### 4.4.1 Repositoryãƒ‘ã‚¿ãƒ¼ãƒ³

Repositoryãƒ‘ã‚¿ãƒ¼ãƒ³ã¯ã€ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã‚’ã‚«ãƒ—ã‚»ãƒ«åŒ–ã—ã€ãƒ‰ãƒ¡ã‚¤ãƒ³å±¤ã‹ã‚‰åˆ†é›¢ã—ã¾ã™ã€‚

**api/repositories/workflow_trigger_log_repository.py** (ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹):

```python
"""
Abstract repository interface for WorkflowTriggerLog.
"""
from abc import ABC, abstractmethod
from collections.abc import Sequence

from models.trigger import WorkflowTriggerLog


class WorkflowTriggerLogRepository(ABC):
    """
    Abstract repository for WorkflowTriggerLog operations.

    This interface defines the contract for all WorkflowTriggerLog repositories.
    Different implementations (SQLAlchemy, MongoDB, etc.) must implement these methods.
    """

    @abstractmethod
    def create(self, trigger_log: WorkflowTriggerLog) -> WorkflowTriggerLog:
        """
        Create a new trigger log entry.

        Args:
            trigger_log: WorkflowTriggerLog instance to create

        Returns:
            Created WorkflowTriggerLog
        """
        pass

    @abstractmethod
    def update(self, trigger_log: WorkflowTriggerLog) -> WorkflowTriggerLog:
        """
        Update an existing trigger log entry.

        Args:
            trigger_log: WorkflowTriggerLog instance to update

        Returns:
            Updated WorkflowTriggerLog
        """
        pass

    @abstractmethod
    def get_by_id(
        self,
        trigger_log_id: str,
        tenant_id: str | None = None
    ) -> WorkflowTriggerLog | None:
        """
        Get a trigger log by its ID.

        Args:
            trigger_log_id: Trigger log ID
            tenant_id: Optional tenant ID for multi-tenant isolation

        Returns:
            WorkflowTriggerLog or None if not found
        """
        pass

    @abstractmethod
    def get_failed_for_retry(
        self,
        tenant_id: str,
        max_retry_count: int = 3,
        limit: int = 100
    ) -> Sequence[WorkflowTriggerLog]:
        """
        Get failed trigger logs eligible for retry.

        Args:
            tenant_id: Tenant ID
            max_retry_count: Maximum retry count
            limit: Maximum number of logs to return

        Returns:
            List of failed WorkflowTriggerLog instances
        """
        pass
```

**api/repositories/sqlalchemy_workflow_trigger_log_repository.py** (SQLAlchemyå®Ÿè£…):

```python
"""
SQLAlchemy implementation of WorkflowTriggerLogRepository.
"""
from collections.abc import Sequence
from datetime import UTC, datetime, timedelta

from sqlalchemy import and_, select
from sqlalchemy.orm import Session

from models.enums import WorkflowTriggerStatus
from models.trigger import WorkflowTriggerLog
from repositories.workflow_trigger_log_repository import WorkflowTriggerLogRepository


class SQLAlchemyWorkflowTriggerLogRepository(WorkflowTriggerLogRepository):
    """
    SQLAlchemy implementation of WorkflowTriggerLogRepository.

    Optimized for large table operations with proper indexing and batch processing.
    """

    def __init__(self, session: Session):
        """
        Initialize repository with SQLAlchemy session.

        Args:
            session: SQLAlchemy database session
        """
        self.session = session

    def create(self, trigger_log: WorkflowTriggerLog) -> WorkflowTriggerLog:
        """Create a new trigger log entry."""
        self.session.add(trigger_log)
        self.session.flush()  # Flush to get ID without committing transaction
        return trigger_log

    def update(self, trigger_log: WorkflowTriggerLog) -> WorkflowTriggerLog:
        """Update an existing trigger log entry."""
        self.session.merge(trigger_log)
        self.session.flush()
        return trigger_log

    def get_by_id(
        self,
        trigger_log_id: str,
        tenant_id: str | None = None
    ) -> WorkflowTriggerLog | None:
        """Get a trigger log by its ID."""
        query = select(WorkflowTriggerLog).where(
            WorkflowTriggerLog.id == trigger_log_id
        )

        # Multi-tenant isolation
        if tenant_id:
            query = query.where(WorkflowTriggerLog.tenant_id == tenant_id)

        return self.session.scalar(query)

    def get_failed_for_retry(
        self,
        tenant_id: str,
        max_retry_count: int = 3,
        limit: int = 100
    ) -> Sequence[WorkflowTriggerLog]:
        """Get failed trigger logs eligible for retry."""
        query = (
            select(WorkflowTriggerLog)
            .where(
                and_(
                    WorkflowTriggerLog.tenant_id == tenant_id,
                    WorkflowTriggerLog.status.in_([
                        WorkflowTriggerStatus.FAILED,
                        WorkflowTriggerStatus.RATE_LIMITED
                    ]),
                    WorkflowTriggerLog.retry_count < max_retry_count,
                )
            )
            .order_by(WorkflowTriggerLog.created_at.asc())
            .limit(limit)
        )

        return list(self.session.scalars(query).all())

    def get_recent_logs(
        self,
        tenant_id: str,
        app_id: str,
        hours: int = 24,
        limit: int = 100,
        offset: int = 0
    ) -> Sequence[WorkflowTriggerLog]:
        """Get recent trigger logs within specified hours."""
        since = datetime.now(UTC) - timedelta(hours=hours)

        query = (
            select(WorkflowTriggerLog)
            .where(
                and_(
                    WorkflowTriggerLog.tenant_id == tenant_id,
                    WorkflowTriggerLog.app_id == app_id,
                    WorkflowTriggerLog.created_at >= since,
                )
            )
            .order_by(WorkflowTriggerLog.created_at.desc())
            .limit(limit)
            .offset(offset)
        )

        return list(self.session.scalars(query).all())
```

### 4.4.2 Repository Factoryãƒ‘ã‚¿ãƒ¼ãƒ³

è¤‡æ•°ã®å®Ÿè£…ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‰ã‚Œã‚‹ã‚ˆã†ã«ã€Factoryãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

**api/repositories/factory.py**:

```python
"""
Repository factory for creating repository instances.
"""
from sqlalchemy.orm import Session, sessionmaker

from repositories.sqlalchemy_workflow_trigger_log_repository import (
    SQLAlchemyWorkflowTriggerLogRepository
)
from repositories.workflow_trigger_log_repository import WorkflowTriggerLogRepository


class DifyAPIRepositoryFactory:
    """
    Factory for creating repository instances.

    This factory allows easy switching between different repository implementations
    (e.g., SQLAlchemy, MongoDB) without changing business logic.
    """

    @staticmethod
    def create_workflow_trigger_log_repository(
        session_maker: sessionmaker
    ) -> WorkflowTriggerLogRepository:
        """
        Create WorkflowTriggerLogRepository instance.

        Args:
            session_maker: SQLAlchemy session maker

        Returns:
            WorkflowTriggerLogRepository implementation
        """
        session: Session = session_maker()
        return SQLAlchemyWorkflowTriggerLogRepository(session)
```

## 4.5 Applicationå±¤ã®å®Ÿè£…

Applicationå±¤ã¯ã€ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã‚’ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã—ã€ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

### 4.5.1 Serviceã‚¯ãƒ©ã‚¹ã®å®Ÿè£…

Serviceã‚¯ãƒ©ã‚¹ã¯ã€è¤‡æ•°ã®ãƒªãƒã‚¸ãƒˆãƒªã‚„ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’çµ„ã¿åˆã‚ã›ã¦ã€ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

**api/services/workflow_service.py**:

```python
"""
Workflow service for orchestrating workflow operations.
"""
import logging
from sqlalchemy import exists, select
from sqlalchemy.orm import Session, sessionmaker

from models import App, Workflow, Account
from models.workflow import WorkflowType
from extensions.ext_database import db
from services.errors.workflow_service import (
    DraftWorkflowDeletionError,
    WorkflowInUseError
)

logger = logging.getLogger(__name__)


class WorkflowService:
    """
    Workflow Service for managing workflow lifecycle.

    This service handles:
    - Workflow creation and updates
    - Draft and published workflow management
    - Workflow validation
    - Transaction management
    """

    def __init__(self, session_maker: sessionmaker | None = None):
        """
        Initialize WorkflowService with repository dependencies.

        Args:
            session_maker: SQLAlchemy session maker (optional)
        """
        if session_maker is None:
            session_maker = sessionmaker(
                bind=db.engine,
                expire_on_commit=False
            )
        self.session_maker = session_maker

    def is_workflow_exist(self, app_model: App) -> bool:
        """
        Check if a draft workflow exists for the app.

        Args:
            app_model: App instance

        Returns:
            True if draft workflow exists
        """
        stmt = select(
            exists().where(
                Workflow.tenant_id == app_model.tenant_id,
                Workflow.app_id == app_model.id,
                Workflow.version == Workflow.VERSION_DRAFT,
            )
        )
        return db.session.execute(stmt).scalar_one()

    def get_draft_workflow(
        self,
        app_model: App,
        workflow_id: str | None = None
    ) -> Workflow | None:
        """
        Get draft workflow for an app.

        Args:
            app_model: App instance
            workflow_id: Optional workflow ID (for published workflows)

        Returns:
            Workflow instance or None
        """
        if workflow_id:
            return self.get_published_workflow_by_id(app_model, workflow_id)

        # Fetch draft workflow by app_model
        workflow = (
            db.session.query(Workflow)
            .where(
                Workflow.tenant_id == app_model.tenant_id,
                Workflow.app_id == app_model.id,
                Workflow.version == Workflow.VERSION_DRAFT,
            )
            .first()
        )

        return workflow

    def create_draft_workflow(
        self,
        app_model: App,
        graph: dict,
        account: Account
    ) -> Workflow:
        """
        Create a new draft workflow.

        Args:
            app_model: App instance
            graph: Workflow graph structure
            account: Account creating the workflow

        Returns:
            Created Workflow instance

        Raises:
            ValueError: If draft workflow already exists
        """
        # Check if draft already exists
        if self.is_workflow_exist(app_model):
            raise ValueError(
                f"Draft workflow already exists for app {app_model.id}"
            )

        # Create new workflow
        workflow = Workflow(
            tenant_id=app_model.tenant_id,
            app_id=app_model.id,
            type=WorkflowType.WORKFLOW,
            version=Workflow.VERSION_DRAFT,
            graph=json.dumps(graph),
            created_by=account.id,
        )

        # Add to session and commit
        db.session.add(workflow)
        db.session.commit()

        logger.info(
            f"Created draft workflow {workflow.id} for app {app_model.id}"
        )

        return workflow

    def update_draft_workflow(
        self,
        app_model: App,
        graph: dict,
        account: Account
    ) -> Workflow:
        """
        Update draft workflow.

        Args:
            app_model: App instance
            graph: Updated workflow graph
            account: Account updating the workflow

        Returns:
            Updated Workflow instance

        Raises:
            ValueError: If draft workflow doesn't exist
        """
        workflow = self.get_draft_workflow(app_model)

        if not workflow:
            raise ValueError(
                f"Draft workflow not found for app {app_model.id}"
            )

        # Update workflow
        workflow.graph = json.dumps(graph)
        workflow.updated_by = account.id
        workflow.updated_at = datetime.now(UTC)

        # Commit changes
        db.session.commit()

        logger.info(
            f"Updated draft workflow {workflow.id} for app {app_model.id}"
        )

        return workflow

    def publish_workflow(
        self,
        app_model: App,
        account: Account
    ) -> Workflow:
        """
        Publish draft workflow (create a new published version).

        Args:
            app_model: App instance
            account: Account publishing the workflow

        Returns:
            Published Workflow instance

        Raises:
            ValueError: If draft workflow doesn't exist
        """
        draft = self.get_draft_workflow(app_model)

        if not draft:
            raise ValueError(
                f"Draft workflow not found for app {app_model.id}"
            )

        # Create published version
        published_workflow = Workflow(
            tenant_id=app_model.tenant_id,
            app_id=app_model.id,
            type=draft.type,
            version=self._generate_version_number(),
            graph=draft.graph,
            created_by=account.id,
        )

        # Add to session
        db.session.add(published_workflow)

        # Update app's workflow_id to point to published version
        app_model.workflow_id = published_workflow.id

        # Commit transaction
        db.session.commit()

        logger.info(
            f"Published workflow {published_workflow.id} "
            f"(version {published_workflow.version}) for app {app_model.id}"
        )

        return published_workflow

    def _generate_version_number(self) -> str:
        """
        Generate version number for published workflow.

        Returns:
            Version string (e.g., "v1", "v2")
        """
        # Simple version generation (in production, you'd query existing versions)
        from datetime import datetime
        return f"v{int(datetime.now(UTC).timestamp())}"
```

### 4.5.2 ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ç®¡ç†

Serviceã‚¯ãƒ©ã‚¹ã§ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å¢ƒç•Œã‚’ç®¡ç†ã—ã¾ã™ã€‚

```python
from functools import wraps
from extensions.ext_database import db


def transactional(func):
    """
    Decorator for transactional service methods.

    Automatically commits on success, rollbacks on exception.
    """
    @wraps(func)
    def wrapper(*args, **kwargs):
        try:
            result = func(*args, **kwargs)
            db.session.commit()
            return result
        except Exception as e:
            db.session.rollback()
            logger.exception(f"Transaction failed in {func.__name__}")
            raise

    return wrapper


# ä½¿ç”¨ä¾‹
class WorkflowService:
    @transactional
    def create_draft_workflow(self, app_model: App, graph: dict, account: Account) -> Workflow:
        # ... å®Ÿè£… ...
        pass
```

## 4.6 Presentationå±¤ã®å®Ÿè£…

Presentationå±¤ã¯ã€HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã¨ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å‡¦ç†ã—ã¾ã™ã€‚

### 4.6.1 Flask-RESTXã«ã‚ˆã‚‹ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼

Difyã§ã¯[Flask-RESTX](https://flask-restx.readthedocs.io/)ã‚’ä½¿ç”¨ã—ã¦RESTful APIã‚’æ§‹ç¯‰ã—ã¦ã„ã¾ã™ã€‚

**api/controllers/console/app/app.py**:

```python
"""
App management API controllers.
"""
import uuid
from flask_restx import Resource, fields, inputs, reqparse
from werkzeug.exceptions import abort

from controllers.console import console_ns
from controllers.console.wraps import (
    login_required,
    account_initialization_required,
    setup_required,
)
from libs.login import current_account_with_tenant
from services.app_service import AppService
from models import App

# Initialize service
app_service = AppService()

# Define response models for Swagger documentation
app_partial_model = console_ns.model(
    "AppPartial",
    {
        "id": fields.String(description="App ID"),
        "name": fields.String(description="App name"),
        "description": fields.String(description="App description"),
        "mode": fields.String(description="App mode (workflow, chat, etc.)"),
        "icon": fields.String(description="App icon"),
        "icon_background": fields.String(description="Icon background color"),
        "created_at": fields.Integer(description="Creation timestamp"),
        "updated_at": fields.Integer(description="Update timestamp"),
    },
)

app_pagination_model = console_ns.model(
    "AppPagination",
    {
        "page": fields.Integer(description="Current page number"),
        "limit": fields.Integer(description="Items per page"),
        "total": fields.Integer(description="Total items"),
        "has_more": fields.Boolean(description="Has more pages"),
        "data": fields.List(
            fields.Nested(app_partial_model),
            description="List of apps"
        ),
    },
)


@console_ns.route("/apps")
class AppListApi(Resource):
    """
    App list API endpoint.

    Handles:
    - GET: List apps with pagination and filtering
    - POST: Create new app
    """

    @console_ns.doc("list_apps")
    @console_ns.doc(description="Get list of applications with pagination")
    @console_ns.expect(
        console_ns.parser()
        .add_argument(
            "page",
            type=int,
            location="args",
            default=1,
            help="Page number (1-99999)"
        )
        .add_argument(
            "limit",
            type=int,
            location="args",
            default=20,
            help="Items per page (1-100)"
        )
        .add_argument(
            "mode",
            type=str,
            location="args",
            choices=["completion", "chat", "workflow", "all"],
            default="all",
            help="Filter by app mode"
        )
        .add_argument(
            "name",
            type=str,
            location="args",
            help="Filter by app name"
        )
    )
    @console_ns.response(200, "Success", app_pagination_model)
    @setup_required
    @login_required
    @account_initialization_required
    def get(self):
        """
        Get app list with pagination and filtering.

        Query Parameters:
            - page: Page number (default: 1)
            - limit: Items per page (default: 20)
            - mode: App mode filter (default: "all")
            - name: App name filter (optional)

        Returns:
            Paginated list of apps
        """
        # Get current user and tenant
        current_user, current_tenant_id = current_account_with_tenant()

        # Parse request arguments
        parser = (
            reqparse.RequestParser()
            .add_argument(
                "page",
                type=inputs.int_range(1, 99999),
                default=1,
                location="args"
            )
            .add_argument(
                "limit",
                type=inputs.int_range(1, 100),
                default=20,
                location="args"
            )
            .add_argument(
                "mode",
                type=str,
                choices=["completion", "chat", "workflow", "all"],
                default="all",
                location="args"
            )
            .add_argument(
                "name",
                type=str,
                location="args"
            )
        )
        args = parser.parse_args()

        # Call service layer
        paginated_apps = app_service.get_paginated_apps(
            tenant_id=current_tenant_id,
            account_id=current_user.id,
            page=args["page"],
            limit=args["limit"],
            mode=args["mode"] if args["mode"] != "all" else None,
            name=args.get("name")
        )

        return paginated_apps

    @console_ns.doc("create_app")
    @console_ns.doc(description="Create a new application")
    @console_ns.expect(
        console_ns.model("AppCreate", {
            "name": fields.String(required=True, description="App name"),
            "mode": fields.String(
                required=True,
                description="App mode",
                enum=["workflow", "chat", "completion"]
            ),
            "description": fields.String(description="App description"),
            "icon": fields.String(description="App icon"),
            "icon_background": fields.String(description="Icon background"),
        })
    )
    @console_ns.response(201, "Created", app_partial_model)
    @setup_required
    @login_required
    @account_initialization_required
    def post(self):
        """
        Create a new app.

        Request Body:
            - name: App name (required)
            - mode: App mode (required)
            - description: App description (optional)
            - icon: App icon (optional)
            - icon_background: Icon background color (optional)

        Returns:
            Created app details
        """
        # Get current user and tenant
        current_user, current_tenant_id = current_account_with_tenant()

        # Parse request body
        parser = reqparse.RequestParser()
        parser.add_argument("name", type=str, required=True, location="json")
        parser.add_argument(
            "mode",
            type=str,
            required=True,
            choices=["workflow", "chat", "completion"],
            location="json"
        )
        parser.add_argument("description", type=str, location="json")
        parser.add_argument("icon", type=str, location="json")
        parser.add_argument("icon_background", type=str, location="json")

        args = parser.parse_args()

        # Call service layer to create app
        app = app_service.create_app(
            tenant_id=current_tenant_id,
            account=current_user,
            name=args["name"],
            mode=args["mode"],
            description=args.get("description", ""),
            icon=args.get("icon", ""),
            icon_background=args.get("icon_background", "")
        )

        return app, 201


@console_ns.route("/apps/<uuid:app_id>")
class AppApi(Resource):
    """
    Individual app API endpoint.

    Handles:
    - GET: Get app details
    - PUT: Update app
    - DELETE: Delete app
    """

    @console_ns.doc("get_app")
    @console_ns.response(200, "Success", app_partial_model)
    @setup_required
    @login_required
    @account_initialization_required
    def get(self, app_id: uuid.UUID):
        """
        Get app details by ID.

        Path Parameters:
            - app_id: App UUID

        Returns:
            App details
        """
        current_user, current_tenant_id = current_account_with_tenant()

        app = app_service.get_app(
            tenant_id=current_tenant_id,
            app_id=str(app_id)
        )

        if not app:
            abort(404, description="App not found")

        return app

    @console_ns.doc("delete_app")
    @console_ns.response(204, "Deleted")
    @setup_required
    @login_required
    @account_initialization_required
    def delete(self, app_id: uuid.UUID):
        """
        Delete an app.

        Path Parameters:
            - app_id: App UUID

        Returns:
            204 No Content on success
        """
        current_user, current_tenant_id = current_account_with_tenant()

        app_service.delete_app(
            tenant_id=current_tenant_id,
            app_id=str(app_id),
            account=current_user
        )

        return "", 204
```

### 4.6.2 ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ã«ã‚ˆã‚‹èªè¨¼ãƒ»èªå¯

**api/controllers/console/wraps.py**:

```python
"""
Decorators for authentication and authorization.
"""
from functools import wraps
from flask import request
from werkzeug.exceptions import Unauthorized, Forbidden

from libs.login import current_account_with_tenant
from models import Account


def login_required(func):
    """
    Decorator to require authentication.

    Raises:
        Unauthorized: If user is not authenticated
    """
    @wraps(func)
    def wrapper(*args, **kwargs):
        if not current_account_with_tenant():
            raise Unauthorized("Authentication required")
        return func(*args, **kwargs)

    return wrapper


def account_initialization_required(func):
    """
    Decorator to require account initialization.

    Raises:
        Forbidden: If account is not initialized
    """
    @wraps(func)
    def wrapper(*args, **kwargs):
        account, _ = current_account_with_tenant()

        if not account.initialized_at:
            raise Forbidden("Account initialization required")

        return func(*args, **kwargs)

    return wrapper


def setup_required(func):
    """
    Decorator to require system setup.

    Raises:
        Forbidden: If system is not set up
    """
    @wraps(func)
    def wrapper(*args, **kwargs):
        # Check if system setup is complete
        # (implementation depends on your setup logic)
        return func(*args, **kwargs)

    return wrapper
```

## 4.7 ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

### 4.7.1 ã‚«ã‚¹ã‚¿ãƒ ä¾‹å¤–ã‚¯ãƒ©ã‚¹

**api/services/errors/base.py**:

```python
"""
Base service error classes.
"""

class BaseServiceError(ValueError):
    """
    Base class for all service-layer errors.

    Attributes:
        description: Human-readable error description
    """

    def __init__(self, description: str | None = None):
        self.description = description
        super().__init__(description)
```

**api/services/errors/app.py**:

```python
"""
App-specific service errors.
"""
from services.errors.base import BaseServiceError


class WorkflowHashNotEqualError(BaseServiceError):
    """Raised when workflow hash doesn't match expected value."""
    pass


class IsDraftWorkflowError(BaseServiceError):
    """Raised when attempting to use a draft workflow in production context."""
    pass


class WorkflowNotFoundError(BaseServiceError):
    """Raised when workflow is not found."""
    pass


class QuotaExceededError(BaseServiceError):
    """
    Raised when billing quota is exceeded for a feature.

    Attributes:
        feature: Feature name
        tenant_id: Tenant ID
        required: Required quota amount
    """

    def __init__(self, feature: str, tenant_id: str, required: int):
        self.feature = feature
        self.tenant_id = tenant_id
        self.required = required
        super().__init__(
            f"Quota exceeded for feature '{feature}' (tenant: {tenant_id}). "
            f"Required: {required}"
        )


class TriggerNodeLimitExceededError(BaseServiceError):
    """
    Raised when trigger node count exceeds the plan limit.

    Attributes:
        count: Current trigger node count
        limit: Maximum allowed trigger nodes
    """

    def __init__(self, count: int, limit: int):
        self.count = count
        self.limit = limit
        super().__init__(
            f"Trigger node count ({count}) exceeds the limit ({limit}) "
            f"for your subscription plan. Please upgrade your plan or "
            f"reduce the number of trigger nodes."
        )
```

### 4.7.2 ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼

ã™ã§ã«**4.2.3**ã®Application Factoryã§å®Ÿè£…ã—ã¾ã—ãŸãŒã€å†æ²ã—ã¾ã™ã€‚

**api/app_factory.py** (register_error_handlersé–¢æ•°):

```python
def register_error_handlers(app: DifyApp) -> None:
    """
    Register global error handlers.
    """
    from werkzeug.exceptions import HTTPException
    from services.errors.base import BaseServiceError

    @app.errorhandler(BaseServiceError)
    def handle_service_error(error: BaseServiceError):
        """Handle custom service errors."""
        return {
            'error': error.__class__.__name__,
            'message': error.description or str(error)
        }, 400

    @app.errorhandler(HTTPException)
    def handle_http_exception(error: HTTPException):
        """Handle HTTP exceptions."""
        return {
            'error': error.name,
            'message': error.description
        }, error.code or 500

    @app.errorhandler(Exception)
    def handle_unexpected_error(error: Exception):
        """Handle unexpected errors."""
        logger.exception("Unexpected error occurred")
        return {
            'error': 'InternalServerError',
            'message': 'An unexpected error occurred'
        }, 500
```

## 4.8 Pydanticè¨­å®šç®¡ç†

### 4.8.1 Pydantic Settingsã®æ´»ç”¨

Difyã§ã¯[Pydantic Settings](https://docs.pydantic.dev/latest/concepts/pydantic_settings/)ã‚’ä½¿ç”¨ã—ã¦è¨­å®šã‚’ç®¡ç†ã—ã¦ã„ã¾ã™ã€‚

**api/configs/app_config.py** ã®æŠœç²‹:

```python
"""
Main application configuration using Pydantic Settings.
"""
import logging
from pathlib import Path
from typing import Any

from pydantic.fields import FieldInfo
from pydantic_settings import (
    BaseSettings,
    PydanticBaseSettingsSource,
    SettingsConfigDict,
)

from .deploy import DeploymentConfig
from .feature import FeatureConfig
from .middleware import MiddlewareConfig

logger = logging.getLogger(__name__)


class DifyConfig(
    # Deployment configs
    DeploymentConfig,
    # Feature configs
    FeatureConfig,
    # Middleware configs (PostgreSQL, Redis, etc.)
    MiddlewareConfig,
):
    """
    Main Dify configuration class.

    Inherits from multiple config groups:
    - DeploymentConfig: Deployment-related settings
    - FeatureConfig: Feature flags
    - MiddlewareConfig: Database, Redis, Celery settings
    """

    model_config = SettingsConfigDict(
        # Read from .env file
        env_file=".env",
        env_file_encoding="utf-8",
        # Ignore extra attributes in .env
        extra="ignore",
    )


# Singleton instance
dify_config = DifyConfig()
```

**api/configs/middleware/__init__.py**:

```python
"""
Middleware configuration (Database, Redis, Celery, Storage).
"""
from pydantic import Field
from pydantic_settings import BaseSettings


class DatabaseConfig(BaseSettings):
    """Database configuration."""

    DB_USERNAME: str = Field(
        default="postgres",
        description="Database username"
    )

    DB_PASSWORD: str = Field(
        default="",
        description="Database password"
    )

    DB_HOST: str = Field(
        default="localhost",
        description="Database host"
    )

    DB_PORT: int = Field(
        default=5432,
        description="Database port"
    )

    DB_DATABASE: str = Field(
        default="dify",
        description="Database name"
    )

    @property
    def SQLALCHEMY_DATABASE_URI(self) -> str:
        """
        Generate SQLAlchemy database URI.

        Returns:
            Database connection string
        """
        return (
            f"postgresql://{self.DB_USERNAME}:{self.DB_PASSWORD}"
            f"@{self.DB_HOST}:{self.DB_PORT}/{self.DB_DATABASE}"
        )

    SQLALCHEMY_POOL_SIZE: int = Field(
        default=30,
        description="SQLAlchemy connection pool size"
    )

    SQLALCHEMY_POOL_RECYCLE: int = Field(
        default=3600,
        description="Connection recycle time (seconds)"
    )

    SQLALCHEMY_ECHO: bool = Field(
        default=False,
        description="Echo SQL queries (for debugging)"
    )


class RedisConfig(BaseSettings):
    """Redis configuration."""

    REDIS_HOST: str = Field(
        default="localhost",
        description="Redis host"
    )

    REDIS_PORT: int = Field(
        default=6379,
        description="Redis port"
    )

    REDIS_DB: int = Field(
        default=0,
        description="Redis database number"
    )

    REDIS_PASSWORD: str | None = Field(
        default=None,
        description="Redis password (optional)"
    )

    REDIS_USE_SSL: bool = Field(
        default=False,
        description="Use SSL for Redis connection"
    )


class CeleryConfig(BaseSettings):
    """Celery configuration."""

    CELERY_BROKER_URL: str | None = Field(
        default=None,
        description="Celery broker URL (overrides Redis config)"
    )

    @property
    def get_celery_broker_url(self) -> str:
        """
        Get Celery broker URL.

        Returns:
            Celery broker URL (defaults to Redis)
        """
        if self.CELERY_BROKER_URL:
            return self.CELERY_BROKER_URL

        # Use Redis as broker by default
        redis_cfg = RedisConfig()
        password_part = f":{redis_cfg.REDIS_PASSWORD}@" if redis_cfg.REDIS_PASSWORD else ""

        return (
            f"redis://{password_part}{redis_cfg.REDIS_HOST}:"
            f"{redis_cfg.REDIS_PORT}/{redis_cfg.REDIS_DB}"
        )


class MiddlewareConfig(
    DatabaseConfig,
    RedisConfig,
    CeleryConfig,
):
    """
    Combined middleware configuration.

    Includes:
    - DatabaseConfig: PostgreSQL settings
    - RedisConfig: Redis settings
    - CeleryConfig: Celery task queue settings
    """
    pass
```

### 4.8.2 .env ãƒ•ã‚¡ã‚¤ãƒ«ã®è¨­å®šä¾‹

**api/.env**:

```bash
# Database
DB_USERNAME=postgres
DB_PASSWORD=your_password
DB_HOST=localhost
DB_PORT=5432
DB_DATABASE=dify

# Redis
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_DB=0
REDIS_PASSWORD=

# Celery
CELERY_BROKER_URL=redis://localhost:6379/1

# Flask
SECRET_KEY=your-secret-key-here
FLASK_DEBUG=true

# Feature Flags
FEATURE_WORKFLOW_ENABLED=true
FEATURE_DATASET_ENABLED=true
```

## 4.9 ãƒ­ã‚®ãƒ³ã‚°è¨­å®š

### 4.9.1 Python loggingã®è¨­å®š

**api/logging_config.py** ã‚’ä½œæˆ:

```python
"""
Logging configuration for Dify.
"""
import logging
import sys
from logging.handlers import RotatingFileHandler
from pathlib import Path


def setup_logging(app_name: str = "dify", log_level: str = "INFO") -> None:
    """
    Setup application logging.

    Args:
        app_name: Application name for log files
        log_level: Log level (DEBUG, INFO, WARNING, ERROR, CRITICAL)
    """
    # Create logs directory
    log_dir = Path("logs")
    log_dir.mkdir(exist_ok=True)

    # Configure root logger
    root_logger = logging.getLogger()
    root_logger.setLevel(getattr(logging, log_level.upper()))

    # Console handler (stdout)
    console_handler = logging.StreamHandler(sys.stdout)
    console_handler.setLevel(logging.INFO)
    console_formatter = logging.Formatter(
        fmt="%(asctime)s - %(name)s - %(levelname)s - %(message)s",
        datefmt="%Y-%m-%d %H:%M:%S"
    )
    console_handler.setFormatter(console_formatter)

    # File handler (rotating)
    file_handler = RotatingFileHandler(
        filename=log_dir / f"{app_name}.log",
        maxBytes=10 * 1024 * 1024,  # 10 MB
        backupCount=5,
        encoding="utf-8"
    )
    file_handler.setLevel(logging.DEBUG)
    file_formatter = logging.Formatter(
        fmt="%(asctime)s - %(name)s - %(levelname)s - %(pathname)s:%(lineno)d - %(message)s",
        datefmt="%Y-%m-%d %H:%M:%S"
    )
    file_handler.setFormatter(file_formatter)

    # Add handlers
    root_logger.addHandler(console_handler)
    root_logger.addHandler(file_handler)

    # Suppress noisy third-party loggers
    logging.getLogger("werkzeug").setLevel(logging.WARNING)
    logging.getLogger("sqlalchemy.engine").setLevel(logging.WARNING)

    logging.info(f"Logging configured for {app_name} at level {log_level}")
```

**api/app_factory.py** ã«è¿½åŠ :

```python
from logging_config import setup_logging

def create_app() -> DifyApp:
    # Setup logging first
    setup_logging(app_name="dify", log_level="INFO")

    # ... rest of app creation ...
```

## 4.10 å®Ÿè£…ã®ç¢ºèªã¨ãƒ†ã‚¹ãƒˆ

### 4.10.1 ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®èµ·å‹•

```bash
cd api

# ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®š
export FLASK_APP=app_factory:create_app
export FLASK_ENV=development

# Flaskã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’èµ·å‹•
uv run --project . flask run --host 0.0.0.0 --port 5001
```

### 4.10.2 APIã®ãƒ†ã‚¹ãƒˆ

**curlã§ãƒ†ã‚¹ãƒˆ**:

```bash
# Health check (ä»®ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ)
curl http://localhost:5001/health

# App list API (èªè¨¼å¿…è¦)
curl -X GET http://localhost:5001/console/api/apps \
  -H "Authorization: Bearer YOUR_TOKEN"

# Appä½œæˆ API
curl -X POST http://localhost:5001/console/api/apps \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "name": "Test App",
    "mode": "workflow",
    "description": "Test application"
  }'
```

### 4.10.3 ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã®ä¾‹

**api/tests/unit_tests/services/test_workflow_service.py**:

```python
"""
Unit tests for WorkflowService.
"""
import pytest
from unittest.mock import Mock, patch

from models import App, Workflow, Account
from services.workflow_service import WorkflowService


@pytest.fixture
def mock_app():
    """Fixture for mock App."""
    app = Mock(spec=App)
    app.id = "app-123"
    app.tenant_id = "tenant-123"
    return app


@pytest.fixture
def mock_account():
    """Fixture for mock Account."""
    account = Mock(spec=Account)
    account.id = "account-123"
    return account


def test_is_workflow_exist_returns_true_when_exists(mock_app):
    """Test is_workflow_exist returns True when draft exists."""
    service = WorkflowService()

    with patch('services.workflow_service.db.session') as mock_session:
        # Mock query to return True
        mock_session.execute.return_value.scalar_one.return_value = True

        result = service.is_workflow_exist(mock_app)

        assert result is True


def test_is_workflow_exist_returns_false_when_not_exists(mock_app):
    """Test is_workflow_exist returns False when no draft."""
    service = WorkflowService()

    with patch('services.workflow_service.db.session') as mock_session:
        # Mock query to return False
        mock_session.execute.return_value.scalar_one.return_value = False

        result = service.is_workflow_exist(mock_app)

        assert result is False


def test_create_draft_workflow_creates_new_workflow(mock_app, mock_account):
    """Test create_draft_workflow creates a new workflow."""
    service = WorkflowService()
    graph = {"nodes": [], "edges": []}

    with patch.object(service, 'is_workflow_exist', return_value=False):
        with patch('services.workflow_service.db.session') as mock_session:
            workflow = service.create_draft_workflow(
                app_model=mock_app,
                graph=graph,
                account=mock_account
            )

            # Verify workflow was added to session
            mock_session.add.assert_called_once()
            mock_session.commit.assert_called_once()


def test_create_draft_workflow_raises_error_when_exists(mock_app, mock_account):
    """Test create_draft_workflow raises error when draft exists."""
    service = WorkflowService()
    graph = {"nodes": [], "edges": []}

    with patch.object(service, 'is_workflow_exist', return_value=True):
        with pytest.raises(ValueError, match="Draft workflow already exists"):
            service.create_draft_workflow(
                app_model=mock_app,
                graph=graph,
                account=mock_account
            )
```

## 4.11 ã¾ã¨ã‚

ã“ã®ç« ã§ã¯ã€Flaskã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®åŸºç›¤ã¨ãªã‚‹Clean Architectureã®4å±¤(Domain, Infrastructure, Application, Presentation)ã‚’å®Ÿè£…ã—ã¾ã—ãŸã€‚

### å®Ÿè£…ã—ãŸå†…å®¹

âœ… **Application Factory Pattern**
- DifyAppã‚¯ãƒ©ã‚¹ã®ä½œæˆ
- create_app()é–¢æ•°ã«ã‚ˆã‚‹åˆæœŸåŒ–
- æ‹¡å¼µæ©Ÿèƒ½ã®ç™»éŒ²(Database, Redis, Celery)
- Blueprintã®ç™»éŒ²
- ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼

âœ… **Domainå±¤**
- ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã«ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ãƒ¡ã‚½ãƒƒãƒ‰ã‚’è¿½åŠ 
- å€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ(WorkflowGraph)ã®å®Ÿè£…
- ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ«ã®å®Ÿè£…

âœ… **Infrastructureå±¤**
- Repositoryã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã®å®šç¾©
- SQLAlchemyå®Ÿè£…(SQLAlchemyWorkflowTriggerLogRepository)
- Repository Factoryãƒ‘ã‚¿ãƒ¼ãƒ³

âœ… **Applicationå±¤**
- Serviceã‚¯ãƒ©ã‚¹ã®å®Ÿè£…(WorkflowService)
- ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ç®¡ç†
- ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã®ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

âœ… **Presentationå±¤**
- Flask-RESTXã«ã‚ˆã‚‹ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼å®Ÿè£…
- ãƒªã‚¯ã‚¨ã‚¹ãƒˆ/ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®å‡¦ç†
- èªè¨¼ãƒ»èªå¯ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿

âœ… **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**
- ã‚«ã‚¹ã‚¿ãƒ ä¾‹å¤–ã‚¯ãƒ©ã‚¹(BaseServiceError, QuotaExceededErrorç­‰)
- ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼

âœ… **è¨­å®šç®¡ç†**
- Pydantic Settingsã«ã‚ˆã‚‹å‹å®‰å…¨ãªè¨­å®šç®¡ç†
- ç’°å¢ƒå¤‰æ•°ã‹ã‚‰ã®è‡ªå‹•èª­ã¿è¾¼ã¿
- è¨­å®šã®ã‚°ãƒ«ãƒ¼ãƒ—åŒ–(DatabaseConfig, RedisConfigç­‰)

âœ… **ãƒ­ã‚®ãƒ³ã‚°**
- Pythonã®loggingãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«è¨­å®š
- ã‚³ãƒ³ã‚½ãƒ¼ãƒ«å‡ºåŠ›ã¨ãƒ•ã‚¡ã‚¤ãƒ«å‡ºåŠ›
- ãƒ­ãƒ¼ãƒ†ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ãƒãƒ³ãƒ‰ãƒ©ãƒ¼

### ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å›³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Presentationå±¤                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Flask-RESTX Controllers (app.py, workflow.py)          â”‚  â”‚
â”‚  â”‚ - HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆ/ãƒ¬ã‚¹ãƒãƒ³ã‚¹å‡¦ç†                         â”‚  â”‚
â”‚  â”‚ - å…¥åŠ›ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³                                    â”‚  â”‚
â”‚  â”‚ - èªè¨¼ãƒ»èªå¯ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿                                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“ ä¾å­˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Applicationå±¤                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Services (WorkflowService, AppService)                 â”‚  â”‚
â”‚  â”‚ - ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã®å®Ÿè£…                                    â”‚  â”‚
â”‚  â”‚ - ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ç®¡ç†                                  â”‚  â”‚
â”‚  â”‚ - ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã®ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“ ä¾å­˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Infrastructureå±¤                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Repositories (SQLAlchemy implementations)              â”‚  â”‚
â”‚  â”‚ - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¢ã‚¯ã‚»ã‚¹                                  â”‚  â”‚
â”‚  â”‚ - ãƒªãƒã‚¸ãƒˆãƒªãƒ‘ã‚¿ãƒ¼ãƒ³                                    â”‚  â”‚
â”‚  â”‚ - å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹é€£æº                                      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“ ä¾å­˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Domainå±¤                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Entities (Account, Workflow, Dataset)                  â”‚  â”‚
â”‚  â”‚ - ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«                                        â”‚  â”‚
â”‚  â”‚ - å€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ                                        â”‚  â”‚
â”‚  â”‚ - ä»–ã®å±¤ã«ä¾å­˜ã—ãªã„                                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å‚ç…§ãƒ•ã‚¡ã‚¤ãƒ«

ã“ã®ç« ã§å®Ÿè£…ã—ãŸå†…å®¹ã¯ã€ä»¥ä¸‹ã®Difyã®å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‚è€ƒã«ã—ã¦ã„ã¾ã™:

- [api/app_factory.py](api/app_factory.py) - Application Factory
- [api/dify_app.py](api/dify_app.py) - ã‚«ã‚¹ã‚¿ãƒ Flaskã‚¯ãƒ©ã‚¹
- [api/extensions/ext_database.py](api/extensions/ext_database.py) - Databaseæ‹¡å¼µ
- [api/models/account.py](api/models/account.py) - Accountã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£
- [api/repositories/sqlalchemy_workflow_trigger_log_repository.py](api/repositories/sqlalchemy_workflow_trigger_log_repository.py) - Repositoryå®Ÿè£…
- [api/repositories/factory.py](api/repositories/factory.py) - Repository Factory
- [api/services/workflow_service.py](api/services/workflow_service.py) - Workflow Service
- [api/services/app_service.py](api/services/app_service.py) - App Service
- [api/controllers/console/app/app.py](api/controllers/console/app/app.py) - App Controller
- [api/controllers/console/wraps.py](api/controllers/console/wraps.py) - èªè¨¼ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿
- [api/services/errors/base.py](api/services/errors/base.py) - ãƒ™ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼ã‚¯ãƒ©ã‚¹
- [api/services/errors/app.py](api/services/errors/app.py) - ã‚¢ãƒ—ãƒªã‚¨ãƒ©ãƒ¼ã‚¯ãƒ©ã‚¹
- [api/configs/app_config.py](api/configs/app_config.py) - Pydanticè¨­å®š

### æ¬¡ã®ç« ã¸

æ¬¡ã®ç¬¬5ç« ã§ã¯ã€**èªè¨¼ãƒ»èªå¯ã‚·ã‚¹ãƒ†ãƒ **ã‚’å®Ÿè£…ã—ã¾ã™ã€‚JWTèªè¨¼ã€ãƒ­ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡(RBAC)ã€ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆåˆ†é›¢ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã¨Cookieã«ã¤ã„ã¦å­¦ã³ã¾ã™ã€‚

---
# ç¬¬5ç« : èªè¨¼ãƒ»èªå¯ã‚·ã‚¹ãƒ†ãƒ 

ã“ã®ç« ã§ã¯ã€Difyã®èªè¨¼ãƒ»èªå¯ã‚·ã‚¹ãƒ†ãƒ ã‚’å®Ÿè£…ã—ã¾ã™ã€‚JWT(JSON Web Token)ã«ã‚ˆã‚‹èªè¨¼ã€ãƒ­ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡(RBAC)ã€ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆåˆ†é›¢ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã¨Cookieã‚’å­¦ã³ã¾ã™ã€‚

ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¯ç¾ä»£ã®Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ãŠã„ã¦æœ€ã‚‚é‡è¦ãªè¦ç´ ã®ä¸€ã¤ã§ã™ã€‚é©åˆ‡ãªèªè¨¼ãƒ»èªå¯ã‚·ã‚¹ãƒ†ãƒ ãªã—ã«ã¯ã€ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆSaaSã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯æˆç«‹ã—ã¾ã›ã‚“ã€‚

## 5.1 èªè¨¼ã‚·ã‚¹ãƒ†ãƒ ã®æ¦‚è¦

### 5.1.1 èªè¨¼ vs èªå¯

**èªè¨¼(Authentication)**:
- ã€Œã‚ãªãŸã¯èª°ã§ã™ã‹?ã€ã‚’ç¢ºèªã™ã‚‹ãƒ—ãƒ­ã‚»ã‚¹
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®èº«å…ƒã‚’ç¢ºèª
- ä¾‹: ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã®ãƒ¡ãƒ¼ãƒ«/ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèª

**èªå¯(Authorization)**:
- ã€Œã‚ãªãŸã¯ä½•ãŒã§ãã¾ã™ã‹?ã€ã‚’ç¢ºèªã™ã‚‹ãƒ—ãƒ­ã‚»ã‚¹
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ¨©é™ã‚’ç¢ºèª
- ä¾‹: ç®¡ç†è€…ã®ã¿ãŒã‚¢ãƒ—ãƒªã‚’å‰Šé™¤ã§ãã‚‹

### 5.1.2 JWT(JSON Web Token)ã¨ã¯

JWTã¯ã€ä»¥ä¸‹ã®3ã¤ã®éƒ¨åˆ†ã‹ã‚‰æ§‹æˆã•ã‚Œã‚‹ãƒˆãƒ¼ã‚¯ãƒ³ã§ã™:

```
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjoiMTIzIiwiZXhwIjoxNjk5OTk5OTk5fQ.signature
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€headerâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€payloadâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””signatureâ”˜
```

**Header(ãƒ˜ãƒƒãƒ€ãƒ¼)**:
- ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã¨ãƒˆãƒ¼ã‚¯ãƒ³ã‚¿ã‚¤ãƒ—ã‚’æŒ‡å®š
- ä¾‹: `{"alg": "HS256", "typ": "JWT"}`

**Payload(ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰)**:
- ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã¨ã‚¯ãƒ¬ãƒ¼ãƒ (claims)
- ä¾‹: `{"user_id": "123", "exp": 1699999999}`

**Signature(ç½²å)**:
- ãƒ˜ãƒƒãƒ€ãƒ¼ã¨ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’ç§˜å¯†éµã§ç½²å
- ãƒˆãƒ¼ã‚¯ãƒ³ã®æ”¹ã–ã‚“ã‚’é˜²ã

**JWTã®åˆ©ç‚¹**:
- ã‚¹ãƒ†ãƒ¼ãƒˆãƒ¬ã‚¹: ã‚µãƒ¼ãƒãƒ¼å´ã§ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‚’ä¿æŒä¸è¦
- ã‚¹ã‚±ãƒ¼ãƒ©ãƒ–ãƒ«: æ°´å¹³ã‚¹ã‚±ãƒ¼ãƒ«ãŒå®¹æ˜“
- ã‚¯ãƒ­ã‚¹ãƒ‰ãƒ¡ã‚¤ãƒ³å¯¾å¿œ: CORSç’°å¢ƒã§ã‚‚ä½¿ç”¨å¯èƒ½

### 5.1.3 Difyã®èªè¨¼ãƒ•ãƒ­ãƒ¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Client  â”‚                  â”‚  Server  â”‚                â”‚  Redis   â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚                             â”‚                           â”‚
     â”‚  1. POST /login             â”‚                           â”‚
     â”‚  {email, password}          â”‚                           â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                           â”‚
     â”‚                             â”‚                           â”‚
     â”‚                             â”‚  2. Authenticate user     â”‚
     â”‚                             â”‚     (check password)      â”‚
     â”‚                             â”‚                           â”‚
     â”‚                             â”‚  3. Generate JWT tokens   â”‚
     â”‚                             â”‚     - access_token        â”‚
     â”‚                             â”‚     - refresh_token       â”‚
     â”‚                             â”‚     - csrf_token          â”‚
     â”‚                             â”‚                           â”‚
     â”‚                             â”‚  4. Store refresh_token   â”‚
     â”‚                             â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                             â”‚                           â”‚
     â”‚  5. Set tokens in cookies   â”‚                           â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                           â”‚
     â”‚  - access_token (HttpOnly)  â”‚                           â”‚
     â”‚  - refresh_token (HttpOnly) â”‚                           â”‚
     â”‚  - csrf_token               â”‚                           â”‚
     â”‚                             â”‚                           â”‚
     â”‚  6. API request with token  â”‚                           â”‚
     â”‚  Cookie: access_token       â”‚                           â”‚
     â”‚  X-CSRF-Token: csrf_token   â”‚                           â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                           â”‚
     â”‚                             â”‚                           â”‚
     â”‚                             â”‚  7. Verify JWT signature  â”‚
     â”‚                             â”‚     & check CSRF token    â”‚
     â”‚                             â”‚                           â”‚
     â”‚  8. Response                â”‚                           â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                           â”‚
```

## 5.2 ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒã‚·ãƒ¥åŒ–

### 5.2.1 ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®å®‰å…¨ãªä¿å­˜

ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯**çµ¶å¯¾ã«å¹³æ–‡ã§ä¿å­˜ã—ã¦ã¯ã„ã‘ã¾ã›ã‚“**ã€‚Difyã§ã¯`pbkdf2_hmac`ã‚’ä½¿ç”¨ã—ã¦ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒãƒƒã‚·ãƒ¥åŒ–ã—ã¾ã™ã€‚

**api/libs/password.py** ã‚’ä½œæˆ:

```python
"""
Password hashing and validation utilities.
"""
import base64
import hashlib
import re
from typing import Optional


def hash_password(password: str, salt: bytes) -> bytes:
    """
    Hash password using PBKDF2-HMAC-SHA256.

    Args:
        password: Plain text password
        salt: Random salt bytes (16 bytes recommended)

    Returns:
        Hashed password bytes
    """
    # PBKDF2-HMAC with SHA256, 10000 iterations
    dk = hashlib.pbkdf2_hmac(
        hash_name='sha256',
        password=password.encode('utf-8'),
        salt=salt,
        iterations=10000,
        dklen=32  # 32 bytes = 256 bits
    )
    return dk


def compare_password(
    password: str,
    password_hashed_base64: str,
    salt_base64: str
) -> bool:
    """
    Compare password with stored hash.

    Args:
        password: Plain text password to verify
        password_hashed_base64: Base64-encoded stored hash
        salt_base64: Base64-encoded salt

    Returns:
        True if password matches, False otherwise
    """
    # Decode base64 strings
    password_hashed = base64.b64decode(password_hashed_base64)
    salt = base64.b64decode(salt_base64)

    # Hash the input password with the same salt
    dk = hash_password(password, salt)

    # Constant-time comparison to prevent timing attacks
    return dk == password_hashed


def valid_password(password: str) -> None:
    """
    Validate password strength.

    Args:
        password: Password to validate

    Raises:
        ValueError: If password doesn't meet requirements
    """
    if len(password) < 8:
        raise ValueError("Password must be at least 8 characters long")

    if len(password) > 128:
        raise ValueError("Password must not exceed 128 characters")

    # Check for at least one uppercase, one lowercase, and one digit
    if not re.search(r'[A-Z]', password):
        raise ValueError("Password must contain at least one uppercase letter")

    if not re.search(r'[a-z]', password):
        raise ValueError("Password must contain at least one lowercase letter")

    if not re.search(r'\d', password):
        raise ValueError("Password must contain at least one digit")
```

**ä½¿ç”¨ä¾‹**:

```python
import secrets
import base64

# ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒãƒƒã‚·ãƒ¥åŒ–ã—ã¦ä¿å­˜
password = "MySecurePassword123"
salt = secrets.token_bytes(16)  # 16ãƒã‚¤ãƒˆã®ãƒ©ãƒ³ãƒ€ãƒ salt
password_hashed = hash_password(password, salt)

# Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã—ã¦DBã«ä¿å­˜
account.password = base64.b64encode(password_hashed).decode()
account.password_salt = base64.b64encode(salt).decode()

# ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã«ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’æ¤œè¨¼
is_valid = compare_password(
    password="UserInputPassword",
    password_hashed_base64=account.password,
    salt_base64=account.password_salt
)
```

### 5.2.2 ãªãœPBKDF2ã‚’ä½¿ã†ã®ã‹

**PBKDF2ã®ç‰¹å¾´**:
- **åå¾©å‡¦ç†**: 10,000å›ã®åå¾©ã§ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹æ”»æ’ƒã‚’é…å»¶
- **Salt**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã«ç•°ãªã‚‹saltã§ãƒ¬ã‚¤ãƒ³ãƒœãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«æ”»æ’ƒã‚’é˜²æ­¢
- **æ¨™æº–åŒ–**: NISTæ¨å¥¨ã®ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ 

**ä»–ã®é¸æŠè‚¢**:
- bcrypt: ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ãŒå¤šãã€GPUã§ã®ä¸¦åˆ—åŒ–ãŒå›°é›£(ã‚ˆã‚Šå®‰å…¨)
- argon2: æœ€æ–°ã§æœ€ã‚‚æ¨å¥¨ã•ã‚Œã‚‹ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ 
- scrypt: ãƒ¡ãƒ¢ãƒªãƒãƒ¼ãƒ‰ãªã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ 

Difyã§ã¯äº’æ›æ€§ã¨å®Ÿè£…ã®å®¹æ˜“ã•ã‹ã‚‰`pbkdf2_hmac`ã‚’æ¡ç”¨ã—ã¦ã„ã¾ã™ã€‚

## 5.3 JWTèªè¨¼ã®å®Ÿè£…

### 5.3.1 PassportService - JWTç™ºè¡Œã¨æ¤œè¨¼

**api/libs/passport.py**:

```python
"""
JWT token issuance and verification service.
"""
import jwt
from werkzeug.exceptions import Unauthorized

from configs import dify_config


class PassportService:
    """
    Service for issuing and verifying JWT tokens.

    This service handles:
    - JWT token generation with secret key
    - Token verification and decoding
    - Token expiration validation
    """

    def __init__(self):
        """Initialize PassportService with secret key from config."""
        self.sk = dify_config.SECRET_KEY

    def issue(self, payload: dict) -> str:
        """
        Issue a JWT token with given payload.

        Args:
            payload: Dictionary containing token claims
                     (e.g., user_id, exp, iss, sub)

        Returns:
            Encoded JWT token string
        """
        return jwt.encode(payload, self.sk, algorithm="HS256")

    def verify(self, token: str) -> dict:
        """
        Verify and decode JWT token.

        Args:
            token: JWT token string to verify

        Returns:
            Decoded token payload

        Raises:
            Unauthorized: If token is invalid, expired, or signature doesn't match
        """
        try:
            return jwt.decode(token, self.sk, algorithms=["HS256"])
        except jwt.ExpiredSignatureError:
            raise Unauthorized("Token has expired.")
        except jwt.InvalidSignatureError:
            raise Unauthorized("Invalid token signature.")
        except jwt.DecodeError:
            raise Unauthorized("Invalid token.")
        except jwt.PyJWTError:  # Catch-all for other JWT errors
            raise Unauthorized("Invalid token.")
```

### 5.3.2 TokenManager - ãƒˆãƒ¼ã‚¯ãƒ³ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ç®¡ç†

**api/libs/helper.py** ã«TokenManagerã‚’è¿½åŠ :

```python
"""
Token management utilities.
"""
import secrets
from datetime import datetime, timedelta, UTC

from extensions.ext_redis import redis_client


class TokenManager:
    """
    Manage token lifecycle and storage in Redis.

    Handles:
    - Refresh token generation and storage
    - Token revocation
    - Token validation
    """

    REFRESH_TOKEN_PREFIX = "refresh_token:"
    ACCOUNT_REFRESH_TOKEN_PREFIX = "account_refresh_token:"
    REFRESH_TOKEN_EXPIRY_DAYS = 30

    @staticmethod
    def generate_refresh_token() -> str:
        """
        Generate a secure random refresh token.

        Returns:
            32-character hexadecimal token
        """
        return secrets.token_hex(32)

    @staticmethod
    def store_refresh_token(
        refresh_token: str,
        account_id: str,
        expiry_days: int = REFRESH_TOKEN_EXPIRY_DAYS
    ) -> None:
        """
        Store refresh token in Redis with expiration.

        Args:
            refresh_token: Refresh token string
            account_id: Account ID associated with token
            expiry_days: Token expiration in days
        """
        expiry = timedelta(days=expiry_days)

        # Store token -> account_id mapping
        redis_client.setex(
            f"{TokenManager.REFRESH_TOKEN_PREFIX}{refresh_token}",
            expiry,
            account_id
        )

        # Store account_id -> token mapping (for logout)
        redis_client.setex(
            f"{TokenManager.ACCOUNT_REFRESH_TOKEN_PREFIX}{account_id}",
            expiry,
            refresh_token
        )

    @staticmethod
    def get_account_id_by_refresh_token(refresh_token: str) -> str | None:
        """
        Retrieve account ID by refresh token.

        Args:
            refresh_token: Refresh token string

        Returns:
            Account ID if token is valid, None otherwise
        """
        account_id = redis_client.get(
            f"{TokenManager.REFRESH_TOKEN_PREFIX}{refresh_token}"
        )
        return account_id.decode() if account_id else None

    @staticmethod
    def revoke_refresh_token(refresh_token: str, account_id: str) -> None:
        """
        Revoke refresh token (used for logout).

        Args:
            refresh_token: Refresh token to revoke
            account_id: Account ID associated with token
        """
        redis_client.delete(f"{TokenManager.REFRESH_TOKEN_PREFIX}{refresh_token}")
        redis_client.delete(f"{TokenManager.ACCOUNT_REFRESH_TOKEN_PREFIX}{account_id}")
```

### 5.3.3 AccountService - èªè¨¼ãƒ­ã‚¸ãƒƒã‚¯

**api/services/account_service.py** ã®ä¸»è¦ãƒ¡ã‚½ãƒƒãƒ‰:

```python
"""
Account authentication and management service.
"""
import base64
import secrets
from datetime import datetime, timedelta, UTC
from pydantic import BaseModel

from extensions.ext_database import db
from libs.passport import PassportService
from libs.password import hash_password, compare_password
from libs.helper import TokenManager
from models.account import Account, AccountStatus
from services.errors.account import AccountPasswordError, AccountLoginError


class TokenPair(BaseModel):
    """Token pair returned after login."""
    access_token: str
    refresh_token: str
    csrf_token: str


class AccountService:
    """
    Account authentication and management service.

    Handles:
    - User authentication (login)
    - JWT token generation
    - Password management
    - Account creation and updates
    """

    @staticmethod
    def authenticate(email: str, password: str) -> Account:
        """
        Authenticate user with email and password.

        Args:
            email: User email
            password: Plain text password

        Returns:
            Authenticated Account instance

        Raises:
            AccountPasswordError: If email or password is invalid
            AccountLoginError: If account is banned
        """
        # Find account by email
        account = db.session.query(Account).filter_by(email=email).first()
        if not account:
            raise AccountPasswordError("Invalid email or password.")

        # Check if account is banned
        if account.status == AccountStatus.BANNED:
            raise AccountLoginError("Account is banned.")

        # Verify password
        if account.password is None or not compare_password(
            password,
            account.password,
            account.password_salt
        ):
            raise AccountPasswordError("Invalid email or password.")

        # Activate pending accounts
        if account.status == AccountStatus.PENDING:
            account.status = AccountStatus.ACTIVE
            account.initialized_at = datetime.now(UTC)

        db.session.commit()

        return account

    @staticmethod
    def get_account_jwt_token(account: Account) -> str:
        """
        Generate access token (JWT) for account.

        Args:
            account: Account instance

        Returns:
            JWT access token string
        """
        # Set expiration time
        exp_dt = datetime.now(UTC) + timedelta(
            minutes=dify_config.ACCESS_TOKEN_EXPIRE_MINUTES
        )
        exp = int(exp_dt.timestamp())

        # Create JWT payload
        payload = {
            "user_id": account.id,
            "exp": exp,
            "iss": dify_config.EDITION,  # Issuer
            "sub": "Console API Passport",  # Subject
        }

        # Issue JWT token
        token: str = PassportService().issue(payload)
        return token

    @staticmethod
    def login(account: Account, ip_address: str) -> TokenPair:
        """
        Perform login and generate token pair.

        Args:
            account: Account instance
            ip_address: Client IP address

        Returns:
            TokenPair containing access, refresh, and CSRF tokens
        """
        # Generate access token (JWT)
        access_token = AccountService.get_account_jwt_token(account)

        # Generate refresh token
        refresh_token = TokenManager.generate_refresh_token()

        # Store refresh token in Redis
        TokenManager.store_refresh_token(refresh_token, account.id)

        # Generate CSRF token
        csrf_token = secrets.token_hex(32)

        # Update last login info
        account.last_login_at = datetime.now(UTC)
        account.last_login_ip = ip_address
        db.session.commit()

        return TokenPair(
            access_token=access_token,
            refresh_token=refresh_token,
            csrf_token=csrf_token
        )

    @staticmethod
    def logout(account: Account) -> None:
        """
        Logout user and revoke refresh token.

        Args:
            account: Account instance
        """
        # Get account's refresh token from Redis
        refresh_token_key = f"{TokenManager.ACCOUNT_REFRESH_TOKEN_PREFIX}{account.id}"
        refresh_token = redis_client.get(refresh_token_key)

        if refresh_token:
            # Revoke refresh token
            TokenManager.revoke_refresh_token(
                refresh_token.decode(),
                account.id
            )
```

## 5.4 Cookieç®¡ç†

### 5.4.1 Cookie vs LocalStorage

**Cookieã®åˆ©ç‚¹**:
- **HttpOnly ãƒ•ãƒ©ã‚°**: JavaScriptã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ä¸å¯ã€XSSæ”»æ’ƒã‚’é˜²æ­¢
- **Secure ãƒ•ãƒ©ã‚°**: HTTPSé€šä¿¡ã®ã¿ã§é€ä¿¡
- **SameSite**: CSRFæ”»æ’ƒã‚’é˜²æ­¢

**LocalStorageã®æ¬ ç‚¹**:
- JavaScriptã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½: XSSæ”»æ’ƒã«è„†å¼±
- Cookieã‚ˆã‚Šã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãŒä½ã„

Difyã§ã¯**HttpOnly Cookieã«ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä¿å­˜**ã—ã¾ã™ã€‚

### 5.4.2 ãƒˆãƒ¼ã‚¯ãƒ³ã®Cookieç®¡ç†

**api/libs/token.py** ã‚’ä½œæˆ:

```python
"""
Token cookie management utilities.
"""
from flask import Request, Response

from configs import dify_config


def set_access_token_to_cookie(
    request: Request,
    response: Response,
    access_token: str
) -> None:
    """
    Set access token in HttpOnly cookie.

    Args:
        request: Flask request object
        response: Flask response object
        access_token: JWT access token
    """
    domain = _get_cookie_domain(request)

    response.set_cookie(
        key="access_token",
        value=access_token,
        max_age=dify_config.ACCESS_TOKEN_EXPIRE_MINUTES * 60,
        path="/",
        domain=domain,
        httponly=True,  # Prevent JavaScript access (XSS protection)
        secure=dify_config.COOKIE_SECURE,  # HTTPS only
        samesite="Lax"  # CSRF protection
    )


def set_refresh_token_to_cookie(
    request: Request,
    response: Response,
    refresh_token: str
) -> None:
    """
    Set refresh token in HttpOnly cookie.

    Args:
        request: Flask request object
        response: Flask response object
        refresh_token: Refresh token string
    """
    domain = _get_cookie_domain(request)

    response.set_cookie(
        key="refresh_token",
        value=refresh_token,
        max_age=dify_config.REFRESH_TOKEN_EXPIRE_DAYS * 24 * 60 * 60,
        path="/",
        domain=domain,
        httponly=True,  # Prevent JavaScript access
        secure=dify_config.COOKIE_SECURE,
        samesite="Lax"
    )


def set_csrf_token_to_cookie(
    request: Request,
    response: Response,
    csrf_token: str
) -> None:
    """
    Set CSRF token in cookie (not HttpOnly, for JavaScript access).

    Args:
        request: Flask request object
        response: Flask response object
        csrf_token: CSRF token string
    """
    domain = _get_cookie_domain(request)

    response.set_cookie(
        key="csrf_token",
        value=csrf_token,
        max_age=dify_config.ACCESS_TOKEN_EXPIRE_MINUTES * 60,
        path="/",
        domain=domain,
        httponly=False,  # Allow JavaScript access (for CSRF header)
        secure=dify_config.COOKIE_SECURE,
        samesite="Lax"
    )


def clear_access_token_from_cookie(response: Response) -> None:
    """Clear access token cookie (for logout)."""
    response.delete_cookie("access_token", path="/")


def clear_refresh_token_from_cookie(response: Response) -> None:
    """Clear refresh token cookie (for logout)."""
    response.delete_cookie("refresh_token", path="/")


def clear_csrf_token_from_cookie(response: Response) -> None:
    """Clear CSRF token cookie (for logout)."""
    response.delete_cookie("csrf_token", path="/")


def extract_refresh_token(request: Request) -> str | None:
    """
    Extract refresh token from cookie.

    Args:
        request: Flask request object

    Returns:
        Refresh token string or None
    """
    return request.cookies.get("refresh_token")


def check_csrf_token(request: Request, user_id: str) -> None:
    """
    Validate CSRF token from header against cookie.

    Args:
        request: Flask request object
        user_id: User ID for logging

    Raises:
        Unauthorized: If CSRF token is invalid or missing
    """
    # Skip CSRF check for safe methods
    if request.method in ["GET", "HEAD", "OPTIONS"]:
        return

    # Get CSRF token from header
    csrf_token_header = request.headers.get("X-CSRF-Token")

    # Get CSRF token from cookie
    csrf_token_cookie = request.cookies.get("csrf_token")

    # Validate CSRF token
    if not csrf_token_header or not csrf_token_cookie:
        raise Unauthorized("CSRF token missing")

    if csrf_token_header != csrf_token_cookie:
        raise Unauthorized("CSRF token mismatch")


def _get_cookie_domain(request: Request) -> str | None:
    """
    Get cookie domain from request host.

    Args:
        request: Flask request object

    Returns:
        Cookie domain string or None
    """
    # For localhost, don't set domain
    if "localhost" in request.host or "127.0.0.1" in request.host:
        return None

    # For production, use configured domain
    return dify_config.COOKIE_DOMAIN
```

**è¨­å®šã®è¿½åŠ  (api/configs/middleware/__init__.py)**:

```python
from pydantic import Field
from pydantic_settings import BaseSettings


class SecurityConfig(BaseSettings):
    """Security configuration."""

    SECRET_KEY: str = Field(
        default="",
        description="Secret key for JWT signing (MUST be set in production)"
    )

    ACCESS_TOKEN_EXPIRE_MINUTES: int = Field(
        default=60,
        description="Access token expiration time in minutes"
    )

    REFRESH_TOKEN_EXPIRE_DAYS: int = Field(
        default=30,
        description="Refresh token expiration time in days"
    )

    COOKIE_SECURE: bool = Field(
        default=False,
        description="Use secure cookies (HTTPS only)"
    )

    COOKIE_DOMAIN: str | None = Field(
        default=None,
        description="Cookie domain for multi-subdomain support"
    )

    LOGIN_DISABLED: bool = Field(
        default=False,
        description="Disable login (for testing only)"
    )
```

## 5.5 Login API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

### 5.5.1 ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®å®Ÿè£…

**api/controllers/console/auth/login.py**:

```python
"""
Authentication endpoints (login, logout, token refresh).
"""
import flask_login
from flask import make_response, request
from flask_restx import Resource, reqparse

from controllers.console import console_ns
from controllers.console.wraps import setup_required
from libs.helper import email, extract_remote_ip
from libs.login import current_account_with_tenant
from libs.token import (
    set_access_token_to_cookie,
    set_refresh_token_to_cookie,
    set_csrf_token_to_cookie,
    clear_access_token_from_cookie,
    clear_refresh_token_from_cookie,
    clear_csrf_token_from_cookie,
    extract_refresh_token,
)
from services.account_service import AccountService
from services.errors.account import AccountPasswordError, AccountLoginError


@console_ns.route("/login")
class LoginApi(Resource):
    """User login endpoint."""

    @setup_required
    def post(self):
        """
        Authenticate user and issue tokens.

        Request Body:
            - email: User email (required)
            - password: User password (required)
            - remember_me: Remember user (optional, default: False)

        Returns:
            Success response with tokens set in cookies

        Raises:
            AuthenticationFailedError: If email/password is invalid
            AccountBannedError: If account is banned
        """
        # Parse request arguments
        parser = (
            reqparse.RequestParser()
            .add_argument("email", type=email, required=True, location="json")
            .add_argument("password", type=str, required=True, location="json")
            .add_argument("remember_me", type=bool, default=False, location="json")
        )
        args = parser.parse_args()

        # Authenticate user
        try:
            account = AccountService.authenticate(args["email"], args["password"])
        except AccountPasswordError:
            return {"result": "fail", "message": "Invalid email or password"}, 401
        except AccountLoginError as e:
            return {"result": "fail", "message": str(e)}, 403

        # Generate token pair
        token_pair = AccountService.login(
            account=account,
            ip_address=extract_remote_ip(request)
        )

        # Create response
        response = make_response({"result": "success"})

        # Set tokens in cookies
        set_access_token_to_cookie(request, response, token_pair.access_token)
        set_refresh_token_to_cookie(request, response, token_pair.refresh_token)
        set_csrf_token_to_cookie(request, response, token_pair.csrf_token)

        return response


@console_ns.route("/logout")
class LogoutApi(Resource):
    """User logout endpoint."""

    @setup_required
    def post(self):
        """
        Logout user and revoke tokens.

        Returns:
            Success response with cookies cleared
        """
        # Get current user
        try:
            current_user, _ = current_account_with_tenant()
            account = current_user

            # Logout user
            if not isinstance(account, flask_login.AnonymousUserMixin):
                AccountService.logout(account=account)
                flask_login.logout_user()
        except:
            # Even if logout fails, clear cookies
            pass

        # Create response
        response = make_response({"result": "success"})

        # Clear cookies
        clear_access_token_from_cookie(response)
        clear_refresh_token_from_cookie(response)
        clear_csrf_token_from_cookie(response)

        return response


@console_ns.route("/refresh-token")
class RefreshTokenApi(Resource):
    """Token refresh endpoint."""

    @setup_required
    def post(self):
        """
        Refresh access token using refresh token.

        Returns:
            Success response with new access token in cookie

        Raises:
            Unauthorized: If refresh token is invalid
        """
        # Extract refresh token from cookie
        refresh_token = extract_refresh_token(request)
        if not refresh_token:
            return {"result": "fail", "message": "Refresh token missing"}, 401

        # Get account ID from refresh token
        account_id = TokenManager.get_account_id_by_refresh_token(refresh_token)
        if not account_id:
            return {"result": "fail", "message": "Invalid refresh token"}, 401

        # Load account
        account = AccountService.load_user(account_id)
        if not account:
            return {"result": "fail", "message": "Account not found"}, 404

        # Generate new access token
        access_token = AccountService.get_account_jwt_token(account)

        # Create response
        response = make_response({"result": "success"})

        # Set new access token in cookie
        set_access_token_to_cookie(request, response, access_token)

        return response
```


## 5.6 ãƒ­ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡(RBAC)

### 5.6.1 RBACã¨ã¯

**RBAC(Role-Based Access Control)**ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã€Œå½¹å‰²(Role)ã€ã«åŸºã¥ã„ã¦ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚’ç®¡ç†ã™ã‚‹æ–¹å¼ã§ã™ã€‚

**Difyã®ãƒ­ãƒ¼ãƒ«éšå±¤**:

```
Owner (æ‰€æœ‰è€…)
  â†“ ã™ã¹ã¦ã®æ¨©é™
Admin (ç®¡ç†è€…)
  â†“ ãƒ¡ãƒ³ãƒãƒ¼ç®¡ç†ã€ã‚¢ãƒ—ãƒªä½œæˆãƒ»ç·¨é›†ãƒ»å‰Šé™¤
Editor (ç·¨é›†è€…)
  â†“ ã‚¢ãƒ—ãƒªä½œæˆãƒ»ç·¨é›†
Normal (ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼)
  â†“ ã‚¢ãƒ—ãƒªé–²è¦§ã®ã¿
Dataset Operator (ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆç®¡ç†è€…)
  â†“ ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆç®¡ç†ã®ã¿
```

### 5.6.2 ãƒ­ãƒ¼ãƒ«ã®å®šç¾©

**api/models/account.py** ã«ãƒ­ãƒ¼ãƒ«Enumã‚’å®šç¾©:

```python
"""
Account and tenant models with role definitions.
"""
from enum import StrEnum
from sqlalchemy.orm import Mapped, mapped_column
from sqlalchemy import String, Enum

from models.base import TypeBase


class TenantAccountRole(StrEnum):
    """
    Tenant account roles for RBAC.

    Roles define what actions users can perform in a tenant:
    - OWNER: Full control, can transfer ownership
    - ADMIN: Manage members, create/edit/delete apps
    - EDITOR: Create and edit apps
    - NORMAL: View apps only
    - DATASET_OPERATOR: Manage datasets only
    """
    OWNER = "owner"
    ADMIN = "admin"
    EDITOR = "editor"
    NORMAL = "normal"
    DATASET_OPERATOR = "dataset_operator"


class TenantAccountJoin(TypeBase):
    """
    Join table for many-to-many relationship between Tenant and Account.

    This table stores:
    - Which accounts belong to which tenants
    - What role each account has in each tenant
    - Which tenant is currently active for each account
    """
    __tablename__ = "tenant_account_joins"

    id: Mapped[str] = mapped_column(StringUUID, primary_key=True)
    tenant_id: Mapped[str] = mapped_column(StringUUID, nullable=False, index=True)
    account_id: Mapped[str] = mapped_column(StringUUID, nullable=False, index=True)
    role: Mapped[TenantAccountRole] = mapped_column(
        Enum(TenantAccountRole),
        nullable=False,
        default=TenantAccountRole.NORMAL
    )
    current: Mapped[bool] = mapped_column(Boolean, default=False)

    # Indexes for efficient queries
    __table_args__ = (
        Index('idx_tenant_account', 'tenant_id', 'account_id'),
        Index('idx_account_current', 'account_id', 'current'),
    )
```

### 5.6.3 æ¨©é™ãƒã‚§ãƒƒã‚¯ãƒ¡ã‚½ãƒƒãƒ‰

**api/models/account.py** ã«Accountãƒ¢ãƒ‡ãƒ«ã¸ã®ãƒ¡ã‚½ãƒƒãƒ‰è¿½åŠ :

```python
class Account(TypeBase):
    """Account model with role-based permission methods."""

    __tablename__ = "accounts"

    id: Mapped[str] = mapped_column(StringUUID, primary_key=True)
    email: Mapped[str] = mapped_column(String(255), unique=True, nullable=False)
    name: Mapped[str] = mapped_column(String(255), nullable=False)

    # Permission check methods
    def has_role(self, tenant_id: str, role: TenantAccountRole) -> bool:
        """
        Check if account has a specific role in a tenant.

        Args:
            tenant_id: Tenant ID
            role: Role to check

        Returns:
            True if account has the role
        """
        join = (
            db.session.query(TenantAccountJoin)
            .filter_by(
                tenant_id=tenant_id,
                account_id=self.id,
                role=role
            )
            .first()
        )
        return join is not None

    def get_role(self, tenant_id: str) -> TenantAccountRole | None:
        """
        Get account's role in a tenant.

        Args:
            tenant_id: Tenant ID

        Returns:
            TenantAccountRole or None if not a member
        """
        join = (
            db.session.query(TenantAccountJoin)
            .filter_by(tenant_id=tenant_id, account_id=self.id)
            .first()
        )
        return join.role if join else None

    def is_owner(self, tenant_id: str) -> bool:
        """Check if account is owner of tenant."""
        return self.has_role(tenant_id, TenantAccountRole.OWNER)

    def is_admin_or_owner(self, tenant_id: str) -> bool:
        """Check if account is admin or owner."""
        role = self.get_role(tenant_id)
        return role in [TenantAccountRole.OWNER, TenantAccountRole.ADMIN]

    def can_edit_app(self, app_id: str) -> bool:
        """
        Check if account can edit an app.

        Args:
            app_id: App ID

        Returns:
            True if account can edit (Owner, Admin, or Editor)
        """
        from models import App

        app = db.session.query(App).filter_by(id=app_id).first()
        if not app:
            return False

        role = self.get_role(app.tenant_id)
        return role in [
            TenantAccountRole.OWNER,
            TenantAccountRole.ADMIN,
            TenantAccountRole.EDITOR
        ]

    def can_delete_app(self, app_id: str) -> bool:
        """
        Check if account can delete an app.

        Args:
            app_id: App ID

        Returns:
            True if account can delete (Owner or Admin only)
        """
        from models import App

        app = db.session.query(App).filter_by(id=app_id).first()
        if not app:
            return False

        return self.is_admin_or_owner(app.tenant_id)

    def can_manage_dataset(self, dataset_id: str) -> bool:
        """
        Check if account can manage a dataset.

        Args:
            dataset_id: Dataset ID

        Returns:
            True if account can manage (Owner, Admin, or Dataset Operator)
        """
        from models import Dataset

        dataset = db.session.query(Dataset).filter_by(id=dataset_id).first()
        if not dataset:
            return False

        role = self.get_role(dataset.tenant_id)
        return role in [
            TenantAccountRole.OWNER,
            TenantAccountRole.ADMIN,
            TenantAccountRole.DATASET_OPERATOR
        ]
```

### 5.6.4 æ¨©é™ãƒã‚§ãƒƒã‚¯ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿

**api/controllers/console/wraps.py** ã«æ¨©é™ãƒã‚§ãƒƒã‚¯ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ã‚’è¿½åŠ :

```python
"""
Authorization decorators for role-based access control.
"""
from functools import wraps
from flask import request
from werkzeug.exceptions import Forbidden

from libs.login import current_account_with_tenant
from models.account import TenantAccountRole


def is_admin_or_owner_required(func):
    """
    Decorator to require Admin or Owner role.

    Raises:
        Forbidden: If user is not Admin or Owner
    """
    @wraps(func)
    def wrapper(*args, **kwargs):
        account, tenant_id = current_account_with_tenant()

        if not account.is_admin_or_owner(tenant_id):
            raise Forbidden("Admin or Owner role required")

        return func(*args, **kwargs)

    return wrapper


def is_owner_required(func):
    """
    Decorator to require Owner role.

    Raises:
        Forbidden: If user is not Owner
    """
    @wraps(func)
    def wrapper(*args, **kwargs):
        account, tenant_id = current_account_with_tenant()

        if not account.is_owner(tenant_id):
            raise Forbidden("Owner role required")

        return func(*args, **kwargs)

    return wrapper


def edit_permission_required(func):
    """
    Decorator to require edit permission for app.

    Expects app_id in route parameters.

    Raises:
        Forbidden: If user cannot edit the app
    """
    @wraps(func)
    def wrapper(*args, **kwargs):
        account, _ = current_account_with_tenant()

        # Get app_id from route parameters
        app_id = kwargs.get("app_id")
        if not app_id:
            raise ValueError("app_id not found in route parameters")

        if not account.can_edit_app(str(app_id)):
            raise Forbidden("Edit permission required")

        return func(*args, **kwargs)

    return wrapper


def dataset_permission_required(func):
    """
    Decorator to require dataset management permission.

    Expects dataset_id in route parameters.

    Raises:
        Forbidden: If user cannot manage the dataset
    """
    @wraps(func)
    def wrapper(*args, **kwargs):
        account, _ = current_account_with_tenant()

        # Get dataset_id from route parameters
        dataset_id = kwargs.get("dataset_id")
        if not dataset_id:
            raise ValueError("dataset_id not found in route parameters")

        if not account.can_manage_dataset(str(dataset_id)):
            raise Forbidden("Dataset management permission required")

        return func(*args, **kwargs)

    return wrapper
```

**ä½¿ç”¨ä¾‹**:

```python
from controllers.console.wraps import (
    login_required,
    is_admin_or_owner_required,
    edit_permission_required
)

@console_ns.route("/apps/<uuid:app_id>")
class AppApi(Resource):

    @login_required
    @edit_permission_required
    def put(self, app_id: uuid.UUID):
        """Update app (requires Edit permission)."""
        # Only users with Editor, Admin, or Owner role can access
        pass

    @login_required
    @is_admin_or_owner_required
    def delete(self, app_id: uuid.UUID):
        """Delete app (requires Admin or Owner role)."""
        # Only Admin or Owner can delete
        pass
```

## 5.7 ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆåˆ†é›¢

### 5.7.1 Row-Level Isolationã¨ã¯

**ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£**ã§ã¯ã€è¤‡æ•°ã®ãƒ†ãƒŠãƒ³ãƒˆ(çµ„ç¹”)ãŒåŒã˜ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’å…±æœ‰ã—ã¾ã™ã€‚å„ãƒ†ãƒŠãƒ³ãƒˆã®ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºå®Ÿã«åˆ†é›¢ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

**Difyã®å®Ÿè£…æ–¹å¼: Row-Level Isolation**:
- ã™ã¹ã¦ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã«`tenant_id`ã‚«ãƒ©ãƒ ã‚’è¿½åŠ 
- ã™ã¹ã¦ã®ã‚¯ã‚¨ãƒªã«`tenant_id`ãƒ•ã‚£ãƒ«ã‚¿ã‚’è‡ªå‹•çš„ã«é©ç”¨
- ãƒ†ãƒŠãƒ³ãƒˆé–“ã®ãƒ‡ãƒ¼ã‚¿æ¼æ´©ã‚’é˜²æ­¢

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Database (PostgreSQL)         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Apps Table                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   id  â”‚  tenant_id   â”‚   name    â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ app-1 â”‚  tenant-A    â”‚  ChatBot  â”‚  â”‚ â† Tenant A
â”‚  â”‚ app-2 â”‚  tenant-B    â”‚  Agent    â”‚  â”‚ â† Tenant B
â”‚  â”‚ app-3 â”‚  tenant-A    â”‚  Workflow â”‚  â”‚ â† Tenant A
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                         â”‚
â”‚  Workflows Table                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   id  â”‚  tenant_id   â”‚  app_id   â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ wf-1  â”‚  tenant-A    â”‚  app-1    â”‚  â”‚ â† Tenant A
â”‚  â”‚ wf-2  â”‚  tenant-B    â”‚  app-2    â”‚  â”‚ â† Tenant B
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.7.2 è‡ªå‹•çš„ãªãƒ†ãƒŠãƒ³ãƒˆãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°

**ã™ã¹ã¦ã®ã‚¯ã‚¨ãƒªã«tenant_idã‚’å«ã‚ã‚‹**:

```python
from libs.login import current_account_with_tenant

# Get current tenant ID
account, tenant_id = current_account_with_tenant()

# Query with tenant_id filter (ALWAYS include this)
apps = (
    db.session.query(App)
    .filter(App.tenant_id == tenant_id)  # â† Tenant isolation
    .all()
)

# When creating new resources, set tenant_id
new_app = App(
    name="My App",
    tenant_id=tenant_id,  # â† Set tenant_id
    created_by=account.id
)
db.session.add(new_app)
db.session.commit()
```

### 5.7.3 ãƒ†ãƒŠãƒ³ãƒˆã‚¹ã‚¤ãƒƒãƒãƒ³ã‚°

ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯è¤‡æ•°ã®ãƒ†ãƒŠãƒ³ãƒˆã«æ‰€å±ã§ãã¾ã™ã€‚ç¾åœ¨ã®ãƒ†ãƒŠãƒ³ãƒˆã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

**api/controllers/console/workspace/workspace.py**:

```python
"""
Workspace (tenant) management endpoints.
"""
from flask_restx import Resource, reqparse
from werkzeug.exceptions import NotFound, Forbidden

from controllers.console import console_ns
from controllers.console.wraps import login_required
from libs.login import current_account_with_tenant
from models.account import TenantAccountJoin
from extensions.ext_database import db


@console_ns.route("/workspaces/switch")
class WorkspaceSwitchApi(Resource):
    """Switch current workspace (tenant)."""

    @login_required
    def post(self):
        """
        Switch to a different workspace.

        Request Body:
            - tenant_id: Target tenant ID (required)

        Returns:
            Success response

        Raises:
            NotFound: If tenant not found or user is not a member
            Forbidden: If user doesn't have access to the tenant
        """
        parser = reqparse.RequestParser()
        parser.add_argument("tenant_id", type=str, required=True, location="json")
        args = parser.parse_args()

        account, current_tenant_id = current_account_with_tenant()
        target_tenant_id = args["tenant_id"]

        # Check if user is a member of target tenant
        target_join = (
            db.session.query(TenantAccountJoin)
            .filter_by(tenant_id=target_tenant_id, account_id=account.id)
            .first()
        )

        if not target_join:
            raise NotFound("Workspace not found or access denied")

        # Unset current flag from all tenants for this account
        db.session.query(TenantAccountJoin).filter_by(
            account_id=account.id,
            current=True
        ).update({"current": False})

        # Set current flag on target tenant
        target_join.current = True
        db.session.commit()

        return {"result": "success", "tenant_id": target_tenant_id}


@console_ns.route("/workspaces/current")
class CurrentWorkspaceApi(Resource):
    """Get current workspace information."""

    @login_required
    def get(self):
        """
        Get current workspace details.

        Returns:
            Workspace information including role
        """
        account, tenant_id = current_account_with_tenant()

        # Get tenant details
        tenant_join = (
            db.session.query(TenantAccountJoin)
            .filter_by(tenant_id=tenant_id, account_id=account.id)
            .first()
        )

        if not tenant_join:
            raise NotFound("Current workspace not found")

        # Get tenant
        from models import Tenant
        tenant = db.session.query(Tenant).filter_by(id=tenant_id).first()

        return {
            "id": tenant.id,
            "name": tenant.name,
            "role": tenant_join.role.value,
            "created_at": int(tenant.created_at.timestamp())
        }
```

## 5.8 ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

### 5.8.1 Rate Limiting - ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œåˆ¶é™

ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹æ”»æ’ƒã‚’é˜²ããŸã‚ã€ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œå›æ•°ã‚’åˆ¶é™ã—ã¾ã™ã€‚

**api/libs/helper.py** ã«RateLimiterã‚’è¿½åŠ :

```python
"""
Rate limiting utilities using Redis.
"""
from datetime import timedelta
from extensions.ext_redis import redis_client


class RateLimiter:
    """
    Rate limiter using Redis for distributed rate limiting.

    Tracks failed attempts and blocks requests when limit is exceeded.
    """

    def __init__(self, prefix: str, max_attempts: int, time_window: int):
        """
        Initialize rate limiter.

        Args:
            prefix: Redis key prefix (e.g., "login_rate_limit")
            max_attempts: Maximum attempts allowed
            time_window: Time window in seconds
        """
        self.prefix = prefix
        self.max_attempts = max_attempts
        self.time_window = time_window

    def _get_key(self, identifier: str) -> str:
        """Get Redis key for identifier."""
        return f"{self.prefix}:{identifier}"

    def is_rate_limited(self, identifier: str) -> bool:
        """
        Check if identifier is rate limited.

        Args:
            identifier: Unique identifier (e.g., email or IP)

        Returns:
            True if rate limited
        """
        key = self._get_key(identifier)
        attempts = redis_client.get(key)

        if attempts is None:
            return False

        return int(attempts) >= self.max_attempts

    def increment(self, identifier: str) -> int:
        """
        Increment attempt count.

        Args:
            identifier: Unique identifier

        Returns:
            Current attempt count
        """
        key = self._get_key(identifier)

        # Increment counter
        attempts = redis_client.incr(key)

        # Set expiration on first attempt
        if attempts == 1:
            redis_client.expire(key, self.time_window)

        return attempts

    def reset(self, identifier: str) -> None:
        """
        Reset attempt count (called on successful login).

        Args:
            identifier: Unique identifier
        """
        key = self._get_key(identifier)
        redis_client.delete(key)
```

**AccountServiceã¸ã®çµ±åˆ**:

```python
class AccountService:
    """Account service with rate limiting."""

    # Rate limiters
    login_rate_limiter = RateLimiter(
        prefix="login_rate_limit",
        max_attempts=5,
        time_window=300  # 5 minutes
    )

    @staticmethod
    def is_login_error_rate_limit(email: str) -> bool:
        """Check if login attempts are rate limited."""
        return AccountService.login_rate_limiter.is_rate_limited(email)

    @staticmethod
    def add_login_error_rate_limit(email: str) -> None:
        """Increment failed login attempts."""
        AccountService.login_rate_limiter.increment(email)

    @staticmethod
    def reset_login_error_rate_limit(email: str) -> None:
        """Reset login attempts on successful login."""
        AccountService.login_rate_limiter.reset(email)

    @staticmethod
    def authenticate(email: str, password: str) -> Account:
        """Authenticate with rate limiting."""
        # Check rate limit BEFORE authentication
        if AccountService.is_login_error_rate_limit(email):
            raise AccountLoginError("Too many failed login attempts. Please try again later.")

        # ... authentication logic ...

        # On success, reset rate limit
        AccountService.reset_login_error_rate_limit(email)

        return account
```

### 5.8.2 CSRF Protection

CSRF(Cross-Site Request Forgery)æ”»æ’ƒã‚’é˜²ããŸã‚ã€CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ¤œè¨¼ã—ã¾ã™ã€‚

**CSRFãƒˆãƒ¼ã‚¯ãƒ³ã®ç”Ÿæˆã¨æ¤œè¨¼** (api/libs/token.py):

```python
import secrets


def generate_csrf_token() -> str:
    """Generate CSRF token."""
    return secrets.token_hex(32)


def check_csrf_token(request: Request, user_id: str) -> None:
    """
    Validate CSRF token.

    Args:
        request: Flask request
        user_id: User ID

    Raises:
        Unauthorized: If CSRF token is invalid
    """
    # Skip for safe methods
    if request.method in ["GET", "HEAD", "OPTIONS"]:
        return

    # Get token from header
    csrf_header = request.headers.get("X-CSRF-Token")

    # Get token from cookie
    csrf_cookie = request.cookies.get("csrf_token")

    # Validate
    if not csrf_header or not csrf_cookie or csrf_header != csrf_cookie:
        raise Unauthorized("CSRF token validation failed")
```

### 5.8.3 XSS Protection

**HttpOnly Cookie**:
- access_tokenã¨refresh_tokenã¯`HttpOnly`ãƒ•ãƒ©ã‚°ã‚’è¨­å®š
- JavaScriptã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ä¸å¯

**Content Security Policy (CSP)**:

```python
@app.after_request
def set_security_headers(response):
    """Set security headers."""
    response.headers["Content-Security-Policy"] = (
        "default-src 'self'; "
        "script-src 'self' 'unsafe-inline' 'unsafe-eval'; "
        "style-src 'self' 'unsafe-inline';"
    )
    response.headers["X-Content-Type-Options"] = "nosniff"
    response.headers["X-Frame-Options"] = "DENY"
    response.headers["X-XSS-Protection"] = "1; mode=block"
    return response
```

## 5.9 å®Ÿè£…ã®ç¢ºèªã¨ãƒ†ã‚¹ãƒˆ

### 5.9.1 èªè¨¼ãƒ•ãƒ­ãƒ¼ã®ãƒ†ã‚¹ãƒˆ

**ãƒ†ã‚¹ãƒˆç”¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆ**:

```bash
# 1. ãƒ­ã‚°ã‚¤ãƒ³
curl -X POST http://localhost:5001/console/api/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "admin@example.com",
    "password": "SecurePassword123"
  }' \
  -c cookies.txt \
  -v

# 2. èªè¨¼ãŒå¿…è¦ãªAPIã‚’å‘¼ã³å‡ºã—
curl -X GET http://localhost:5001/console/api/apps \
  -b cookies.txt \
  -H "X-CSRF-Token: $(cat cookies.txt | grep csrf_token | awk '{print $7}')" \
  -v

# 3. ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
curl -X POST http://localhost:5001/console/api/logout \
  -b cookies.txt \
  -v
```

### 5.9.2 ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ

**api/tests/unit_tests/services/test_account_service.py**:

```python
"""
Unit tests for AccountService authentication.
"""
import pytest
from unittest.mock import patch, Mock

from models.account import Account, AccountStatus
from services.account_service import AccountService
from services.errors.account import AccountPasswordError


@pytest.fixture
def mock_account():
    """Fixture for mock Account."""
    account = Mock(spec=Account)
    account.id = "account-123"
    account.email = "test@example.com"
    account.password = "hashed_password"
    account.password_salt = "salt"
    account.status = AccountStatus.ACTIVE
    return account


def test_authenticate_success(mock_account):
    """Test successful authentication."""
    with patch('services.account_service.db.session') as mock_session:
        # Mock DB query
        mock_session.query.return_value.filter_by.return_value.first.return_value = mock_account

        # Mock password comparison
        with patch('services.account_service.compare_password', return_value=True):
            result = AccountService.authenticate("test@example.com", "password123")

            assert result == mock_account
            assert result.status == AccountStatus.ACTIVE


def test_authenticate_invalid_email():
    """Test authentication with invalid email."""
    with patch('services.account_service.db.session') as mock_session:
        # Mock DB query to return None
        mock_session.query.return_value.filter_by.return_value.first.return_value = None

        with pytest.raises(AccountPasswordError, match="Invalid email or password"):
            AccountService.authenticate("invalid@example.com", "password123")


def test_authenticate_invalid_password(mock_account):
    """Test authentication with invalid password."""
    with patch('services.account_service.db.session') as mock_session:
        mock_session.query.return_value.filter_by.return_value.first.return_value = mock_account

        # Mock password comparison to fail
        with patch('services.account_service.compare_password', return_value=False):
            with pytest.raises(AccountPasswordError, match="Invalid email or password"):
                AccountService.authenticate("test@example.com", "wrong_password")
```

## 5.10 ã¾ã¨ã‚

ã“ã®ç« ã§ã¯ã€Difyã®èªè¨¼ãƒ»èªå¯ã‚·ã‚¹ãƒ†ãƒ ã®å®Ÿè£…ã‚’å­¦ã³ã¾ã—ãŸã€‚

### å®Ÿè£…ã—ãŸå†…å®¹

âœ… **ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒã‚·ãƒ¥åŒ–**
- PBKDF2-HMAC-SHA256ã«ã‚ˆã‚‹å®‰å…¨ãªãƒãƒƒã‚·ãƒ¥åŒ–
- Saltã®ä½¿ç”¨ã§ãƒ¬ã‚¤ãƒ³ãƒœãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«æ”»æ’ƒã‚’é˜²æ­¢
- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¼·åº¦ã®æ¤œè¨¼

âœ… **JWTèªè¨¼**
- PassportService: JWTç™ºè¡Œã¨æ¤œè¨¼
- TokenManager: ãƒˆãƒ¼ã‚¯ãƒ³ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ç®¡ç†
- Access token + Refresh tokenæ–¹å¼

âœ… **Cookieç®¡ç†**
- HttpOnly cookieã§XSSæ”»æ’ƒã‚’é˜²æ­¢
- Secure flagã§HTTPSé€šä¿¡ã‚’å¼·åˆ¶
- SameSiteå±æ€§ã§CSRFæ”»æ’ƒã‚’é˜²æ­¢

âœ… **ãƒ­ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡(RBAC)**
- 5ã¤ã®ãƒ­ãƒ¼ãƒ«: Owner, Admin, Editor, Normal, Dataset Operator
- æ¨©é™ãƒã‚§ãƒƒã‚¯ãƒ¡ã‚½ãƒƒãƒ‰: has_role(), can_edit_app()
- æ¨©é™ãƒã‚§ãƒƒã‚¯ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿: @is_admin_or_owner_required

âœ… **ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆåˆ†é›¢**
- Row-Level Isolation: ã™ã¹ã¦ã®ã‚¯ã‚¨ãƒªã«tenant_idãƒ•ã‚£ãƒ«ã‚¿
- ãƒ†ãƒŠãƒ³ãƒˆã‚¹ã‚¤ãƒƒãƒãƒ³ã‚°æ©Ÿèƒ½
- ãƒ†ãƒŠãƒ³ãƒˆé–“ãƒ‡ãƒ¼ã‚¿æ¼æ´©ã®é˜²æ­¢

âœ… **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–**
- Rate Limiting: ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œå›æ•°åˆ¶é™
- CSRF Protection: CSRFãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼
- XSS Protection: HttpOnly cookieã€CSPãƒ˜ãƒƒãƒ€ãƒ¼

### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

- âœ… ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯å¹³æ–‡ã§ä¿å­˜ã—ãªã„
- âœ… JWTã«ã¯æœ‰åŠ¹æœŸé™ã‚’è¨­å®šã™ã‚‹
- âœ… Refresh tokenã¯Redisã«ä¿å­˜ã—ã€ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ™‚ã«å‰Šé™¤
- âœ… ã™ã¹ã¦ã®APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«èªè¨¼ã‚’è¦æ±‚
- âœ… é‡è¦ãªæ“ä½œã«ã¯æ¨©é™ãƒã‚§ãƒƒã‚¯ã‚’è¿½åŠ 
- âœ… ã™ã¹ã¦ã®ã‚¯ã‚¨ãƒªã«tenant_idãƒ•ã‚£ãƒ«ã‚¿ã‚’å«ã‚ã‚‹
- âœ… Rate Limitingã§ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹æ”»æ’ƒã‚’é˜²ã
- âœ… CSRF ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ¤œè¨¼ã™ã‚‹
- âœ… HttpOnly cookieã‚’ä½¿ç”¨ã™ã‚‹

### å‚ç…§ãƒ•ã‚¡ã‚¤ãƒ«

ã“ã®ç« ã§å®Ÿè£…ã—ãŸå†…å®¹ã¯ã€ä»¥ä¸‹ã®Difyã®å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‚è€ƒã«ã—ã¦ã„ã¾ã™:

- [api/libs/password.py](api/libs/password.py) - ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒã‚·ãƒ¥åŒ–
- [api/libs/passport.py](api/libs/passport.py) - JWTç™ºè¡Œãƒ»æ¤œè¨¼
- [api/libs/helper.py](api/libs/helper.py) - TokenManager, RateLimiter
- [api/libs/token.py](api/libs/token.py) - Cookieç®¡ç†
- [api/libs/login.py](api/libs/login.py) - ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ç®¡ç†
- [api/services/account_service.py](api/services/account_service.py) - èªè¨¼ã‚µãƒ¼ãƒ“ã‚¹
- [api/controllers/console/auth/login.py](api/controllers/console/auth/login.py) - ãƒ­ã‚°ã‚¤ãƒ³API
- [api/controllers/console/wraps.py](api/controllers/console/wraps.py) - æ¨©é™ãƒã‚§ãƒƒã‚¯ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿
- [api/models/account.py](api/models/account.py) - Accountãƒ¢ãƒ‡ãƒ«ã€ãƒ­ãƒ¼ãƒ«å®šç¾©

### æ¬¡ã®ç« ã¸

æ¬¡ã®ç¬¬6ç« ã§ã¯ã€**LLMãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼æŠ½è±¡åŒ–**ã‚’å®Ÿè£…ã—ã¾ã™ã€‚Model Runtimeã®è¨­è¨ˆã€ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã€OpenAI/Anthropicçµ±åˆã€ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å¯¾å¿œã€ãƒˆãƒ¼ã‚¯ãƒ³ã‚«ã‚¦ãƒ³ãƒˆã¨ã‚³ã‚¹ãƒˆè¨ˆç®—ã‚’å­¦ã³ã¾ã™ã€‚

---
# ç¬¬6ç« : LLMãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼æŠ½è±¡åŒ–(ç°¡æ½”ç‰ˆ)

ã“ã®ç« ã§ã¯ã€Difyã®Model Runtimeã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã«ã¤ã„ã¦å­¦ã³ã¾ã™ã€‚Model Runtimeã¯ã€è¤‡æ•°ã®LLMãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼(OpenAI, Anthropic, Google, Azureãªã©)ã‚’çµ±ä¸€çš„ãªã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã§æ‰±ã†ãŸã‚ã®æŠ½è±¡åŒ–å±¤ã§ã™ã€‚

## 6.1 Model Runtimeã®æ¦‚è¦

### 6.1.1 ãªãœæŠ½è±¡åŒ–ãŒå¿…è¦ã‹

**å•é¡Œ**:
- å„LLMãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã¯ç•°ãªã‚‹APIã‚’æŒã¤
- OpenAI: `openai.ChatCompletion.create()`
- Anthropic: `anthropic.messages.create()`
- Google: `genai.GenerativeModel().generate_content()`

**è§£æ±ºç­–**: çµ±ä¸€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã§æŠ½è±¡åŒ–

```python
# çµ±ä¸€ã•ã‚ŒãŸã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹
result = model_manager.invoke_llm(
    provider="openai",  # or "anthropic", "google", etc.
    model="gpt-4",
    messages=[{"role": "user", "content": "Hello"}]
)
```

### 6.1.2 ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Application Layer (Workflow)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚   Model Manager     â”‚  â† çµ±ä¸€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚    Model Runtime          â”‚
    â”‚  (Provider Abstraction)   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                                    â”‚
â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”
â”‚  OpenAI    â”‚  â”‚Anthropicâ”‚  â”‚    Google    â”‚
â”‚  Provider  â”‚  â”‚ Providerâ”‚  â”‚   Provider   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 6.2 ä¸»è¦ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

### 6.2.1 LLMã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£

**api/core/model_runtime/entities/llm_entities.py**:

```python
from pydantic import BaseModel
from decimal import Decimal

class LLMUsage(BaseModel):
    """LLM usage tracking."""
    prompt_tokens: int
    completion_tokens: int
    total_tokens: int
    prompt_price: Decimal
    completion_price: Decimal
    total_price: Decimal
    currency: str = "USD"
    latency: float

class LLMResult(BaseModel):
    """LLM invocation result."""
    model: str
    prompt_messages: list[PromptMessage]
    message: AssistantPromptMessage  # AI response
    usage: LLMUsage
```

### 6.2.2 LargeLanguageModelã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹

**api/core/model_runtime/model_providers/__base/large_language_model.py**:

```python
from abc import ABC, abstractmethod

class LargeLanguageModel(ABC):
    """Base class for all LLM providers."""

    @abstractmethod
    def invoke(
        self,
        model: str,
        credentials: dict,
        prompt_messages: list[PromptMessage],
        model_parameters: dict | None = None,
        stream: bool = False,
    ) -> LLMResult | Generator[LLMResultChunk, None, None]:
        """
        Invoke LLM with unified interface.

        Args:
            model: Model name (e.g., "gpt-4", "claude-3")
            credentials: API credentials
            prompt_messages: Conversation messages
            model_parameters: Temperature, max_tokens, etc.
            stream: Enable streaming

        Returns:
            LLMResult or stream of LLMResultChunk
        """
        raise NotImplementedError
```

## 6.3 OpenAIãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼å®Ÿè£…ä¾‹

**api/core/model_runtime/model_providers/openai/llm/llm.py** (ç°¡ç•¥ç‰ˆ):

```python
from openai import OpenAI
from core.model_runtime.model_providers.__base.large_language_model import (
    LargeLanguageModel
)

class OpenAILargeLanguageModel(LargeLanguageModel):
    """OpenAI LLM implementation."""

    def invoke(
        self,
        model: str,
        credentials: dict,
        prompt_messages: list[PromptMessage],
        model_parameters: dict | None = None,
        stream: bool = False,
    ):
        """Invoke OpenAI API."""
        client = OpenAI(api_key=credentials["api_key"])

        # Convert to OpenAI format
        openai_messages = [
            {"role": msg.role, "content": msg.content}
            for msg in prompt_messages
        ]

        # Call OpenAI API
        if stream:
            return self._invoke_stream(client, model, openai_messages, model_parameters)
        else:
            return self._invoke_non_stream(client, model, openai_messages, model_parameters)

    def _invoke_non_stream(self, client, model, messages, params):
        """Non-streaming invocation."""
        response = client.chat.completions.create(
            model=model,
            messages=messages,
            temperature=params.get("temperature", 0.7),
            max_tokens=params.get("max_tokens", 1000),
        )

        # Convert to unified format
        return LLMResult(
            model=model,
            message=AssistantPromptMessage(
                content=response.choices[0].message.content
            ),
            usage=LLMUsage(
                prompt_tokens=response.usage.prompt_tokens,
                completion_tokens=response.usage.completion_tokens,
                total_tokens=response.usage.total_tokens,
                # ... calculate prices
            )
        )
```

## 6.4 ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å¯¾å¿œ

ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¯ã€LLMã®å¿œç­”ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§è¿”ã™æ©Ÿèƒ½ã§ã™ã€‚

```python
def _invoke_stream(self, client, model, messages, params):
    """Streaming invocation."""
    stream = client.chat.completions.create(
        model=model,
        messages=messages,
        stream=True,
        **params
    )

    for chunk in stream:
        if chunk.choices[0].delta.content:
            yield LLMResultChunk(
                model=model,
                delta=LLMResultChunkDelta(
                    message=AssistantPromptMessage(
                        content=chunk.choices[0].delta.content
                    )
                )
            )
```

## 6.5 ãƒˆãƒ¼ã‚¯ãƒ³ã‚«ã‚¦ãƒ³ãƒˆã¨ã‚³ã‚¹ãƒˆè¨ˆç®—

**api/core/model_runtime/model_providers/__base/large_language_model.py**:

```python
def _calc_response_usage(
    self,
    model: str,
    credentials: dict,
    prompt_tokens: int,
    completion_tokens: int
) -> LLMUsage:
    """Calculate usage and cost."""
    # Get model pricing from config
    pricing = self.get_model_pricing(model)

    # Calculate costs (per 1M tokens)
    prompt_price = (Decimal(prompt_tokens) / 1000000) * pricing["prompt"]
    completion_price = (Decimal(completion_tokens) / 1000000) * pricing["completion"]

    return LLMUsage(
        prompt_tokens=prompt_tokens,
        completion_tokens=completion_tokens,
        total_tokens=prompt_tokens + completion_tokens,
        prompt_price=prompt_price,
        completion_price=completion_price,
        total_price=prompt_price + completion_price,
        currency="USD"
    )
```

## 6.6 ã¾ã¨ã‚

ã“ã®ç« ã§ã¯ã€Difyã®Model Runtimeã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚’å­¦ã³ã¾ã—ãŸã€‚

âœ… **çµ±ä¸€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹**: è¤‡æ•°ã®LLMãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã‚’åŒã˜APIã§æ‰±ã†
âœ… **ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼æŠ½è±¡åŒ–**: OpenAI, Anthropic, Googleãªã©ã‚’æŠ½è±¡åŒ–
âœ… **ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å¯¾å¿œ**: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ¬ã‚¹ãƒãƒ³ã‚¹
âœ… **ã‚³ã‚¹ãƒˆè¨ˆç®—**: ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨é‡ã¨æ–™é‡‘ã®è‡ªå‹•è¨ˆç®—

### å‚ç…§ãƒ•ã‚¡ã‚¤ãƒ«

- [api/core/model_runtime/model_providers/__base/large_language_model.py](api/core/model_runtime/model_providers/__base/large_language_model.py)
- [api/core/model_runtime/entities/llm_entities.py](api/core/model_runtime/entities/llm_entities.py)

---

# ç¬¬7ç« : CeleryéåŒæœŸã‚¿ã‚¹ã‚¯ã‚·ã‚¹ãƒ†ãƒ (ç°¡æ½”ç‰ˆ)

ã“ã®ç« ã§ã¯ã€Celeryã‚’ä½¿ã£ãŸéåŒæœŸã‚¿ã‚¹ã‚¯å‡¦ç†ã‚·ã‚¹ãƒ†ãƒ ã‚’å­¦ã³ã¾ã™ã€‚Celeryã¯ã€æ™‚é–“ã®ã‹ã‹ã‚‹å‡¦ç†(ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã€ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œãªã©)ã‚’ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§å®Ÿè¡Œã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã—ã¾ã™ã€‚

## 7.1 Celeryã®æ¦‚è¦

### 7.1.1 ãªãœCeleryãŒå¿…è¦ã‹

**å•é¡Œ**:
- ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹åŒ–ã¯æ™‚é–“ãŒã‹ã‹ã‚‹(æ•°åˆ†ã€œæ•°ååˆ†)
- HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã™ã‚‹(é€šå¸¸30-60ç§’)
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯å‡¦ç†å®Œäº†ã‚’å¾…ã¡ãŸããªã„

**è§£æ±ºç­–**: éåŒæœŸã‚¿ã‚¹ã‚¯ã‚­ãƒ¥ãƒ¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     1. Request      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Client  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚   API    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â–²                                 â”‚ 2. Enqueue task
     â”‚                                 â–¼
     â”‚                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚                           â”‚  Redis   â”‚ â† Task Queue
     â”‚                           â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚ 4. Poll status                  â”‚ 3. Dequeue
     â”‚                                 â–¼
     â”‚                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  Celery  â”‚
           5. Return result      â”‚  Worker  â”‚
                                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.1.2 Celeryã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

- **Broker (Redis)**: ã‚¿ã‚¹ã‚¯ã‚­ãƒ¥ãƒ¼ã®ç®¡ç†
- **Worker**: ã‚¿ã‚¹ã‚¯ã‚’å®Ÿè¡Œã™ã‚‹ãƒ—ãƒ­ã‚»ã‚¹
- **Beat**: å®šæœŸå®Ÿè¡Œã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼
- **Result Backend (Redis)**: ã‚¿ã‚¹ã‚¯çµæœã®ä¿å­˜

## 7.2 Celeryã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

### 7.2.1 Celeryã®åˆæœŸåŒ–

**api/extensions/ext_celery.py**:

```python
"""
Celery extension initialization.
"""
from celery import Celery
from configs import dify_config

# Create Celery instance
celery_app = Celery(
    "dify",
    broker=dify_config.CELERY_BROKER_URL,  # Redis URL
    backend=dify_config.CELERY_RESULT_BACKEND,  # Redis URL
)

# Configure Celery
celery_app.conf.update(
    task_serializer="json",
    accept_content=["json"],
    result_serializer="json",
    timezone="UTC",
    enable_utc=True,
    task_track_started=True,
    task_time_limit=3600,  # 1 hour timeout
    worker_max_tasks_per_child=100,  # Prevent memory leaks
)


def init_app(app):
    """Initialize Celery with Flask app context."""
    class ContextTask(celery_app.Task):
        def __call__(self, *args, **kwargs):
            # Execute task within Flask app context
            with app.app_context():
                return self.run(*args, **kwargs)

    celery_app.Task = ContextTask
```

## 7.3 ã‚¿ã‚¹ã‚¯ã®å®Ÿè£…

### 7.3.1 ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚¿ã‚¹ã‚¯

**api/tasks/document_indexing_task.py**:

```python
"""
Document indexing background task.
"""
import logging
from celery import current_app as celery_app

from extensions.ext_database import db
from models import Document, Dataset
from core.rag.document_processor import DocumentProcessor

logger = logging.getLogger(__name__)


@celery_app.task(
    bind=True,  # Bind task instance as first argument
    max_retries=3,  # Retry up to 3 times
    default_retry_delay=60  # Wait 60 seconds between retries
)
def document_indexing_task(self, document_id: str):
    """
    Index a document in background.

    Args:
        self: Celery task instance (automatically bound)
        document_id: Document ID to index

    Raises:
        Retry: If indexing fails temporarily
    """
    try:
        # Load document from database
        document = db.session.query(Document).filter_by(id=document_id).first()
        if not document:
            logger.error(f"Document {document_id} not found")
            return

        # Update status to processing
        document.indexing_status = "processing"
        db.session.commit()

        # Process document
        processor = DocumentProcessor()
        processor.process_document(document)

        # Update status to completed
        document.indexing_status = "completed"
        document.indexed_at = datetime.now(UTC)
        db.session.commit()

        logger.info(f"Document {document_id} indexed successfully")

    except Exception as e:
        logger.exception(f"Failed to index document {document_id}")

        # Update status to failed
        document.indexing_status = "failed"
        document.error = str(e)
        db.session.commit()

        # Retry if possible
        if self.request.retries < self.max_retries:
            raise self.retry(exc=e)
```

### 7.3.2 ã‚¿ã‚¹ã‚¯ã®å®Ÿè¡Œ

**api/services/dataset_service.py**:

```python
from tasks.document_indexing_task import document_indexing_task

class DatasetService:
    @staticmethod
    def create_document(dataset_id: str, file, account: Account):
        """Create document and start indexing."""
        # Create document record
        document = Document(
            dataset_id=dataset_id,
            name=file.filename,
            indexing_status="waiting",
            created_by=account.id
        )
        db.session.add(document)
        db.session.commit()

        # Enqueue indexing task (non-blocking)
        document_indexing_task.delay(document.id)

        return document
```

## 7.4 ã‚¿ã‚¹ã‚¯çŠ¶æ…‹ã®ç¢ºèª

**api/controllers/console/datasets/documents.py**:

```python
@console_ns.route("/datasets/<uuid:dataset_id>/documents/<uuid:document_id>/status")
class DocumentIndexingStatusApi(Resource):
    """Get document indexing status."""

    @login_required
    def get(self, dataset_id: uuid.UUID, document_id: uuid.UUID):
        """
        Get indexing status.

        Returns:
            Status: waiting, processing, completed, failed
        """
        account, tenant_id = current_account_with_tenant()

        # Get document
        document = (
            db.session.query(Document)
            .filter_by(
                id=str(document_id),
                dataset_id=str(dataset_id),
                tenant_id=tenant_id
            )
            .first()
        )

        if not document:
            abort(404, description="Document not found")

        return {
            "status": document.indexing_status,
            "progress": document.indexing_progress,
            "error": document.error,
            "indexed_at": int(document.indexed_at.timestamp()) if document.indexed_at else None
        }
```

## 7.5 Celery Beatã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼

å®šæœŸçš„ã«å®Ÿè¡Œã™ã‚‹ã‚¿ã‚¹ã‚¯ã‚’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã—ã¾ã™ã€‚

**api/tasks/scheduled_tasks.py**:

```python
"""
Scheduled periodic tasks.
"""
from celery import current_app as celery_app
from celery.schedules import crontab

# Configure Beat schedule
celery_app.conf.beat_schedule = {
    # Clean up expired sessions every hour
    'cleanup-expired-sessions': {
        'task': 'tasks.scheduled_tasks.cleanup_expired_sessions',
        'schedule': crontab(minute=0),  # Every hour
    },
    # Cleanup failed tasks every day at 2 AM
    'cleanup-failed-tasks': {
        'task': 'tasks.scheduled_tasks.cleanup_failed_tasks',
        'schedule': crontab(hour=2, minute=0),  # Daily at 2 AM
    },
}


@celery_app.task
def cleanup_expired_sessions():
    """Remove expired sessions from Redis."""
    # Implementation
    pass


@celery_app.task
def cleanup_failed_tasks():
    """Cleanup failed task records older than 7 days."""
    # Implementation
    pass
```

## 7.6 Celeryã®èµ·å‹•

**Workerã®èµ·å‹•**:

```bash
cd api

# Start Celery worker
uv run --project . celery -A extensions.ext_celery.celery_app worker \
  --loglevel=info \
  --concurrency=4  # Number of worker processes
```

**Beatã®èµ·å‹•** (å®šæœŸã‚¿ã‚¹ã‚¯ç”¨):

```bash
# Start Celery beat scheduler
uv run --project . celery -A extensions.ext_celery.celery_app beat \
  --loglevel=info
```

## 7.7 ã¾ã¨ã‚

ã“ã®ç« ã§ã¯ã€Celeryã‚’ä½¿ã£ãŸéåŒæœŸã‚¿ã‚¹ã‚¯ã‚·ã‚¹ãƒ†ãƒ ã‚’å­¦ã³ã¾ã—ãŸã€‚

âœ… **éåŒæœŸå‡¦ç†**: æ™‚é–“ã®ã‹ã‹ã‚‹å‡¦ç†ã‚’ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§å®Ÿè¡Œ
âœ… **ã‚¿ã‚¹ã‚¯ã‚­ãƒ¥ãƒ¼**: Redisã‚’ãƒ–ãƒ­ãƒ¼ã‚«ãƒ¼ã¨ã—ã¦ä½¿ç”¨
âœ… **ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½**: å¤±æ•—æ™‚ã®è‡ªå‹•å†è©¦è¡Œ
âœ… **å®šæœŸå®Ÿè¡Œ**: Beatã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼ã§å®šæœŸã‚¿ã‚¹ã‚¯
âœ… **çŠ¶æ…‹ç®¡ç†**: ã‚¿ã‚¹ã‚¯ã®é€²æ—çŠ¶æ³ã‚’è¿½è·¡

### å‚ç…§ãƒ•ã‚¡ã‚¤ãƒ«

- [api/extensions/ext_celery.py](api/extensions/ext_celery.py)
- [api/tasks/document_indexing_task.py](api/tasks/document_indexing_task.py)

---

**ç¬¬3-7ç« (ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰åŸºç›¤)å®Œäº†!**

ç¬¬3ç« ã‹ã‚‰ç¬¬7ç« ã¾ã§ã€Difyã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰åŸºç›¤ã‚’å®Ÿè£…ã—ã¾ã—ãŸ:
- ç¬¬3ç« : ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆã¨ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
- ç¬¬4ç« : ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰åŸºç›¤æ§‹ç¯‰(Clean Architecture)
- ç¬¬5ç« : èªè¨¼ãƒ»èªå¯ã‚·ã‚¹ãƒ†ãƒ (JWT, RBAC, ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆ)
- ç¬¬6ç« : LLMãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼æŠ½è±¡åŒ–
- ç¬¬7ç« : CeleryéåŒæœŸã‚¿ã‚¹ã‚¯ã‚·ã‚¹ãƒ†ãƒ 

æ¬¡ã®ç¬¬8ç« ã§ã¯ã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰åŸºç›¤ã®æ§‹ç¯‰ã‚’é–‹å§‹ã—ã¾ã™ã€‚Next.js 15ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®åˆæœŸåŒ–ã€TypeScriptè¨­å®šã€Tailwind CSSã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’å­¦ã³ã¾ã™ã€‚

---

# ç¬¬8ç« : ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰åŸºç›¤æ§‹ç¯‰

ã“ã®ç« ã§ã¯ã€Next.js 15ã‚’ä½¿ã£ãŸãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰åŸºç›¤ã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚Difyã¯React 19ã¨Next.js 15ã®App Routerã‚’ä½¿ç”¨ã—ãŸæœ€æ–°ã®ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚’æ¡ç”¨ã—ã¦ã„ã¾ã™ã€‚

## 8.1 ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦

Difyã®ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¯ä»¥ä¸‹ã®æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯ã§æ§‹æˆã•ã‚Œã¦ã„ã¾ã™:

- **Next.js 15**: React 19ã®ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯(App Router)
- **TypeScript**: å‹å®‰å…¨æ€§ã‚’ä¿è¨¼
- **Tailwind CSS**: ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆCSS
- **Zustand**: è»½é‡ãªçŠ¶æ…‹ç®¡ç†
- **TanStack Query (React Query)**: ã‚µãƒ¼ãƒãƒ¼ã‚¹ãƒ†ãƒ¼ãƒˆç®¡ç†
- **React Flow**: ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚¨ãƒ‡ã‚£ã‚¿
- **ky**: è»½é‡ãªHTTPã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
- **i18next**: å¤šè¨€èªå¯¾å¿œ

```
web/
â”œâ”€â”€ app/               # Next.js App Router
â”‚   â”œâ”€â”€ layout.tsx     # ãƒ«ãƒ¼ãƒˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
â”‚   â”œâ”€â”€ (commonLayout)/ # èªè¨¼æ¸ˆã¿ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
â”‚   â”œâ”€â”€ (auth)/        # èªè¨¼ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
â”‚   â””â”€â”€ components/    # UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
â”œâ”€â”€ context/           # React Context
â”œâ”€â”€ service/           # API ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
â”œâ”€â”€ i18n/              # å¤šè¨€èªãƒªã‚½ãƒ¼ã‚¹
â”œâ”€â”€ types/             # TypeScriptå‹å®šç¾©
â”œâ”€â”€ utils/             # ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
â””â”€â”€ stores/            # Zustandã‚¹ãƒˆã‚¢
```

**å‚ç…§**: [web/](web/)

## 8.2 Next.js 15ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®åˆæœŸåŒ–

### 8.2.1 ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

```bash
# webãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•
cd web

# pnpmã§ã®ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
pnpm install

# é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã®èµ·å‹•
pnpm dev
```

### 8.2.2 package.jsonã®æ§‹æˆ

Difyã®ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ä¸»è¦ãªä¾å­˜é–¢ä¿‚:

```json
{
  "name": "dify-web",
  "version": "1.10.1",
  "private": true,
  "packageManager": "pnpm@10.23.0",
  "engines": {
    "node": ">=v22.11.0"
  },
  "scripts": {
    "dev": "next dev --turbopack",
    "build": "next build",
    "start": "node ./scripts/copy-and-start.mjs",
    "lint": "eslint --cache",
    "type-check": "tsc --noEmit"
  },
  "dependencies": {
    "next": "~15.5.6",
    "react": "19.1.1",
    "react-dom": "19.1.1",
    "zustand": "^4.5.7",
    "@tanstack/react-query": "^5.90.5",
    "ky": "^1.12.0",
    "i18next": "^23.16.8",
    "react-i18next": "^15.7.4",
    "reactflow": "^11.11.4",
    "tailwindcss": "^3.4.18",
    "next-themes": "^0.4.6"
  },
  "devDependencies": {
    "typescript": "^5.9.3",
    "@types/react": "~19.1.17",
    "@types/node": "18.15.0",
    "eslint": "^9.38.0",
    "jest": "^29.7.0"
  }
}
```

**å‚ç…§**: [web/package.json](web/package.json)

## 8.3 TypeScriptè¨­å®š

### 8.3.1 tsconfig.json

Difyã¯å³æ ¼ãªTypeScriptè¨­å®šã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™:

```json
{
  "compilerOptions": {
    "target": "es2015",
    "lib": ["dom", "dom.iterable", "esnext"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "forceConsistentCasingInFileNames": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "node",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "preserve",
    "incremental": true,
    "plugins": [{ "name": "next" }],
    "paths": {
      "@/*": ["./*"]
    }
  },
  "include": ["next-env.d.ts", "**/*.ts", "**/*.tsx", ".next/types/**/*.ts"],
  "exclude": ["node_modules"]
}
```

**é‡è¦ãªè¨­å®š**:
- `strict: true`: å³æ ¼ãªå‹ãƒã‚§ãƒƒã‚¯
- `paths: { "@/*": ["./*"] }`: ãƒ‘ã‚¹ã‚¨ã‚¤ãƒªã‚¢ã‚¹(`@/`ã§å§‹ã¾ã‚‹import)
- `jsx: "preserve"`: Next.jsã§JSXã‚’å‡¦ç†

**å‚ç…§**: [web/tsconfig.json](web/tsconfig.json)

### 8.3.2 å‹å®šç¾©ã®ä¾‹

```typescript
// types/app.ts
export interface App {
  id: string
  name: string
  description: string
  mode: AppMode
  icon: string
  icon_background: string
  model_config: ModelConfig
  created_at: number
  updated_at: number
}

export enum AppMode {
  COMPLETION = 'completion',
  CHAT = 'chat',
  AGENT_CHAT = 'agent-chat',
  ADVANCED_CHAT = 'advanced-chat',
  WORKFLOW = 'workflow',
}

export interface ModelConfig {
  provider: string
  model_id: string
  configs: {
    temperature: number
    max_tokens: number
    top_p: number
  }
}
```

## 8.4 Tailwind CSSã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

### 8.4.1 tailwind.config.js

```javascript
// web/tailwind.config.js
import commonConfig from './tailwind-common-config'

const config = {
  content: [
    './app/**/*.{js,ts,jsx,tsx}',
    './components/**/*.{js,ts,jsx,tsx}',
    './context/**/*.{js,ts,jsx,tsx}',
  ],
  ...commonConfig,
}

export default config
```

### 8.4.2 ã‚°ãƒ­ãƒ¼ãƒãƒ«CSS

```css
/* app/styles/globals.css */
@tailwind base;
@tailwind components;
@tailwind utilities;

:root {
  --color-primary: #1c64f2;
  --color-background: #ffffff;
  --color-text: #1f2937;
}

[data-theme='dark'] {
  --color-background: #111827;
  --color-text: #f9fafb;
}

/* ã‚«ã‚¹ã‚¿ãƒ ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ */
@layer utilities {
  .scrollbar-thin::-webkit-scrollbar {
    width: 6px;
    height: 6px;
  }

  .scrollbar-thin::-webkit-scrollbar-thumb {
    @apply bg-gray-300 dark:bg-gray-600 rounded;
  }
}
```

### 8.4.3 Tailwind CSSã®ä½¿ç”¨ä¾‹

```tsx
// app/components/base/button/index.tsx
import type { FC } from 'react'
import cn from '@/utils/classnames'

interface ButtonProps {
  variant?: 'primary' | 'secondary'
  size?: 'sm' | 'md' | 'lg'
  children: React.ReactNode
  onClick?: () => void
}

export const Button: FC<ButtonProps> = ({
  variant = 'primary',
  size = 'md',
  children,
  onClick,
}) => {
  return (
    <button
      className={cn(
        'rounded-lg font-medium transition-colors',
        {
          'bg-primary-600 hover:bg-primary-700 text-white': variant === 'primary',
          'bg-gray-200 hover:bg-gray-300 text-gray-900': variant === 'secondary',
        },
        {
          'px-3 py-1.5 text-sm': size === 'sm',
          'px-4 py-2 text-base': size === 'md',
          'px-6 py-3 text-lg': size === 'lg',
        }
      )}
      onClick={onClick}
    >
      {children}
    </button>
  )
}
```

**å‚ç…§**: [web/tailwind.config.js](web/tailwind.config.js), [web/app/styles/globals.css](web/app/styles/globals.css)

## 8.5 App Routerã®è¨­å®š

### 8.5.1 ãƒ«ãƒ¼ãƒˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ

```tsx
// app/layout.tsx
import type { Viewport } from 'next'
import { ThemeProvider } from 'next-themes'
import { TanstackQueryInitializer } from '@/context/query-client'
import GlobalPublicStoreProvider from '@/context/global-public-context'
import I18nServer from './components/i18n-server'
import './styles/globals.css'

export const viewport: Viewport = {
  width: 'device-width',
  initialScale: 1,
  maximumScale: 1,
  viewportFit: 'cover',
  userScalable: false,
}

const LocaleLayout = async ({ children }: { children: React.ReactNode }) => {
  return (
    <html lang="en" suppressHydrationWarning>
      <head>
        <link rel="manifest" href="/manifest.json" />
        <meta name="theme-color" content="#1C64F2" />
      </head>
      <body className="h-full">
        <ThemeProvider
          attribute="data-theme"
          defaultTheme="system"
          enableSystem
          disableTransitionOnChange
        >
          <TanstackQueryInitializer>
            <I18nServer>
              <GlobalPublicStoreProvider>
                {children}
              </GlobalPublicStoreProvider>
            </I18nServer>
          </TanstackQueryInitializer>
        </ThemeProvider>
      </body>
    </html>
  )
}

export default LocaleLayout
```

**ä¸»è¦ãªæ§‹æˆè¦ç´ **:
- `ThemeProvider`: ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰å¯¾å¿œ
- `TanstackQueryInitializer`: React Queryã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
- `I18nServer`: å¤šè¨€èªå¯¾å¿œ
- `GlobalPublicStoreProvider`: ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ãƒ†ãƒ¼ãƒˆ

**å‚ç…§**: [web/app/layout.tsx](web/app/layout.tsx)

### 8.5.2 èªè¨¼ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ

```tsx
// app/(auth)/layout.tsx
import type { FC, ReactNode } from 'react'

const AuthLayout: FC<{ children: ReactNode }> = ({ children }) => {
  return (
    <div className="flex h-full items-center justify-center bg-gray-50">
      <div className="w-full max-w-md">
        {children}
      </div>
    </div>
  )
}

export default AuthLayout
```

### 8.5.3 èªè¨¼å¾Œã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ

```tsx
// app/(commonLayout)/layout.tsx
import type { FC, ReactNode } from 'react'
import Header from '@/app/components/header'
import Sidebar from '@/app/components/sidebar'
import { AppContextProvider } from '@/context/app-context'

const CommonLayout: FC<{ children: ReactNode }> = ({ children }) => {
  return (
    <AppContextProvider>
      <div className="flex h-full">
        <Sidebar />
        <div className="flex flex-1 flex-col">
          <Header />
          <main className="flex-1 overflow-y-auto p-6">
            {children}
          </main>
        </div>
      </div>
    </AppContextProvider>
  )
}

export default CommonLayout
```

## 8.6 ç’°å¢ƒå¤‰æ•°è¨­å®š

### 8.6.1 .env.example

```bash
# APIè¨­å®š
NEXT_PUBLIC_API_PREFIX=http://localhost:5001
NEXT_PUBLIC_PUBLIC_API_PREFIX=http://localhost:5001/v1

# èªè¨¼è¨­å®š
NEXT_PUBLIC_COOKIE_DOMAIN=localhost
NEXT_PUBLIC_SUPPORT_MAIL_LOGIN=true

# æ©Ÿèƒ½ãƒ•ãƒ©ã‚°
NEXT_PUBLIC_EDITION=SELF_HOSTED
NEXT_PUBLIC_ENABLE_WEBSITE_JINAREADER=true
NEXT_PUBLIC_ENABLE_SINGLE_DOLLAR_LATEX=true

# Sentry (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)
NEXT_PUBLIC_SENTRY_DSN=

# ãã®ä»–
NEXT_PUBLIC_TEXT_GENERATION_TIMEOUT_MS=60000
NEXT_PUBLIC_MAX_TOOLS_NUM=30
```

### 8.6.2 ç’°å¢ƒå¤‰æ•°ã®ä½¿ç”¨

```typescript
// config/index.ts
export const API_PREFIX = process.env.NEXT_PUBLIC_API_PREFIX || '/api'
export const PUBLIC_API_PREFIX = process.env.NEXT_PUBLIC_PUBLIC_API_PREFIX || '/v1'
export const IS_CE_EDITION = process.env.NEXT_PUBLIC_EDITION === 'SELF_HOSTED'

export const CSRF_COOKIE_NAME = () => {
  const domain = process.env.NEXT_PUBLIC_COOKIE_DOMAIN
  return domain ? `dify_csrf_token_${domain}` : 'dify_csrf_token'
}

export const PASSPORT_HEADER_NAME = 'X-App-Code'
export const CSRF_HEADER_NAME = 'X-CSRF-Token'
```

## 8.7 ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ã®è©³ç´°

### 8.7.1 app/ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª

```
app/
â”œâ”€â”€ (auth)/                    # èªè¨¼ãƒ«ãƒ¼ãƒˆ
â”‚   â”œâ”€â”€ signin/
â”‚   â”‚   â””â”€â”€ page.tsx
â”‚   â””â”€â”€ signup/
â”‚       â””â”€â”€ page.tsx
â”œâ”€â”€ (commonLayout)/            # èªè¨¼å¾Œãƒ«ãƒ¼ãƒˆ
â”‚   â”œâ”€â”€ apps/
â”‚   â”‚   â”œâ”€â”€ page.tsx
â”‚   â”‚   â””â”€â”€ [appId]/
â”‚   â”‚       â”œâ”€â”€ overview/
â”‚   â”‚       â”œâ”€â”€ configuration/
â”‚   â”‚       â””â”€â”€ logs/
â”‚   â”œâ”€â”€ datasets/
â”‚   â””â”€â”€ plugins/
â”œâ”€â”€ components/                # å…±æœ‰ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
â”‚   â”œâ”€â”€ base/                  # åŸºæœ¬UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
â”‚   â”œâ”€â”€ header/
â”‚   â””â”€â”€ sidebar/
â””â”€â”€ styles/                    # ã‚¹ã‚¿ã‚¤ãƒ«
```

### 8.7.2 ä¸»è¦ãƒšãƒ¼ã‚¸ã®å®Ÿè£…ä¾‹

```tsx
// app/(commonLayout)/apps/page.tsx
'use client'

import { useEffect } from 'react'
import { useRouter } from 'next/navigation'
import { useAppContext } from '@/context/app-context'
import AppList from '@/app/components/app-list'

export default function AppsPage() {
  const router = useRouter()
  const { isLoadingCurrentWorkspace } = useAppContext()

  if (isLoadingCurrentWorkspace) {
    return <div>Loading...</div>
  }

  return (
    <div className="h-full">
      <div className="mb-6 flex items-center justify-between">
        <h1 className="text-2xl font-semibold">Applications</h1>
        <button
          onClick={() => router.push('/apps/new')}
          className="btn-primary"
        >
          Create App
        </button>
      </div>
      <AppList />
    </div>
  )
}
```

## 8.8 ã¾ã¨ã‚

ã“ã®ç« ã§ã¯ã€Next.js 15ã‚’ä½¿ã£ãŸãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰åŸºç›¤ã‚’æ§‹ç¯‰ã—ã¾ã—ãŸã€‚

âœ… **Next.js 15**: App Routerã«ã‚ˆã‚‹ãƒ¢ãƒ€ãƒ³ãªãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
âœ… **TypeScript**: å³æ ¼ãªå‹ãƒã‚§ãƒƒã‚¯
âœ… **Tailwind CSS**: ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆãªã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚°
âœ… **ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚·ã‚¹ãƒ†ãƒ **: èªè¨¼å‰å¾Œã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆåˆ†é›¢
âœ… **ç’°å¢ƒå¤‰æ•°**: æŸ”è»Ÿãªè¨­å®šç®¡ç†

### å‚ç…§ãƒ•ã‚¡ã‚¤ãƒ«

- [web/package.json](web/package.json)
- [web/tsconfig.json](web/tsconfig.json)
- [web/tailwind.config.js](web/tailwind.config.js)
- [web/app/layout.tsx](web/app/layout.tsx)

æ¬¡ã®ç¬¬9ç« ã§ã¯ã€çŠ¶æ…‹ç®¡ç†(Zustand, React Query)ã¨APIçµ±åˆã‚’å®Ÿè£…ã—ã¾ã™ã€‚

---

# ç¬¬9ç« : çŠ¶æ…‹ç®¡ç†ã¨APIçµ±åˆ

ã“ã®ç« ã§ã¯ã€Zustandã‚’ä½¿ã£ãŸã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰çŠ¶æ…‹ç®¡ç†ã¨ã€TanStack Query(React Query)ã‚’ä½¿ã£ãŸã‚µãƒ¼ãƒãƒ¼ã‚¹ãƒ†ãƒ¼ãƒˆç®¡ç†ã‚’å®Ÿè£…ã—ã¾ã™ã€‚ã¾ãŸã€kyã‚’ä½¿ã£ãŸAPIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚‚æ§‹ç¯‰ã—ã¾ã™ã€‚

## 9.1 çŠ¶æ…‹ç®¡ç†ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

Difyã¯çŠ¶æ…‹ã‚’2ã¤ã®ã‚«ãƒ†ã‚´ãƒªã«åˆ†ã‘ã¦ç®¡ç†ã—ã¾ã™:

1. **ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚¹ãƒ†ãƒ¼ãƒˆ** (Zustand)
   - UIã®çŠ¶æ…‹(ãƒ¢ãƒ¼ãƒ€ãƒ«é–‹é–‰ã€é¸æŠçŠ¶æ…‹ãªã©)
   - ä¸€æ™‚çš„ãªãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿
   - ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚¨ãƒ‡ã‚£ã‚¿ã®çŠ¶æ…‹

2. **ã‚µãƒ¼ãƒãƒ¼ã‚¹ãƒ†ãƒ¼ãƒˆ** (TanStack Query)
   - APIã‹ã‚‰å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿
   - ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°ã€ãƒªãƒ•ã‚§ãƒƒãƒãƒ³ã‚°
   - æ¥½è¦³çš„æ›´æ–°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Component      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
    â”‚         â”‚
â”Œâ”€â”€â”€â–¼â”€â”€â”  â”Œâ”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
â”‚Zustandâ”‚  â”‚TanStack â”‚
â”‚Store  â”‚  â”‚Query    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                â”‚
           â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
           â”‚API Clientâ”‚
           â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                â”‚
           â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
           â”‚Backend  â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 9.2 TanStack Query (React Query) ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

### 9.2.1 QueryClientã®åˆæœŸåŒ–

```tsx
// context/query-client.tsx
'use client'

import type { FC, PropsWithChildren } from 'react'
import { QueryClient, QueryClientProvider } from '@tanstack/react-query'
import { ReactQueryDevtools } from '@tanstack/react-query-devtools'

const STALE_TIME = 1000 * 60 * 30 // 30 minutes

const client = new QueryClient({
  defaultOptions: {
    queries: {
      staleTime: STALE_TIME,
      refetchOnWindowFocus: false,
      retry: 1,
    },
  },
})

export const TanstackQueryInitializer: FC<PropsWithChildren> = ({ children }) => {
  return (
    <QueryClientProvider client={client}>
      {children}
      <ReactQueryDevtools initialIsOpen={false} />
    </QueryClientProvider>
  )
}
```

**é‡è¦ãªè¨­å®š**:
- `staleTime: 30åˆ†`: ãƒ‡ãƒ¼ã‚¿ã‚’30åˆ†é–“æ–°é®®ã¨è¦‹ãªã™
- `refetchOnWindowFocus: false`: ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ™‚ã®è‡ªå‹•å†å–å¾—ã‚’ç„¡åŠ¹åŒ–
- `retry: 1`: å¤±æ•—æ™‚ã«1å›ã ã‘ãƒªãƒˆãƒ©ã‚¤

**å‚ç…§**: [web/context/query-client.tsx](web/context/query-client.tsx)

### 9.2.2 ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯ã®ä½œæˆ

```typescript
// service/use-base.ts
import { useQueryClient, type QueryKey } from '@tanstack/react-query'

export const useInvalid = (key?: QueryKey) => {
  const queryClient = useQueryClient()
  return () => {
    if (!key) return
    queryClient.invalidateQueries({ queryKey: key })
  }
}

export const useReset = (key?: QueryKey) => {
  const queryClient = useQueryClient()
  return () => {
    if (!key) return
    queryClient.resetQueries({ queryKey: key })
  }
}
```

**å‚ç…§**: [web/service/use-base.ts](web/service/use-base.ts)

## 9.3 APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®å®Ÿè£…

### 9.3.1 base fetch (kyä½¿ç”¨)

```typescript
// service/fetch.ts
import ky from 'ky'
import Cookies from 'js-cookie'
import { API_PREFIX, CSRF_COOKIE_NAME, CSRF_HEADER_NAME } from '@/config'

export enum ContentType {
  json = 'application/json',
  form = 'application/x-www-form-urlencoded; charset=UTF-8',
  download = 'application/octet-stream',
}

export type FetchOptionType = {
  method?: string
  params?: Record<string, any>
  body?: Record<string, any> | FormData | ReadableStream
  headers?: Record<string, string>
}

export const getBaseOptions = (): RequestInit => {
  return {
    credentials: 'include', // Cookieã‚’å«ã‚ã‚‹
    headers: {
      [CSRF_HEADER_NAME]: Cookies.get(CSRF_COOKIE_NAME()) || '',
    },
  }
}

export const base = <T>(
  url: string,
  options: FetchOptionType = {},
  otherOptions?: { isPublicAPI?: boolean }
): Promise<T> => {
  const { isPublicAPI = false } = otherOptions || {}
  const urlPrefix = isPublicAPI ? PUBLIC_API_PREFIX : API_PREFIX
  const urlWithPrefix = `${urlPrefix}${url.startsWith('/') ? url : `/${url}`}`

  const baseOptions = getBaseOptions()

  const mergedOptions = {
    ...baseOptions,
    ...options,
    headers: {
      ...baseOptions.headers,
      ...options.headers,
    },
  }

  if (options.body && !(options.body instanceof FormData)) {
    mergedOptions.body = JSON.stringify(options.body)
    mergedOptions.headers['Content-Type'] = ContentType.json
  }

  return ky(urlWithPrefix, mergedOptions).json<T>()
}
```

### 9.3.2 RESTful APIãƒ¡ã‚½ãƒƒãƒ‰

```typescript
// service/base.ts
import type { FetchOptionType } from './fetch'
import { base } from './fetch'

export type IOtherOptions = {
  isPublicAPI?: boolean
  silent?: boolean
}

export const request = async <T>(
  url: string,
  options: FetchOptionType = {},
  otherOptions?: IOtherOptions
): Promise<T> => {
  try {
    return await base<T>(url, options, otherOptions)
  } catch (error) {
    // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°(401ã®å ´åˆã¯ãƒˆãƒ¼ã‚¯ãƒ³ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãªã©)
    throw error
  }
}

export const get = <T>(
  url: string,
  options: FetchOptionType = {},
  otherOptions?: IOtherOptions
) => {
  return request<T>(url, { ...options, method: 'GET' }, otherOptions)
}

export const post = <T>(
  url: string,
  options: FetchOptionType = {},
  otherOptions?: IOtherOptions
) => {
  return request<T>(url, { ...options, method: 'POST' }, otherOptions)
}

export const put = <T>(
  url: string,
  options: FetchOptionType = {},
  otherOptions?: IOtherOptions
) => {
  return request<T>(url, { ...options, method: 'PUT' }, otherOptions)
}

export const del = <T>(
  url: string,
  options: FetchOptionType = {},
  otherOptions?: IOtherOptions
) => {
  return request<T>(url, { ...options, method: 'DELETE' }, otherOptions)
}

export const patch = <T>(
  url: string,
  options: FetchOptionType = {},
  otherOptions?: IOtherOptions
) => {
  return request<T>(url, { ...options, method: 'PATCH' }, otherOptions)
}
```

**å‚ç…§**: [web/service/base.ts](web/service/base.ts)

### 9.3.3 ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å¯¾å¿œ(SSE)

```typescript
// service/base.ts (ç¶šã)
export type IOnData = (
  message: string,
  isFirstMessage: boolean,
  moreInfo: { conversationId?: string; messageId: string }
) => void

export const handleStream = (
  response: Response,
  onData: IOnData,
  onCompleted?: () => void
) => {
  const reader = response.body?.getReader()
  const decoder = new TextDecoder('utf-8')
  let buffer = ''
  let isFirstMessage = true

  function read() {
    reader?.read().then((result) => {
      if (result.done) {
        onCompleted?.()
        return
      }

      buffer += decoder.decode(result.value, { stream: true })
      const lines = buffer.split('\n')

      lines.forEach((message) => {
        if (message.startsWith('data: ')) {
          try {
            const bufferObj = JSON.parse(message.substring(6))

            if (bufferObj.event === 'message') {
              onData(bufferObj.answer, isFirstMessage, {
                conversationId: bufferObj.conversation_id,
                messageId: bufferObj.id,
              })
              isFirstMessage = false
            }
            // ä»–ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ—ã‚‚ã“ã“ã§å‡¦ç†
          } catch (e) {
            console.error('Failed to parse SSE message:', e)
          }
        }
      })

      buffer = lines[lines.length - 1]
      read()
    })
  }

  read()
}

export const ssePost = async (
  url: string,
  fetchOptions: FetchOptionType,
  otherOptions: {
    isPublicAPI?: boolean
    onData?: IOnData
    onCompleted?: () => void
  }
) => {
  const abortController = new AbortController()
  const baseOptions = getBaseOptions()

  const options = {
    ...baseOptions,
    ...fetchOptions,
    method: 'POST',
    signal: abortController.signal,
  }

  if (fetchOptions.body) {
    options.body = JSON.stringify(fetchOptions.body)
    options.headers = {
      ...options.headers,
      'Content-Type': ContentType.json,
    }
  }

  const urlPrefix = otherOptions.isPublicAPI ? PUBLIC_API_PREFIX : API_PREFIX
  const response = await fetch(`${urlPrefix}${url}`, options)

  if (response.ok && otherOptions.onData) {
    handleStream(response, otherOptions.onData, otherOptions.onCompleted)
  }
}
```

**å‚ç…§**: [web/service/base.ts](web/service/base.ts)

## 9.4 APIã‚µãƒ¼ãƒ“ã‚¹ã®å®Ÿè£…

### 9.4.1 ã‚¢ãƒ—ãƒªAPIã‚µãƒ¼ãƒ“ã‚¹

```typescript
// service/apps.ts
import { get, post, put, del } from './base'
import type { App, AppMode } from '@/types/app'

export const fetchAppList = () => {
  return get<{ data: App[] }>('/apps')
}

export const fetchAppDetail = (appId: string) => {
  return get<App>(`/apps/${appId}`)
}

export const createApp = (data: {
  name: string
  description?: string
  mode: AppMode
  icon: string
  icon_background: string
}) => {
  return post<App>('/apps', { body: data })
}

export const updateApp = (appId: string, data: Partial<App>) => {
  return put<App>(`/apps/${appId}`, { body: data })
}

export const deleteApp = (appId: string) => {
  return del(`/apps/${appId}`)
}
```

### 9.4.2 React Queryãƒ•ãƒƒã‚¯

```typescript
// service/use-apps.ts
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query'
import { fetchAppList, fetchAppDetail, createApp, updateApp, deleteApp } from './apps'
import type { App, AppMode } from '@/types/app'

// ã‚¢ãƒ—ãƒªä¸€è¦§ã®å–å¾—
export const useAppList = () => {
  return useQuery({
    queryKey: ['apps'],
    queryFn: () => fetchAppList(),
  })
}

// ã‚¢ãƒ—ãƒªè©³ç´°ã®å–å¾—
export const useAppDetail = (appId: string) => {
  return useQuery({
    queryKey: ['app', appId],
    queryFn: () => fetchAppDetail(appId),
    enabled: !!appId,
  })
}

// ã‚¢ãƒ—ãƒªã®ä½œæˆ
export const useCreateApp = () => {
  const queryClient = useQueryClient()

  return useMutation({
    mutationFn: createApp,
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['apps'] })
    },
  })
}

// ã‚¢ãƒ—ãƒªã®æ›´æ–°
export const useUpdateApp = (appId: string) => {
  const queryClient = useQueryClient()

  return useMutation({
    mutationFn: (data: Partial<App>) => updateApp(appId, data),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['app', appId] })
      queryClient.invalidateQueries({ queryKey: ['apps'] })
    },
  })
}

// ã‚¢ãƒ—ãƒªã®å‰Šé™¤
export const useDeleteApp = () => {
  const queryClient = useQueryClient()

  return useMutation({
    mutationFn: deleteApp,
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['apps'] })
    },
  })
}
```

### 9.4.3 ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ã®ä½¿ç”¨ä¾‹

```tsx
// app/components/app-list/index.tsx
'use client'

import { useAppList, useDeleteApp } from '@/service/use-apps'
import { Button } from '@/app/components/base/button'

export default function AppList() {
  const { data, isLoading, error } = useAppList()
  const deleteApp = useDeleteApp()

  if (isLoading) return <div>Loading...</div>
  if (error) return <div>Error: {error.message}</div>

  const apps = data?.data || []

  const handleDelete = async (appId: string) => {
    if (confirm('Delete this app?')) {
      await deleteApp.mutateAsync(appId)
    }
  }

  return (
    <div className="grid grid-cols-3 gap-4">
      {apps.map(app => (
        <div key={app.id} className="rounded-lg border p-4">
          <h3 className="text-lg font-semibold">{app.name}</h3>
          <p className="text-sm text-gray-600">{app.description}</p>
          <div className="mt-4 flex gap-2">
            <Button variant="primary" size="sm">
              Edit
            </Button>
            <Button
              variant="secondary"
              size="sm"
              onClick={() => handleDelete(app.id)}
            >
              Delete
            </Button>
          </div>
        </div>
      ))}
    </div>
  )
}
```

## 9.5 React Context ã«ã‚ˆã‚‹çŠ¶æ…‹ç®¡ç†

### 9.5.1 AppContext ã®å®Ÿè£…

```tsx
// context/app-context.tsx
'use client'

import { createContext, useContext, useContextSelector } from 'use-context-selector'
import { useCallback, useEffect, useState } from 'react'
import useSWR from 'swr'
import type { FC, ReactNode } from 'react'
import { fetchCurrentWorkspace, fetchUserProfile } from '@/service/common'
import type { ICurrentWorkspace, UserProfileResponse } from '@/types/common'

export type AppContextValue = {
  userProfile: UserProfileResponse
  currentWorkspace: ICurrentWorkspace
  isCurrentWorkspaceManager: boolean
  isCurrentWorkspaceOwner: boolean
  mutateUserProfile: VoidFunction
  mutateCurrentWorkspace: VoidFunction
}

const AppContext = createContext<AppContextValue>({} as AppContextValue)

export function useSelector<T>(selector: (value: AppContextValue) => T): T {
  return useContextSelector(AppContext, selector)
}

export const AppContextProvider: FC<{ children: ReactNode }> = ({ children }) => {
  const { data: userProfileResponse, mutate: mutateUserProfile } = useSWR(
    '/account/profile',
    fetchUserProfile
  )
  const { data: currentWorkspaceResponse, mutate: mutateCurrentWorkspace } = useSWR(
    '/workspaces/current',
    fetchCurrentWorkspace
  )

  const [userProfile, setUserProfile] = useState<UserProfileResponse>({
    id: '',
    name: '',
    email: '',
    avatar: '',
  })
  const [currentWorkspace, setCurrentWorkspace] = useState<ICurrentWorkspace>({
    id: '',
    name: '',
    role: 'normal',
  })

  useEffect(() => {
    if (userProfileResponse) setUserProfile(userProfileResponse)
  }, [userProfileResponse])

  useEffect(() => {
    if (currentWorkspaceResponse) setCurrentWorkspace(currentWorkspaceResponse)
  }, [currentWorkspaceResponse])

  const isCurrentWorkspaceManager = ['owner', 'admin'].includes(currentWorkspace.role)
  const isCurrentWorkspaceOwner = currentWorkspace.role === 'owner'

  return (
    <AppContext.Provider
      value={{
        userProfile,
        currentWorkspace,
        isCurrentWorkspaceManager,
        isCurrentWorkspaceOwner,
        mutateUserProfile,
        mutateCurrentWorkspace,
      }}
    >
      {children}
    </AppContext.Provider>
  )
}

export const useAppContext = () => useContext(AppContext)
```

**å‚ç…§**: [web/context/app-context.tsx](web/context/app-context.tsx)

### 9.5.2 ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ã®Contextä½¿ç”¨

```tsx
// app/components/header/index.tsx
'use client'

import { useAppContext } from '@/context/app-context'

export default function Header() {
  const { userProfile, currentWorkspace } = useAppContext()

  return (
    <header className="flex h-16 items-center justify-between border-b px-6">
      <div className="text-lg font-semibold">
        {currentWorkspace.name}
      </div>
      <div className="flex items-center gap-4">
        <span>{userProfile.email}</span>
        <img
          src={userProfile.avatar}
          alt={userProfile.name}
          className="h-8 w-8 rounded-full"
        />
      </div>
    </header>
  )
}
```

## 9.6 ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

### 9.6.1 ã‚¨ãƒ©ãƒ¼ãƒã‚¦ãƒ³ãƒ€ãƒª

```tsx
// app/components/error-boundary/index.tsx
'use client'

import { Component, type ReactNode } from 'react'

interface Props {
  children: ReactNode
  fallback?: ReactNode
}

interface State {
  hasError: boolean
  error?: Error
}

export class ErrorBoundary extends Component<Props, State> {
  constructor(props: Props) {
    super(props)
    this.state = { hasError: false }
  }

  static getDerivedStateFromError(error: Error): State {
    return { hasError: true, error }
  }

  componentDidCatch(error: Error, errorInfo: any) {
    console.error('Error caught by boundary:', error, errorInfo)
  }

  render() {
    if (this.state.hasError) {
      return this.props.fallback || (
        <div className="flex h-full items-center justify-center">
          <div className="text-center">
            <h2 className="text-xl font-semibold">Something went wrong</h2>
            <p className="mt-2 text-gray-600">
              {this.state.error?.message}
            </p>
            <button
              onClick={() => this.setState({ hasError: false })}
              className="mt-4 btn-primary"
            >
              Try again
            </button>
          </div>
        </div>
      )
    }

    return this.props.children
  }
}
```

### 9.6.2 ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥

```tsx
// app/components/base/toast/index.tsx
'use client'

import { useEffect, useState } from 'react'
import { createPortal } from 'react-dom'

type ToastType = 'success' | 'error' | 'warning' | 'info'

interface ToastProps {
  type: ToastType
  message: string
  duration?: number
}

let toastQueue: ToastProps[] = []
let setToasts: (toasts: ToastProps[]) => void

export const Toast = {
  notify: (props: ToastProps) => {
    toastQueue = [...toastQueue, props]
    setToasts?.([...toastQueue])

    setTimeout(() => {
      toastQueue = toastQueue.slice(1)
      setToasts?.([...toastQueue])
    }, props.duration || 3000)
  },
}

export function ToastContainer() {
  const [toasts, _setToasts] = useState<ToastProps[]>([])

  useEffect(() => {
    setToasts = _setToasts
  }, [])

  if (typeof window === 'undefined') return null

  return createPortal(
    <div className="fixed right-4 top-4 z-50 space-y-2">
      {toasts.map((toast, index) => (
        <div
          key={index}
          className={`rounded-lg p-4 shadow-lg ${
            toast.type === 'error' ? 'bg-red-500' :
            toast.type === 'success' ? 'bg-green-500' :
            toast.type === 'warning' ? 'bg-yellow-500' :
            'bg-blue-500'
          } text-white`}
        >
          {toast.message}
        </div>
      ))}
    </div>,
    document.body
  )
}
```

## 9.7 ã¾ã¨ã‚

ã“ã®ç« ã§ã¯ã€çŠ¶æ…‹ç®¡ç†ã¨APIçµ±åˆã‚’å®Ÿè£…ã—ã¾ã—ãŸã€‚

âœ… **TanStack Query**: ã‚µãƒ¼ãƒãƒ¼ã‚¹ãƒ†ãƒ¼ãƒˆç®¡ç†ã€ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°
âœ… **APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ**: RESTful APIã€ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°(SSE)
âœ… **React Context**: ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ãƒ†ãƒ¼ãƒˆç®¡ç†
âœ… **ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯**: å†åˆ©ç”¨å¯èƒ½ãªãƒ­ã‚¸ãƒƒã‚¯
âœ… **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**: ã‚¨ãƒ©ãƒ¼ãƒã‚¦ãƒ³ãƒ€ãƒªã€ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥

### å‚ç…§ãƒ•ã‚¡ã‚¤ãƒ«

- [web/context/query-client.tsx](web/context/query-client.tsx)
- [web/service/base.ts](web/service/base.ts)
- [web/service/use-apps.ts](web/service/use-apps.ts)
- [web/context/app-context.tsx](web/context/app-context.tsx)

æ¬¡ã®ç¬¬10ç« ã§ã¯ã€UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¨å¤šè¨€èªå¯¾å¿œ(i18n)ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

---

# ç¬¬10ç« : UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¨i18n

ã“ã®ç« ã§ã¯ã€å†åˆ©ç”¨å¯èƒ½ãªUIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’æ§‹ç¯‰ã—ã€react-i18nextã‚’ä½¿ã£ãŸå¤šè¨€èªå¯¾å¿œã‚’å®Ÿè£…ã—ã¾ã™ã€‚

## 10.1 ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆè¨­è¨ˆåŸå‰‡

Difyã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆè¨­è¨ˆã¯ä»¥ä¸‹ã®åŸå‰‡ã«å¾“ã£ã¦ã„ã¾ã™:

1. **Atomic Design**: Atoms â†’ Molecules â†’ Organisms â†’ Templates â†’ Pages
2. **Composition over Inheritance**: ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®åˆæˆã‚’å„ªå…ˆ
3. **Accessibility**: ARIAå±æ€§ã€ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
4. **Dark Mode**: next-themesã«ã‚ˆã‚‹ãƒ†ãƒ¼ãƒå¯¾å¿œ
5. **Type Safety**: TypeScriptã«ã‚ˆã‚‹å³æ ¼ãªå‹å®šç¾©

```
app/components/
â”œâ”€â”€ base/              # Atoms (åŸºæœ¬ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ)
â”‚   â”œâ”€â”€ button/
â”‚   â”œâ”€â”€ input/
â”‚   â”œâ”€â”€ modal/
â”‚   â”œâ”€â”€ select/
â”‚   â””â”€â”€ tooltip/
â”œâ”€â”€ header/            # Organisms
â”œâ”€â”€ sidebar/           # Organisms
â””â”€â”€ app-list/          # Templates
```

## 10.2 åŸºæœ¬ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ(Atoms)

### 10.2.1 Button ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

```tsx
// app/components/base/button/index.tsx
import type { FC, ButtonHTMLAttributes } from 'react'
import cn from '@/utils/classnames'

type ButtonVariant = 'primary' | 'secondary' | 'ghost' | 'danger'
type ButtonSize = 'xs' | 'sm' | 'md' | 'lg'

interface ButtonProps extends ButtonHTMLAttributes<HTMLButtonElement> {
  variant?: ButtonVariant
  size?: ButtonSize
  loading?: boolean
  icon?: React.ReactNode
  children?: React.ReactNode
}

export const Button: FC<ButtonProps> = ({
  variant = 'primary',
  size = 'md',
  loading = false,
  icon,
  children,
  className,
  disabled,
  ...props
}) => {
  return (
    <button
      className={cn(
        'inline-flex items-center justify-center gap-2',
        'rounded-lg font-medium transition-colors',
        'focus:outline-none focus:ring-2 focus:ring-offset-2',
        'disabled:cursor-not-allowed disabled:opacity-50',
        {
          // Variants
          'bg-primary-600 text-white hover:bg-primary-700 focus:ring-primary-500':
            variant === 'primary',
          'bg-white text-gray-900 border border-gray-300 hover:bg-gray-50 focus:ring-gray-500':
            variant === 'secondary',
          'bg-transparent text-gray-700 hover:bg-gray-100 focus:ring-gray-500':
            variant === 'ghost',
          'bg-red-600 text-white hover:bg-red-700 focus:ring-red-500':
            variant === 'danger',
        },
        {
          // Sizes
          'px-2 py-1 text-xs': size === 'xs',
          'px-3 py-1.5 text-sm': size === 'sm',
          'px-4 py-2 text-base': size === 'md',
          'px-6 py-3 text-lg': size === 'lg',
        },
        className
      )}
      disabled={disabled || loading}
      {...props}
    >
      {loading && (
        <svg
          className="h-4 w-4 animate-spin"
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
        >
          <circle
            className="opacity-25"
            cx="12"
            cy="12"
            r="10"
            stroke="currentColor"
            strokeWidth="4"
          />
          <path
            className="opacity-75"
            fill="currentColor"
            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
          />
        </svg>
      )}
      {icon && !loading && icon}
      {children}
    </button>
  )
}
```

### 10.2.2 Input ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

```tsx
// app/components/base/input/index.tsx
import type { FC, InputHTMLAttributes } from 'react'
import cn from '@/utils/classnames'

interface InputProps extends InputHTMLAttributes<HTMLInputElement> {
  label?: string
  error?: string
  hint?: string
  leftIcon?: React.ReactNode
  rightIcon?: React.ReactNode
}

export const Input: FC<InputProps> = ({
  label,
  error,
  hint,
  leftIcon,
  rightIcon,
  className,
  ...props
}) => {
  return (
    <div className="w-full">
      {label && (
        <label className="mb-1 block text-sm font-medium text-gray-700 dark:text-gray-300">
          {label}
        </label>
      )}
      <div className="relative">
        {leftIcon && (
          <div className="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
            {leftIcon}
          </div>
        )}
        <input
          className={cn(
            'block w-full rounded-lg border px-4 py-2',
            'bg-white dark:bg-gray-800',
            'text-gray-900 dark:text-gray-100',
            'placeholder-gray-400 dark:placeholder-gray-500',
            'focus:outline-none focus:ring-2 focus:ring-primary-500',
            {
              'border-gray-300 dark:border-gray-600': !error,
              'border-red-500 focus:ring-red-500': error,
              'pl-10': leftIcon,
              'pr-10': rightIcon,
            },
            className
          )}
          {...props}
        />
        {rightIcon && (
          <div className="absolute inset-y-0 right-0 flex items-center pr-3">
            {rightIcon}
          </div>
        )}
      </div>
      {error && <p className="mt-1 text-sm text-red-500">{error}</p>}
      {hint && !error && <p className="mt-1 text-sm text-gray-500">{hint}</p>}
    </div>
  )
}
```

### 10.2.3 Modal ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

```tsx
// app/components/base/modal/index.tsx
'use client'

import type { FC, ReactNode } from 'react'
import { useEffect, useRef } from 'react'
import { createPortal } from 'react-dom'
import cn from '@/utils/classnames'

interface ModalProps {
  isOpen: boolean
  onClose: () => void
  title?: string
  children: ReactNode
  footer?: ReactNode
  size?: 'sm' | 'md' | 'lg' | 'xl'
  closable?: boolean
}

export const Modal: FC<ModalProps> = ({
  isOpen,
  onClose,
  title,
  children,
  footer,
  size = 'md',
  closable = true,
}) => {
  const overlayRef = useRef<HTMLDivElement>(null)

  useEffect(() => {
    const handleEscape = (e: KeyboardEvent) => {
      if (e.key === 'Escape' && closable) onClose()
    }
    if (isOpen) {
      document.addEventListener('keydown', handleEscape)
      document.body.style.overflow = 'hidden'
    }
    return () => {
      document.removeEventListener('keydown', handleEscape)
      document.body.style.overflow = 'unset'
    }
  }, [isOpen, closable, onClose])

  if (!isOpen) return null
  if (typeof window === 'undefined') return null

  return createPortal(
    <div
      ref={overlayRef}
      className="fixed inset-0 z-50 flex items-center justify-center bg-black/50"
      onClick={(e) => {
        if (e.target === overlayRef.current && closable) onClose()
      }}
    >
      <div
        className={cn(
          'relative max-h-[90vh] w-full overflow-auto',
          'rounded-lg bg-white dark:bg-gray-800 shadow-xl',
          {
            'max-w-sm': size === 'sm',
            'max-w-md': size === 'md',
            'max-w-2xl': size === 'lg',
            'max-w-4xl': size === 'xl',
          }
        )}
      >
        {/* Header */}
        {(title || closable) && (
          <div className="flex items-center justify-between border-b px-6 py-4 dark:border-gray-700">
            {title && (
              <h3 className="text-lg font-semibold text-gray-900 dark:text-white">
                {title}
              </h3>
            )}
            {closable && (
              <button
                onClick={onClose}
                className="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300"
              >
                <svg className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
            )}
          </div>
        )}

        {/* Body */}
        <div className="p-6">{children}</div>

        {/* Footer */}
        {footer && (
          <div className="border-t px-6 py-4 dark:border-gray-700">
            {footer}
          </div>
        )}
      </div>
    </div>,
    document.body
  )
}
```

### 10.2.4 Select ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

```tsx
// app/components/base/select/index.tsx
'use client'

import type { FC } from 'react'
import { useState, useRef, useEffect } from 'react'
import cn from '@/utils/classnames'

interface Option {
  value: string
  label: string
}

interface SelectProps {
  options: Option[]
  value?: string
  onChange: (value: string) => void
  placeholder?: string
  disabled?: boolean
  error?: string
}

export const Select: FC<SelectProps> = ({
  options,
  value,
  onChange,
  placeholder = 'Select an option',
  disabled = false,
  error,
}) => {
  const [isOpen, setIsOpen] = useState(false)
  const selectRef = useRef<HTMLDivElement>(null)

  const selectedOption = options.find(opt => opt.value === value)

  useEffect(() => {
    const handleClickOutside = (e: MouseEvent) => {
      if (selectRef.current && !selectRef.current.contains(e.target as Node)) {
        setIsOpen(false)
      }
    }
    document.addEventListener('mousedown', handleClickOutside)
    return () => document.removeEventListener('mousedown', handleClickOutside)
  }, [])

  return (
    <div ref={selectRef} className="relative w-full">
      <button
        type="button"
        onClick={() => !disabled && setIsOpen(!isOpen)}
        className={cn(
          'flex w-full items-center justify-between rounded-lg border px-4 py-2',
          'bg-white dark:bg-gray-800',
          'text-gray-900 dark:text-gray-100',
          'focus:outline-none focus:ring-2',
          {
            'border-gray-300 dark:border-gray-600 focus:ring-primary-500': !error,
            'border-red-500 focus:ring-red-500': error,
            'cursor-not-allowed opacity-50': disabled,
          }
        )}
        disabled={disabled}
      >
        <span className={!selectedOption ? 'text-gray-400' : ''}>
          {selectedOption?.label || placeholder}
        </span>
        <svg
          className={cn('h-5 w-5 transition-transform', { 'rotate-180': isOpen })}
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
        >
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
        </svg>
      </button>

      {isOpen && (
        <div className="absolute z-10 mt-1 w-full overflow-auto rounded-lg border border-gray-300 bg-white shadow-lg dark:border-gray-600 dark:bg-gray-800">
          {options.map(option => (
            <button
              key={option.value}
              type="button"
              onClick={() => {
                onChange(option.value)
                setIsOpen(false)
              }}
              className={cn(
                'w-full px-4 py-2 text-left hover:bg-gray-100 dark:hover:bg-gray-700',
                {
                  'bg-primary-50 dark:bg-primary-900': value === option.value,
                }
              )}
            >
              {option.label}
            </button>
          ))}
        </div>
      )}

      {error && <p className="mt-1 text-sm text-red-500">{error}</p>}
    </div>
  )
}
```

## 10.3 ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰å¯¾å¿œ

### 10.3.1 ThemeProviderè¨­å®š

```tsx
// app/layout.tsx (æŠœç²‹)
import { ThemeProvider } from 'next-themes'

export default function RootLayout({ children }: { children: React.ReactNode }) {
  return (
    <html suppressHydrationWarning>
      <body>
        <ThemeProvider
          attribute="data-theme"
          defaultTheme="system"
          enableSystem
          disableTransitionOnChange
          enableColorScheme={false}
        >
          {children}
        </ThemeProvider>
      </body>
    </html>
  )
}
```

### 10.3.2 ThemeSwitcher ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

```tsx
// app/components/theme-switcher/index.tsx
'use client'

import { useTheme } from 'next-themes'
import { useEffect, useState } from 'react'

export default function ThemeSwitcher() {
  const { theme, setTheme } = useTheme()
  const [mounted, setMounted] = useState(false)

  useEffect(() => setMounted(true), [])

  if (!mounted) return null

  return (
    <button
      onClick={() => setTheme(theme === 'dark' ? 'light' : 'dark')}
      className="rounded-lg p-2 hover:bg-gray-100 dark:hover:bg-gray-800"
      aria-label="Toggle theme"
    >
      {theme === 'dark' ? (
        <svg className="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
          <path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" />
        </svg>
      ) : (
        <svg className="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
          <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z" />
        </svg>
      )}
    </button>
  )
}
```

## 10.4 å¤šè¨€èªå¯¾å¿œ(i18n)

### 10.4.1 i18nextè¨­å®š

```typescript
// i18n-config/i18next-config.ts
import i18n from 'i18next'
import { initReactI18next } from 'react-i18next'
import resourcesToBackend from 'i18next-resources-to-backend'

i18n
  .use(initReactI18next)
  .use(
    resourcesToBackend(
      (language: string, namespace: string) =>
        import(`../i18n/${language}/${namespace}.ts`)
    )
  )
  .init({
    fallbackLng: 'en-US',
    lng: 'en-US',
    interpolation: {
      escapeValue: false,
    },
    react: {
      useSuspense: false,
    },
  })

export default i18n
```

**å‚ç…§**: [web/i18n-config/i18next-config.ts](web/i18n-config/i18next-config.ts)

### 10.4.2 è¨€èªãƒªã‚½ãƒ¼ã‚¹

```typescript
// i18n/en-US/common.ts
const translation = {
  common: {
    welcome: 'Welcome to Dify',
    loading: 'Loading...',
    error: 'Error',
    success: 'Success',
    cancel: 'Cancel',
    confirm: 'Confirm',
    save: 'Save',
    delete: 'Delete',
    edit: 'Edit',
    create: 'Create',
  },
  operation: {
    create: 'Create',
    edit: 'Edit',
    delete: 'Delete',
    deleteConfirm: 'Are you sure you want to delete this item?',
  },
}

export default translation
```

```typescript
// i18n/ja-JP/common.ts
const translation = {
  common: {
    welcome: 'Difyã¸ã‚ˆã†ã“ã',
    loading: 'èª­ã¿è¾¼ã¿ä¸­...',
    error: 'ã‚¨ãƒ©ãƒ¼',
    success: 'æˆåŠŸ',
    cancel: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«',
    confirm: 'ç¢ºèª',
    save: 'ä¿å­˜',
    delete: 'å‰Šé™¤',
    edit: 'ç·¨é›†',
    create: 'ä½œæˆ',
  },
  operation: {
    create: 'ä½œæˆ',
    edit: 'ç·¨é›†',
    delete: 'å‰Šé™¤',
    deleteConfirm: 'æœ¬å½“ã«ã“ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’å‰Šé™¤ã—ã¾ã™ã‹?',
  },
}

export default translation
```

### 10.4.3 useTranslationãƒ•ãƒƒã‚¯ã®ä½¿ç”¨

```tsx
// app/components/app-list/index.tsx
'use client'

import { useTranslation } from 'react-i18next'
import { Button } from '@/app/components/base/button'

export default function AppList() {
  const { t } = useTranslation()

  return (
    <div>
      <h1>{t('common.welcome')}</h1>
      <Button>{t('operation.create')}</Button>
    </div>
  )
}
```

### 10.4.4 è¨€èªåˆ‡ã‚Šæ›¿ãˆ

```tsx
// app/components/language-switcher/index.tsx
'use client'

import { useTranslation } from 'react-i18next'
import { Select } from '@/app/components/base/select'

const LANGUAGES = [
  { value: 'en-US', label: 'English' },
  { value: 'ja-JP', label: 'æ—¥æœ¬èª' },
  { value: 'zh-CN', label: 'ç®€ä½“ä¸­æ–‡' },
  { value: 'ko-KR', label: 'í•œêµ­ì–´' },
]

export default function LanguageSwitcher() {
  const { i18n } = useTranslation()

  return (
    <Select
      options={LANGUAGES}
      value={i18n.language}
      onChange={(lang) => i18n.changeLanguage(lang)}
      placeholder="Select language"
    />
  )
}
```

## 10.5 ãƒ•ã‚©ãƒ¼ãƒ ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ(react-hook-form)

### 10.5.1 react-hook-formã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

```tsx
// app/components/app-form/index.tsx
'use client'

import { useForm } from 'react-hook-form'
import { zodResolver } from '@hookform/resolvers/zod'
import { z } from 'zod'
import { Input } from '@/app/components/base/input'
import { Select } from '@/app/components/base/select'
import { Button } from '@/app/components/base/button'
import { useTranslation } from 'react-i18next'

const appSchema = z.object({
  name: z.string().min(1, 'Name is required'),
  description: z.string().optional(),
  mode: z.enum(['completion', 'chat', 'workflow']),
})

type AppFormData = z.infer<typeof appSchema>

interface AppFormProps {
  initialData?: Partial<AppFormData>
  onSubmit: (data: AppFormData) => void
  onCancel: () => void
}

export default function AppForm({ initialData, onSubmit, onCancel }: AppFormProps) {
  const { t } = useTranslation()
  const {
    register,
    handleSubmit,
    formState: { errors, isSubmitting },
    setValue,
    watch,
  } = useForm<AppFormData>({
    resolver: zodResolver(appSchema),
    defaultValues: initialData,
  })

  const mode = watch('mode')

  return (
    <form onSubmit={handleSubmit(onSubmit)} className="space-y-4">
      <Input
        label={t('app.name')}
        {...register('name')}
        error={errors.name?.message}
        placeholder="Enter app name"
      />

      <Input
        label={t('app.description')}
        {...register('description')}
        error={errors.description?.message}
        placeholder="Enter app description"
      />

      <Select
        options={[
          { value: 'completion', label: 'Completion' },
          { value: 'chat', label: 'Chat' },
          { value: 'workflow', label: 'Workflow' },
        ]}
        value={mode}
        onChange={(value) => setValue('mode', value as any)}
        placeholder="Select app mode"
      />

      <div className="flex justify-end gap-2">
        <Button type="button" variant="secondary" onClick={onCancel}>
          {t('common.cancel')}
        </Button>
        <Button type="submit" loading={isSubmitting}>
          {t('common.save')}
        </Button>
      </div>
    </form>
  )
}
```

## 10.6 ã¾ã¨ã‚

ã“ã®ç« ã§ã¯ã€UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¨å¤šè¨€èªå¯¾å¿œã‚’å®Ÿè£…ã—ã¾ã—ãŸã€‚

âœ… **åŸºæœ¬ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ**: Button, Input, Modal, Select
âœ… **ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰**: next-themesã«ã‚ˆã‚‹ãƒ†ãƒ¼ãƒåˆ‡ã‚Šæ›¿ãˆ
âœ… **å¤šè¨€èªå¯¾å¿œ**: react-i18nextã«ã‚ˆã‚‹å›½éš›åŒ–
âœ… **ãƒ•ã‚©ãƒ¼ãƒ **: react-hook-formã¨zodã«ã‚ˆã‚‹ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
âœ… **Accessibility**: ARIAå±æ€§ã€ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³

### å‚ç…§ãƒ•ã‚¡ã‚¤ãƒ«

- [web/app/components/base/](web/app/components/base/)
- [web/i18n-config/i18next-config.ts](web/i18n-config/i18next-config.ts)
- [web/i18n/en-US/](web/i18n/en-US/)

---

**ç¬¬8-10ç« (ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰åŸºç›¤)å®Œäº†!**

ç¬¬8ç« ã‹ã‚‰ç¬¬10ç« ã¾ã§ã€Difyã®ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰åŸºç›¤ã‚’å®Ÿè£…ã—ã¾ã—ãŸ:
- ç¬¬8ç« : ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰åŸºç›¤æ§‹ç¯‰(Next.js 15, TypeScript, Tailwind CSS)
- ç¬¬9ç« : çŠ¶æ…‹ç®¡ç†ã¨APIçµ±åˆ(Zustand, TanStack Query, ky)
- ç¬¬10ç« : UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¨i18n(react-i18next)

æ¬¡ã®ç¬¬11ç« ã§ã¯ã€ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚¨ãƒ‡ã‚£ã‚¿ã®å®Ÿè£…ã‚’é–‹å§‹ã—ã¾ã™ã€‚ReactFlowã‚’ä½¿ã£ãŸãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ã‚¨ãƒ‡ã‚£ã‚¿ã€ã‚«ã‚¹ã‚¿ãƒ ãƒãƒ¼ãƒ‰ã€ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚’å­¦ã³ã¾ã™ã€‚

---

# ç¬¬11ç« : ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚¨ãƒ‡ã‚£ã‚¿ã®å®Ÿè£…(ç°¡æ½”ç‰ˆ)

ã“ã®ç« ã§ã¯ã€ReactFlowã‚’ä½¿ã£ãŸãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚¨ãƒ‡ã‚£ã‚¿ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

## 11.1 ReactFlowã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

```tsx
// app/components/workflow/index.tsx
import ReactFlow, {
  Background,
  ReactFlowProvider,
  useNodesState,
  useEdgesState,
} from 'reactflow'
import 'reactflow/dist/style.css'

export default function WorkflowEditor() {
  const [nodes, setNodes, onNodesChange] = useNodesState([])
  const [edges, setEdges, onEdgesChange] = useEdgesState([])

  return (
    <ReactFlowProvider>
      <div className="h-full w-full">
        <ReactFlow
          nodes={nodes}
          edges={edges}
          onNodesChange={onNodesChange}
          onEdgesChange={onEdgesChange}
          fitView
        >
          <Background />
        </ReactFlow>
      </div>
    </ReactFlowProvider>
  )
}
```

## 11.2 ã‚«ã‚¹ã‚¿ãƒ ãƒãƒ¼ãƒ‰ã®å®Ÿè£…

```tsx
// app/components/workflow/nodes/llm/index.tsx
import type { FC } from 'react'
import type { NodeProps } from 'reactflow'
import { Handle, Position } from 'reactflow'

const LLMNode: FC<NodeProps> = ({ data }) => {
  return (
    <div className="rounded-lg border-2 border-blue-500 bg-white p-4 shadow-lg">
      <Handle type="target" position={Position.Top} />
      <div className="font-semibold">{data.title}</div>
      <div className="text-sm text-gray-600">{data.desc}</div>
      <Handle type="source" position={Position.Bottom} />
    </div>
  )
}

export default LLMNode
```

**å‚ç…§**: [web/app/components/workflow/](web/app/components/workflow/)

---

# ç¬¬12ç« : ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œã‚¨ãƒ³ã‚¸ãƒ³(ç°¡æ½”ç‰ˆ)

ã“ã®ç« ã§ã¯ã€ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œã‚¨ãƒ³ã‚¸ãƒ³ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

## 12.1 ã‚°ãƒ©ãƒ•ã‚¨ãƒ³ã‚¸ãƒ³ã®æ¦‚è¦

```python
# api/core/workflow/graph_engine/manager.py
from core.workflow.graph.graph import Graph
from core.workflow.entities.workflow_execution import WorkflowExecution

class WorkflowEngineManager:
    def run_workflow(
        self,
        workflow: Workflow,
        user: Account,
        inputs: dict[str, Any],
    ) -> Generator[BaseGraphEvent, None, None]:
        # ã‚°ãƒ©ãƒ•ã‚’æ§‹ç¯‰
        graph = Graph.init(workflow_graph_config)

        # å®Ÿè¡Œ
        for event in graph.run(inputs):
            yield event
```

## 12.2 ãƒãƒ¼ãƒ‰å®Ÿè¡Œãƒ­ã‚¸ãƒƒã‚¯

```python
# api/core/workflow/nodes/llm/llm_node.py
from core.workflow.nodes.base.node import BaseNode

class LLMNode(BaseNode):
    def _run(self) -> NodeRunResult:
        # ãƒ¢ãƒ‡ãƒ«å®Ÿè¡Œ
        result = self.invoke_llm(
            model=self.node_data.model,
            prompt=self.node_data.prompt,
        )

        return NodeRunResult(
            status=WorkflowNodeExecutionStatus.SUCCEEDED,
            outputs={"text": result.text},
        )
```

**å‚ç…§**: [api/core/workflow/](api/core/workflow/)

---

# ç¬¬13ç« : RAGãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å®Ÿè£…(ç°¡æ½”ç‰ˆ)

ã“ã®ç« ã§ã¯ã€RAG(Retrieval-Augmented Generation)ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

## 13.1 ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå‡¦ç†

```python
# api/core/rag/datasource/vdb/weaviate/weaviate_vector.py
from core.rag.datasource.vdb.vector_base import BaseVector

class WeaviateVector(BaseVector):
    def add_texts(
        self,
        documents: list[Document],
        embeddings: Embeddings,
    ):
        # åŸ‹ã‚è¾¼ã¿ç”Ÿæˆ
        vectors = embeddings.embed_documents([doc.page_content for doc in documents])

        # Weaviateã«ä¿å­˜
        self.client.batch.add_data_objects(...)
```

## 13.2 æ¤œç´¢ã¨ãƒªãƒ©ãƒ³ã‚­ãƒ³ã‚°

```python
# api/core/rag/retrieval/retrieval.py
def retrieve(
    self,
    query: str,
    top_k: int = 5,
) -> list[Document]:
    # ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢
    results = self.vector_store.search(query, top_k=top_k * 2)

    # ãƒªãƒ©ãƒ³ã‚­ãƒ³ã‚°
    reranked = self.rerank_runner.run(query, results)

    return reranked[:top_k]
```

**å‚ç…§**: [api/core/rag/](api/core/rag/)

---

# ç¬¬14ç« : çŸ¥è­˜ãƒ™ãƒ¼ã‚¹ç®¡ç†UI(ç°¡æ½”ç‰ˆ)

ã“ã®ç« ã§ã¯ã€çŸ¥è­˜ãƒ™ãƒ¼ã‚¹ç®¡ç†UIã‚’å®Ÿè£…ã—ã¾ã™ã€‚

## 14.1 ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆä¸€è¦§

```tsx
// app/(commonLayout)/datasets/page.tsx
'use client'

import { useDatasets } from '@/service/use-datasets'

export default function DatasetsPage() {
  const { data: datasets } = useDatasets()

  return (
    <div className="grid grid-cols-3 gap-4">
      {datasets?.map(dataset => (
        <DatasetCard key={dataset.id} dataset={dataset} />
      ))}
    </div>
  )
}
```

**å‚ç…§**: [web/app/(commonLayout)/datasets/](web/app/(commonLayout)/datasets/)

---

# ç¬¬15ç« : ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆæ©Ÿèƒ½(ç°¡æ½”ç‰ˆ)

ã“ã®ç« ã§ã¯ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆæ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

## 15.1 ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒãƒ¼ãƒ‰

```python
# api/core/workflow/nodes/agent/agent_node.py
class AgentNode(BaseNode):
    def _run(self) -> NodeRunResult:
        # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—
        for iteration in range(self.max_iterations):
            # LLMå®Ÿè¡Œ
            response = self.invoke_llm(prompt)

            # ãƒ„ãƒ¼ãƒ«å‘¼ã³å‡ºã—åˆ¤å®š
            if response.tool_calls:
                tool_results = self.execute_tools(response.tool_calls)
                continue

            # å®Œäº†
            return NodeRunResult(outputs={"text": response.text})
```

**å‚ç…§**: [api/core/workflow/nodes/agent/](api/core/workflow/nodes/agent/)

---

# ç¬¬16ç« : ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚·ã‚¹ãƒ†ãƒ (ç°¡æ½”ç‰ˆ)

ã“ã®ç« ã§ã¯ã€ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚·ã‚¹ãƒ†ãƒ ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

## 16.1 ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆ

```yaml
# plugins/example-plugin/manifest.yaml
name: example-plugin
version: 1.0.0
type: tool
endpoints:
  - name: fetch_data
    method: POST
    path: /fetch
```

**å‚ç…§**: [api/core/plugin/](api/core/plugin/)

---

# ç¬¬17ç« : ãƒ†ã‚¹ãƒˆå®Ÿè£…(ç°¡æ½”ç‰ˆ)

ã“ã®ç« ã§ã¯ã€ãƒ†ã‚¹ãƒˆã‚’å®Ÿè£…ã—ã¾ã™ã€‚

## 17.1 ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆ

```python
# api/tests/unit/test_account_service.py
import pytest
from services.account_service import AccountService

def test_authenticate_success(session):
    service = AccountService()
    result = service.authenticate(
        email="test@example.com",
        password="password123",
    )
    assert result is not None
```

## 17.2 ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆ

```tsx
// web/app/components/button/__tests__/button.test.tsx
import { render, screen } from '@testing-library/react'
import { Button } from '../index'

describe('Button', () => {
  it('renders correctly', () => {
    render(<Button>Click me</Button>)
    expect(screen.getByText('Click me')).toBeInTheDocument()
  })
})
```

**ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ**:
```bash
# ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰
uv run --project api --dev dev/pytest/pytest_unit_tests.sh

# ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰
cd web && pnpm test
```

---

# ç¬¬18ç« : DockeråŒ–ã¨ãƒ‡ãƒ—ãƒ­ã‚¤(ç°¡æ½”ç‰ˆ)

ã“ã®ç« ã§ã¯ã€Dockerã‚³ãƒ³ãƒ†ãƒŠåŒ–ã¨ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’è¡Œã„ã¾ã™ã€‚

## 18.1 Dockerfile

```dockerfile
# docker/Dockerfile
FROM python:3.12-slim

WORKDIR /app/api

COPY api/requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY api/ .

CMD ["gunicorn", "-c", "gunicorn_config.py", "app:app"]
```

## 18.2 docker-compose.yml

```yaml
# docker/docker-compose.yaml
version: '3'
services:
  api:
    build: .
    ports:
      - "5001:5001"
    environment:
      - DATABASE_URL=postgresql://user:pass@db:5432/dify
    depends_on:
      - db
      - redis

  web:
    build: ../web
    ports:
      - "3000:3000"

  db:
    image: postgres:15
    environment:
      POSTGRES_DB: dify
      POSTGRES_USER: user
      POSTGRES_PASSWORD: pass

  redis:
    image: redis:7-alpine

  weaviate:
    image: semitechnologies/weaviate:latest
```

**ãƒ‡ãƒ—ãƒ­ã‚¤**:
```bash
docker-compose up -d
```

---

# ç¬¬19ç« : å‹•ä½œç¢ºèªã¨æœ€çµ‚èª¿æ•´(ç°¡æ½”ç‰ˆ)

ã“ã®ç« ã§ã¯ã€å…¨ä½“ã®å‹•ä½œç¢ºèªã‚’è¡Œã„ã¾ã™ã€‚

## 19.1 åˆæœŸãƒ‡ãƒ¼ã‚¿æŠ•å…¥

```bash
# ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
uv run --project api flask db upgrade

# åˆæœŸãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ
uv run --project api flask create-admin-user \
  --email admin@example.com \
  --password admin123
```

## 19.2 å‹•ä½œãƒ†ã‚¹ãƒˆ

1. **ãƒ­ã‚°ã‚¤ãƒ³**: http://localhost:3000/signin
2. **ã‚¢ãƒ—ãƒªä½œæˆ**: æ–°è¦ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚¢ãƒ—ãƒªã‚’ä½œæˆ
3. **ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ç·¨é›†**: ãƒãƒ¼ãƒ‰ã‚’é…ç½®ã—ã¦æ¥ç¶š
4. **å®Ÿè¡Œãƒ†ã‚¹ãƒˆ**: ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å®Ÿè¡Œã—ã¦çµæœã‚’ç¢ºèª
5. **çŸ¥è­˜ãƒ™ãƒ¼ã‚¹**: ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‚’ä½œæˆã—ã¦ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰

## 19.3 ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

| å•é¡Œ | è§£æ±ºç­– |
|------|--------|
| ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã‚¨ãƒ©ãƒ¼ | `DATABASE_URL`ç’°å¢ƒå¤‰æ•°ã‚’ç¢ºèª |
| Redisæ¥ç¶šã‚¨ãƒ©ãƒ¼ | Redisã‚³ãƒ³ãƒ†ãƒŠãŒèµ·å‹•ã—ã¦ã„ã‚‹ã‹ç¢ºèª |
| ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ“ãƒ«ãƒ‰ã‚¨ãƒ©ãƒ¼ | `pnpm install`ã‚’å†å®Ÿè¡Œ |
| Celeryãƒ¯ãƒ¼ã‚«ãƒ¼èµ·å‹•å¤±æ•— | Redisãƒ–ãƒ­ãƒ¼ã‚«ãƒ¼ãŒèµ·å‹•ã—ã¦ã„ã‚‹ã‹ç¢ºèª |

---

# ä»˜éŒ²

## A. ã‚ˆãã‚ã‚‹è³ªå•(FAQ)

**Q: Difyã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®ç‰¹å¾´ã¯?**
A: DDDã€Clean Architectureã€ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆã€LLMæŠ½è±¡åŒ–ãŒä¸»ãªç‰¹å¾´ã§ã™ã€‚

**Q: ã©ã®LLMãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã«å¯¾å¿œã—ã¦ã„ã¾ã™ã‹?**
A: OpenAIã€Anthropicã€Googleã€Azure OpenAIã€Hugging Faceã€ãƒ­ãƒ¼ã‚«ãƒ«ãƒ¢ãƒ‡ãƒ«ãªã©å¤šæ•°ã€‚

**Q: ã‚«ã‚¹ã‚¿ãƒ ãƒãƒ¼ãƒ‰ã‚’è¿½åŠ ã§ãã¾ã™ã‹?**
A: ã¯ã„ã€ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚·ã‚¹ãƒ†ãƒ ã‚’ä½¿ã£ã¦ç‹¬è‡ªã®ãƒãƒ¼ãƒ‰ã‚’è¿½åŠ ã§ãã¾ã™ã€‚

**Q: å•†ç”¨åˆ©ç”¨ã¯å¯èƒ½ã§ã™ã‹?**
A: ã¯ã„ã€Apache 2.0ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã§å•†ç”¨åˆ©ç”¨å¯èƒ½ã§ã™ã€‚

## B. ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚¬ã‚¤ãƒ‰

### ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®å•é¡Œ

1. **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼**
   ```bash
   # ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å±¥æ­´ã‚’ãƒªã‚»ãƒƒãƒˆ
   uv run --project api flask db stamp head
   uv run --project api flask db upgrade
   ```

2. **Celeryãƒ¯ãƒ¼ã‚«ãƒ¼ãŒå‹•ä½œã—ãªã„**
   ```bash
   # Redisã®æ¥ç¶šç¢ºèª
   redis-cli ping

   # ãƒ¯ãƒ¼ã‚«ãƒ¼ãƒ­ã‚°ã‚’ç¢ºèª
   uv run --project api celery -A extensions.ext_celery.celery_app worker --loglevel=debug
   ```

### ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®å•é¡Œ

1. **ãƒ“ãƒ«ãƒ‰ã‚¨ãƒ©ãƒ¼**
   ```bash
   # node_modulesã‚’ã‚¯ãƒªãƒ¼ãƒ³
   rm -rf web/node_modules web/.next
   cd web && pnpm install
   ```

2. **APIæ¥ç¶šã‚¨ãƒ©ãƒ¼**
   - `web/.env.local`ã®`NEXT_PUBLIC_API_PREFIX`ã‚’ç¢ºèª
   - CORSã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯`api/configs/middleware/cors.py`ã‚’ç¢ºèª

## C. å‚è€ƒãƒªã‚½ãƒ¼ã‚¹

### å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
- **Difyå…¬å¼**: https://docs.dify.ai/
- **GitHub**: https://github.com/langgenius/dify
- **Discord**: https://discord.gg/FngNHpbcY7

### æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯
- **Flask**: https://flask.palletsprojects.com/
- **SQLAlchemy**: https://docs.sqlalchemy.org/
- **Next.js**: https://nextjs.org/docs
- **React Flow**: https://reactflow.dev/
- **TanStack Query**: https://tanstack.com/query/latest
- **Zustand**: https://zustand-demo.pmnd.rs/

### ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£
- **Clean Architecture**: https://blog.cleancoder.com/uncle-bob/2012/08/13/the-clean-architecture.html
- **Domain-Driven Design**: https://martinfowler.com/bliki/DomainDrivenDesign.html

## D. ç”¨èªé›†

| ç”¨èª | èª¬æ˜ |
|------|------|
| **DDD** | Domain-Driven Designã€‚ãƒ‰ãƒ¡ã‚¤ãƒ³é§†å‹•è¨­è¨ˆã€‚ |
| **Clean Architecture** | ãƒ¬ã‚¤ãƒ¤ãƒ¼åŒ–ã•ã‚ŒãŸã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ãƒ‘ã‚¿ãƒ¼ãƒ³ã€‚ |
| **RAG** | Retrieval-Augmented Generationã€‚æ¤œç´¢æ‹¡å¼µç”Ÿæˆã€‚ |
| **LLM** | Large Language Modelã€‚å¤§è¦æ¨¡è¨€èªãƒ¢ãƒ‡ãƒ«ã€‚ |
| **Embedding** | ãƒ†ã‚­ã‚¹ãƒˆã‚’ãƒ™ã‚¯ãƒˆãƒ«è¡¨ç¾ã«å¤‰æ›ã™ã‚‹ã“ã¨ã€‚ |
| **Vector Store** | ãƒ™ã‚¯ãƒˆãƒ«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã€‚é¡ä¼¼æ¤œç´¢ã«ä½¿ç”¨ã€‚ |
| **Multi-tenant** | è¤‡æ•°ã®ãƒ†ãƒŠãƒ³ãƒˆ(çµ„ç¹”)ã‚’åˆ†é›¢ã—ã¦ç®¡ç†ã™ã‚‹ä»•çµ„ã¿ã€‚ |
| **RBAC** | Role-Based Access Controlã€‚ãƒ­ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã€‚ |
| **JWT** | JSON Web Tokenã€‚èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³å½¢å¼ã€‚ |
| **SSE** | Server-Sent Eventsã€‚ã‚µãƒ¼ãƒãƒ¼ãƒ—ãƒƒã‚·ãƒ¥å‹é€šä¿¡ã€‚ |

---

# ãŠã‚ã‚Šã«

ã“ã®ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã§ã¯ã€Difyã®å®Œå…¨ãªå®Ÿè£…ã‚’å­¦ã³ã¾ã—ãŸã€‚

## é”æˆã—ãŸã“ã¨

âœ… **ç¬¬1-2ç« **: Difyæ¦‚è¦ã¨ç’°å¢ƒæ§‹ç¯‰
âœ… **ç¬¬3-7ç« **: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰åŸºç›¤(DBã€ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã€èªè¨¼ã€LLMã€Celery)
âœ… **ç¬¬8-10ç« **: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰åŸºç›¤(Next.jsã€çŠ¶æ…‹ç®¡ç†ã€UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ)
âœ… **ç¬¬11-16ç« **: ã‚³ã‚¢æ©Ÿèƒ½(ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã€RAGã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã€ãƒ—ãƒ©ã‚°ã‚¤ãƒ³)
âœ… **ç¬¬17-19ç« **: ãƒ†ã‚¹ãƒˆã€ãƒ‡ãƒ—ãƒ­ã‚¤ã€å‹•ä½œç¢ºèª

## æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

1. **ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º**: ç‹¬è‡ªã®ãƒãƒ¼ãƒ‰ã‚„ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’è¿½åŠ 
2. **æœ€é©åŒ–**: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°
3. **æ‹¡å¼µ**: æ–°ã—ã„LLMãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®è¿½åŠ 
4. **æœ¬ç•ªé‹ç”¨**: ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ã€ç›£è¦–ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–

## ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã¸ã®å‚åŠ 

- **GitHub Issues**: ãƒã‚°å ±å‘Šã‚„æ©Ÿèƒ½ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
- **Pull Requests**: ã‚³ãƒ¼ãƒ‰è²¢çŒ®
- **Discord**: ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã¨ã®äº¤æµ

---

**Difyã‚’ä½¿ã£ã¦ç´ æ™´ã‚‰ã—ã„AIã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ§‹ç¯‰ã—ã¾ã—ã‚‡ã†!**

---

**ç·è¡Œæ•°**: ç´„10,500è¡Œ
**å®Œæˆæ—¥**: 2025-11-28

ã“ã®ãƒãƒ³ã‚ºã‚ªãƒ³ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ãŒã€Difyã®å®Ÿè£…ã‚’æ·±ãç†è§£ã—ã€ç‹¬è‡ªã®LLMã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ§‹ç¯‰ã™ã‚‹åŠ©ã‘ã¨ãªã‚‹ã“ã¨ã‚’é¡˜ã£ã¦ã„ã¾ã™ã€‚
